# Story 10.4: Format Auto-Detection Extension

## Status: Draft

## Story

**As a** user pasting Markdown content,
**I want** the application to automatically detect the format,
**So that** I don't have to manually select "Markdown" before rendering.

## Background

Story 8.4 implemented format auto-detection for JSON and XML. This story extends that detection logic to recognize Markdown content, enabling the unified paste→auto-detect→format workflow for all supported formats.

Markdown detection is more heuristic than JSON/XML since Markdown doesn't have a strict syntax marker. The detection uses common Markdown patterns (headings, code blocks, lists, frontmatter) to identify likely Markdown content.

## Acceptance Criteria

1. `detectFormat()` extended to detect Markdown content
2. Detection patterns include:
   - Headings: `#`, `##`, `###` at line start
   - Code blocks: ``` at line start
   - YAML frontmatter: `---` at document start
   - Lists: `- `, `* `, `1. ` at line start
   - Blockquotes: `> ` at line start
   - Links: `[text](url)` pattern
3. Detection works with leading whitespace (trimmed)
4. Detection works for patterns mid-document (not just start)
5. Format selector UI updated to include "Markdown" option
6. `formatDetected` signal emits "markdown" for detected content
7. Plain prose without Markdown patterns returns "unknown" (not false positive)
8. Detection is fast (< 1ms for any input size)
9. Manual override via toolbar still works

## Tasks / Subtasks

- [ ] Task 1: Extend detectFormat in JsonBridge (AC: 1, 2, 3, 4, 8)
  - [ ] Add Markdown detection logic after JSON/XML checks
  - [ ] Implement pattern matching for headings (#)
  - [ ] Implement pattern matching for code blocks (```)
  - [ ] Implement pattern matching for frontmatter (---)
  - [ ] Implement pattern matching for lists (-, *, 1.)
  - [ ] Implement pattern matching for blockquotes (>)
  - [ ] Implement pattern matching for links ([text](url))
  - [ ] Ensure detection completes < 1ms

- [ ] Task 2: Handle edge cases (AC: 7)
  - [ ] Plain text without Markdown patterns → "unknown"
  - [ ] Single # with no space → "unknown" (not heading)
  - [ ] Code that looks like Markdown but is JSON/XML → prioritize JSON/XML
  - [ ] Empty input → "unknown"

- [ ] Task 3: Update format selector UI (AC: 5, 9)
  - [ ] Add "Markdown" option to Toolbar.qml format selector
  - [ ] Update icon/indicator for Markdown format
  - [ ] Ensure manual selection overrides auto-detection
  - [ ] Style consistent with JSON/XML options

- [ ] Task 4: Update signal handling (AC: 6)
  - [ ] Verify `formatDetected("markdown")` signal emits
  - [ ] Update Main.qml to handle "markdown" format
  - [ ] Route Format button to renderMarkdownWithMermaid for markdown

- [ ] Task 5: Add tests (AC: 1-8)
  - [ ] Test: `# Heading` → "markdown"
  - [ ] Test: `## Subheading` → "markdown"
  - [ ] Test: Triple backtick code block → "markdown"
  - [ ] Test: `---` frontmatter → "markdown"
  - [ ] Test: `- list item` → "markdown"
  - [ ] Test: `> blockquote` → "markdown"
  - [ ] Test: `[link](url)` → "markdown"
  - [ ] Test: Plain "hello world" → "unknown"
  - [ ] Test: `{"json": true}` → "json" (not markdown)
  - [ ] Test: `<xml/>` → "xml" (not markdown)
  - [ ] Test: `#hashtag` (no space) → "unknown"
  - [ ] Test: Empty string → "unknown"
  - [ ] Test: Performance < 1ms

## Dev Notes

### Relevant Source Tree

```
qt/
├── jsonbridge.h        # detectFormat already exists
├── jsonbridge.cpp      # Extend detection logic
└── qml/
    ├── Main.qml        # Handle "markdown" format
    └── Toolbar.qml     # Add Markdown to format selector
```

### Extended Detection Algorithm

```cpp
QString JsonBridge::detectFormat(const QString &input)
{
    QString trimmed = input.trimmed();

    if (trimmed.isEmpty()) {
        return QStringLiteral("unknown");
    }

    QChar first = trimmed.at(0);

    // Priority 1: JSON (strict syntax)
    if (first == '{' || first == '[') {
        return QStringLiteral("json");
    }

    // Priority 2: XML (strict syntax)
    if (first == '<') {
        return QStringLiteral("xml");
    }

    // Priority 3: Markdown (heuristic patterns)
    if (isLikelyMarkdown(trimmed)) {
        return QStringLiteral("markdown");
    }

    return QStringLiteral("unknown");
}

bool JsonBridge::isLikelyMarkdown(const QString &input)
{
    // Check first line patterns
    static QRegularExpression headingRe(QStringLiteral("^#{1,6}\\s"));
    static QRegularExpression codeBlockRe(QStringLiteral("^```"));
    static QRegularExpression frontmatterRe(QStringLiteral("^---\\s*$"));
    static QRegularExpression listRe(QStringLiteral("^[-*]\\s|^\\d+\\.\\s"));
    static QRegularExpression blockquoteRe(QStringLiteral("^>\\s"));

    // Check first line
    int newlinePos = input.indexOf('\n');
    QString firstLine = newlinePos > 0 ? input.left(newlinePos) : input;

    if (headingRe.match(firstLine).hasMatch()) return true;
    if (codeBlockRe.match(firstLine).hasMatch()) return true;
    if (frontmatterRe.match(firstLine).hasMatch()) return true;
    if (listRe.match(firstLine).hasMatch()) return true;
    if (blockquoteRe.match(firstLine).hasMatch()) return true;

    // Check for patterns anywhere in document (limit search for performance)
    QString searchArea = input.left(2000);  // First 2KB only

    // Multi-line patterns
    static QRegularExpression anyHeadingRe(QStringLiteral("\\n#{1,6}\\s"));
    static QRegularExpression anyCodeBlockRe(QStringLiteral("\\n```"));
    static QRegularExpression linkRe(QStringLiteral("\\[.+?\\]\\(.+?\\)"));

    if (anyHeadingRe.match(searchArea).hasMatch()) return true;
    if (anyCodeBlockRe.match(searchArea).hasMatch()) return true;
    if (linkRe.match(searchArea).hasMatch()) return true;

    return false;
}
```

### Detection Priority

The detection order matters to avoid false positives:

| Priority | Format | Marker | Notes |
|----------|--------|--------|-------|
| 1 | JSON | `{` or `[` | Strict, unambiguous |
| 2 | XML | `<` | Strict, unambiguous |
| 3 | Markdown | Patterns | Heuristic, may have false negatives |
| 4 | Unknown | (none) | Default fallback |

### Format Selector UI Update

```qml
// In Toolbar.qml
ComboBox {
    id: formatSelector
    model: ["Auto", "JSON", "XML", "Markdown"]
    currentIndex: 0

    onCurrentIndexChanged: {
        if (currentIndex === 0) {
            // Auto-detect mode
            JsonBridge.detectFormat(inputPane.text);
        } else {
            // Manual override
            var formats = ["auto", "json", "xml", "markdown"];
            window.selectedFormat = formats[currentIndex];
        }
    }
}
```

### Format Routing in Main.qml

```qml
function handleFormat() {
    var format = window.selectedFormat || window.detectedFormat;
    var indent = toolbar.selectedIndent;

    switch (format) {
        case "xml":
            JsonBridge.formatXml(inputPane.text, indent);
            break;
        case "markdown":
            JsonBridge.requestRenderMarkdownWithMermaid(inputPane.text, Theme.darkMode);
            break;
        case "json":
        default:
            JsonBridge.formatJson(inputPane.text, indent);
            break;
    }
}
```

### Edge Cases

| Input | Expected | Reason |
|-------|----------|--------|
| `#hashtag` | unknown | No space after # |
| `# Heading` | markdown | Valid ATX heading |
| `##No space` | unknown | No space after ## |
| `{"#": 1}` | json | JSON takes priority |
| `<h1>Title</h1>` | xml | XML takes priority |
| `Hello world` | unknown | No Markdown patterns |
| `---\ntitle: foo\n---` | markdown | YAML frontmatter |
| `- [ ] Task` | markdown | Task list |

## Testing

### Test Location
- C++ tests: `qt/tests/tst_format_detection.cpp` (extend existing)
- QML integration: Manual testing

### Test Cases

| Input | Expected Format | Notes |
|-------|-----------------|-------|
| `# Hello` | markdown | Heading |
| `## Sub` | markdown | H2 |
| `### Deep` | markdown | H3 |
| ``` ```code``` ``` | markdown | Code block |
| `---\n` | markdown | Frontmatter |
| `- item` | markdown | Unordered list |
| `* item` | markdown | Unordered list |
| `1. item` | markdown | Ordered list |
| `> quote` | markdown | Blockquote |
| `[text](url)` | markdown | Link |
| `Hello` | unknown | Plain text |
| `#nospace` | unknown | Not a heading |
| `{"a":1}` | json | JSON priority |
| `<root/>` | xml | XML priority |
| `` | unknown | Empty |

### Running Tests

```bash
cd qt/build
cmake .. && make
./tests/tst_format_detection
```

## Definition of Done

- [ ] All acceptance criteria met
- [ ] All tasks completed
- [ ] detectFormat returns "markdown" for valid patterns
- [ ] No false positives on plain text
- [ ] JSON/XML still detected correctly (no regression)
- [ ] Format selector includes Markdown option
- [ ] Manual override works
- [ ] Performance < 1ms verified

## Dependencies

- **Depends on:** 10.3 (Bridge Layer), 8.4 (existing detection)
- **Blocks:** 10.5 (Preview Pane uses detected format)

## Estimate

2 points

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-28 | 1.0 | Story created from Epic 10.0 | Sarah (PO) |
