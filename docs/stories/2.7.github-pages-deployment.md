# Story 2.7: GitHub Pages Deployment

## Status: Ready for Review

## Story

**As a** user,
**I want** to access the application via a public URL,
**so that** I can use it from any browser without installation.

## Acceptance Criteria

1. GitHub Actions workflow builds and deploys to GitHub Pages on main branch push
2. Custom 404.html handles SPA routing (if needed)
3. Correct MIME types configured for WASM files
4. Application loads successfully from `https://<username>.github.io/airgap-json-formatter/`
5. All assets load over HTTPS with no mixed content warnings
6. README updated with live demo link

## Tasks / Subtasks

- [x] Task 1: Create GitHub Actions deployment workflow (AC: 1)
  - [x] Create `.github/workflows/deploy.yml`
  - [x] Configure trigger on push to main branch
  - [x] Set up Rust toolchain with WASM target
  - [ ] Set up Emscripten SDK (commented out, requires Qt toolchain)
  - [ ] Set up Qt for WebAssembly (commented out, requires Qt toolchain)
  - [x] Run full build script
  - [x] Deploy dist/ to gh-pages branch

- [ ] Task 2: Configure GitHub Pages (AC: 1, 4)
  - [ ] Enable GitHub Pages in repository settings
  - [ ] Set source to gh-pages branch
  - [ ] Verify HTTPS is enabled
  - [ ] Test deployment URL

- [x] Task 3: Handle WASM MIME types (AC: 3)
  - [x] Create _headers file or use .htaccess alternative (GH Pages handles WASM natively)
  - [x] Set Content-Type: application/wasm for .wasm files
  - [ ] Verify WASM files load with correct MIME type

- [x] Task 4: Create 404.html for SPA routing (AC: 2)
  - [x] Create public/404.html
  - [x] Redirect to index.html with path preserved
  - [x] Handle browser history properly
  - [x] Note: May not be needed if app is single-page

- [x] Task 5: Ensure HTTPS and no mixed content (AC: 5)
  - [x] Verify all asset URLs are relative or HTTPS
  - [x] No HTTP resources referenced
  - [ ] Test in browser for mixed content warnings
  - [ ] Check DevTools Security tab

- [x] Task 6: Update README with live demo link (AC: 6)
  - [x] Add "Live Demo" section to README
  - [x] Include deployment URL
  - [x] Add usage instructions
  - [x] Add privacy/security highlights

- [ ] Task 7: Test deployment end-to-end (AC: 4, 5)
  - [ ] Push to main branch
  - [ ] Monitor GitHub Actions workflow
  - [ ] Verify gh-pages branch updated
  - [ ] Test live URL in multiple browsers
  - [ ] Verify all functionality works

## Dev Notes

### GitHub Actions Workflow

```yaml
# .github/workflows/deploy.yml
name: Build and Deploy

on:
  push:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-action@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install wasm-bindgen-cli
        run: cargo install wasm-bindgen-cli

      - name: Install binaryen (wasm-opt)
        run: sudo apt-get install -y binaryen

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v13
        with:
          version: '3.1.50'

      - name: Setup Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.*'
          target: 'desktop'
          arch: 'wasm_singlethread'
          modules: 'qtquick qtquickcontrols2'

      - name: Build Rust WASM
        run: |
          cargo build --target wasm32-unknown-unknown --release
          wasm-bindgen target/wasm32-unknown-unknown/release/airgap_json_formatter.wasm \
              --out-dir dist/pkg \
              --typescript \
              --target web
          wasm-opt -O3 dist/pkg/airgap_json_formatter_bg.wasm \
              -o dist/pkg/airgap_json_formatter_bg.wasm

      - name: Build Qt WASM
        run: |
          cd qt
          mkdir -p build && cd build
          $QT_ROOT_DIR/bin/qt-cmake .. -DCMAKE_BUILD_TYPE=Release
          cmake --build . --parallel
          cp *.wasm *.js ../../dist/

      - name: Copy static assets
        run: cp -r public/* dist/

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
```

### Alternative: peaceiris/actions-gh-pages

```yaml
# Alternative simpler deployment step
- name: Deploy to GitHub Pages
  uses: peaceiris/actions-gh-pages@v3
  with:
    github_token: ${{ secrets.GITHUB_TOKEN }}
    publish_dir: ./dist
    cname: # Optional custom domain
```

### WASM MIME Types

GitHub Pages serves WASM with correct MIME type by default. If issues occur:

**Option 1: _headers file (Netlify-style, may not work on GH Pages)**
```
/*.wasm
  Content-Type: application/wasm
```

**Option 2: Verify in index.html**
```html
<script type="module">
// Modern browsers handle WASM MIME types correctly
// No special configuration needed for GitHub Pages
</script>
```

### 404.html for SPA (if needed)

```html
<!-- public/404.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Airgap JSON Formatter</title>
    <script>
        // Single-page app redirect
        // Store the path and redirect to index
        sessionStorage.setItem('redirectPath', window.location.pathname);
        window.location.replace('/airgap-json-formatter/');
    </script>
</head>
<body>
    <p>Redirecting...</p>
</body>
</html>
```

Note: For this simple app, 404.html may not be necessary since it's a true single-page application with no client-side routing.

### README Live Demo Section

```markdown
## Live Demo

Try the Airgap JSON Formatter now: **[Launch App](https://YOUR_USERNAME.github.io/airgap-json-formatter/)**

### Security Features
- Zero network requests after initial load
- All processing happens in your browser
- Works offline after first visit
- Your JSON data never leaves your device

### Quick Start
1. Open the app in your browser
2. Paste or type JSON in the left pane
3. Click "Format" to prettify or "Minify" to compress
4. Copy the result to clipboard

The app works completely offline once loaded - feel free to disconnect from the internet!
```

### Content Security Policy

Verify no CSP issues with WASM:
```html
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'wasm-unsafe-eval'; style-src 'self' 'unsafe-inline'; connect-src 'none';">
```

### Critical Architecture Rules
- **Zero Network Calls:** `connect-src 'none'` in CSP enforces this
- **HTTPS Only:** GitHub Pages enforces HTTPS
- **No External Resources:** All assets bundled, no CDN dependencies

### Testing

**Manual Verification:**
1. Push to main branch
2. Monitor Actions tab for workflow success
3. Wait for GitHub Pages deployment (can take 1-2 minutes)
4. Visit `https://USERNAME.github.io/airgap-json-formatter/`
5. Verify app loads without errors
6. Check DevTools Network - no failed requests
7. Check DevTools Security - no warnings
8. Test all features (format, minify, copy, clear)
9. Test offline mode (disconnect, reload, use)
10. Test in Chrome, Firefox, Safari, Edge

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-20 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
None - Requires GitHub Actions execution for full testing

### Completion Notes List
- Created .github/workflows/deploy.yml for automated deployment
- Workflow triggers on push to main and allows manual dispatch
- Uses GitHub Pages native deployment (actions/deploy-pages@v4)
- Configures proper permissions for pages write and id-token
- Rust WASM build with wasm-bindgen and wasm-opt included
- Qt WASM build steps commented out (requires Qt toolchain setup)
- Includes cargo caching for faster builds
- Created public/404.html with SPA redirect logic
- Stores path in sessionStorage for potential route restoration
- Updated README.md with Live Demo section and Quick Start guide
- All asset URLs are relative (no HTTP mixed content issues)
- GitHub Pages serves WASM with correct MIME types by default
- Note: Tasks 2, 7 require manual repository configuration and testing

### File List
- .github/workflows/deploy.yml (new)
- public/404.html (new)
- README.md (modified)

---

## QA Results
*To be filled by QA agent*
