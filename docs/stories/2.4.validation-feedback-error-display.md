# Story 2.4: Validation Feedback and Error Display

## Status: Ready for Review

## Story

**As a** user,
**I want** immediate feedback on JSON validity with clear error messages,
**so that** I can quickly identify and fix syntax errors.

## Acceptance Criteria

1. Status bar at bottom shows validation state: "Valid JSON" (green) or "Invalid JSON" (red)
2. On invalid JSON, error message displays with line and column number
3. Input pane scrolls to and highlights the error line
4. Validation runs automatically on input change (debounced 300ms)
5. Statistics display in status bar when JSON is valid (key count, depth, etc.)
6. Error tooltip appears when hovering over highlighted error line

## Tasks / Subtasks

- [x] Task 1: Create StatusBar.qml component (AC: 1, 2, 5)
  - [x] Create `qt/qml/StatusBar.qml`
  - [x] Add validation status indicator (icon + text)
  - [x] Add error message display area
  - [x] Add statistics display area
  - [x] Apply theme styling

- [x] Task 2: Implement validation status display (AC: 1)
  - [x] Add property `isValid: bool`
  - [x] Add property `errorMessage: string`
  - [x] Show green "Valid JSON" when isValid=true
  - [x] Show red "Invalid JSON" when isValid=false
  - [x] Include validation icon (checkmark/x)

- [x] Task 3: Implement error message display (AC: 2)
  - [x] Show error message with line:column format
  - [x] Format: "Error at line X, column Y: message"
  - [x] Make error text selectable/copyable
  - [x] Apply error styling (red text)

- [x] Task 4: Implement statistics display (AC: 5)
  - [x] Add properties for stats: objectCount, arrayCount, maxDepth, totalKeys
  - [x] Display stats when JSON is valid
  - [x] Format: "Objects: X | Arrays: Y | Keys: Z | Depth: N"
  - [x] Hide stats when JSON is invalid

- [x] Task 5: Add debounced validation to InputPane (AC: 4)
  - [x] Add Timer with 300ms interval
  - [x] Reset timer on text change
  - [x] Emit validation signal when timer fires
  - [x] Connect signal in Main.qml to call JsonBridge.validateJson

- [x] Task 6: Implement error line highlighting in InputPane (AC: 3)
  - [x] Add property `errorLine: int` (-1 for no error)
  - [x] Highlight the error line with background color
  - [x] Scroll to error line when error occurs
  - [x] Clear highlight when error is resolved

- [x] Task 7: Implement error tooltip (AC: 6)
  - [x] Add ToolTip component to InputPane
  - [x] Show tooltip on hover over error line
  - [x] Display full error message in tooltip
  - [x] Position tooltip near error location

- [x] Task 8: Integrate StatusBar into Main.qml (AC: 1)
  - [x] Add StatusBar below SplitView
  - [x] Connect validation results to StatusBar properties
  - [x] Update StatusBar on each validation

- [x] Task 9: Wire up validation flow (AC: 4)
  - [x] On input change → debounce timer starts
  - [x] On timer fire → call JsonBridge.validateJson
  - [x] Parse result → update StatusBar + InputPane error highlight
  - [x] Update on format/minify actions too

- [x] Task 10: Update CMakeLists.txt (AC: 1)
  - [x] Add StatusBar.qml to QML_FILES

## Dev Notes

### QML File Structure
```
qt/qml/
├── Main.qml          # Updated with StatusBar and validation
├── Theme.qml
├── Toolbar.qml
├── InputPane.qml     # Updated with error highlighting
├── OutputPane.qml
└── StatusBar.qml     # NEW: Validation status and stats
```

### StatusBar.qml

```qml
// qt/qml/StatusBar.qml
import QtQuick
import QtQuick.Controls
import QtQuick.Layouts

Rectangle {
    id: statusBar
    height: 30
    color: Theme.backgroundTertiary

    property bool isValid: true
    property string errorMessage: ""
    property int errorLine: 0
    property int errorColumn: 0

    // Statistics
    property int objectCount: 0
    property int arrayCount: 0
    property int totalKeys: 0
    property int maxDepth: 0

    RowLayout {
        anchors.fill: parent
        anchors.margins: 8
        spacing: 16

        // Validation Status
        Rectangle {
            width: validationRow.width + 16
            height: 22
            radius: 4
            color: statusBar.isValid ? "#2d4a2d" : "#4a2d2d"

            Row {
                id: validationRow
                anchors.centerIn: parent
                spacing: 6

                Text {
                    text: statusBar.isValid ? "✓" : "✗"
                    color: statusBar.isValid ? Theme.textSuccess : Theme.textError
                    font.pixelSize: 12
                }

                Text {
                    text: statusBar.isValid ? "Valid JSON" : "Invalid JSON"
                    color: statusBar.isValid ? Theme.textSuccess : Theme.textError
                    font.pixelSize: 12
                }
            }
        }

        // Error Message (shown when invalid)
        Text {
            visible: !statusBar.isValid && statusBar.errorMessage
            text: "Line " + statusBar.errorLine + ", Col " + statusBar.errorColumn + ": " + statusBar.errorMessage
            color: Theme.textError
            font.pixelSize: 12
            elide: Text.ElideRight
            Layout.fillWidth: true
        }

        // Statistics (shown when valid)
        Text {
            visible: statusBar.isValid
            text: "Objects: " + statusBar.objectCount +
                  " | Arrays: " + statusBar.arrayCount +
                  " | Keys: " + statusBar.totalKeys +
                  " | Depth: " + statusBar.maxDepth
            color: Theme.textSecondary
            font.pixelSize: 12
            Layout.fillWidth: true
        }
    }
}
```

### InputPane.qml Updates (Error Highlighting)

```qml
// InputPane.qml additions
Rectangle {
    id: inputPane

    property alias text: textArea.text
    property int errorLine: -1  // -1 = no error

    // Error line highlight
    Rectangle {
        id: errorHighlight
        visible: inputPane.errorLine > 0
        x: 0
        y: calculateLineY(inputPane.errorLine)
        width: parent.width
        height: textArea.font.pixelSize * 1.5
        color: "#4a2d2d"
        opacity: 0.5

        function calculateLineY(line) {
            // Calculate Y position based on line number
            return (line - 1) * textArea.font.pixelSize * 1.5;
        }
    }

    // Scroll to error line
    function scrollToError() {
        if (errorLine > 0) {
            // Calculate scroll position
            const lineHeight = textArea.font.pixelSize * 1.5;
            const targetY = (errorLine - 1) * lineHeight;
            scrollView.contentY = Math.max(0, targetY - scrollView.height / 2);
        }
    }

    onErrorLineChanged: {
        if (errorLine > 0) {
            scrollToError();
        }
    }
}
```

### Main.qml Validation Integration

```qml
// Main.qml additions

// Debounce timer for validation
Timer {
    id: validationTimer
    interval: 300
    onTriggered: validateInput()
}

function validateInput() {
    if (!inputPane.text) {
        statusBar.isValid = true;
        statusBar.errorMessage = "";
        inputPane.errorLine = -1;
        return;
    }

    const result = JsonBridge.validateJson(inputPane.text);

    statusBar.isValid = result.isValid;

    if (result.isValid) {
        statusBar.errorMessage = "";
        statusBar.objectCount = result.stats.objectCount;
        statusBar.arrayCount = result.stats.arrayCount;
        statusBar.totalKeys = result.stats.totalKeys;
        statusBar.maxDepth = result.stats.maxDepth;
        inputPane.errorLine = -1;
    } else {
        statusBar.errorMessage = result.error.message;
        statusBar.errorLine = result.error.line;
        statusBar.errorColumn = result.error.column;
        inputPane.errorLine = result.error.line;
    }
}

// Connect input changes to debounced validation
Connections {
    target: inputPane
    function onTextChanged() {
        validationTimer.restart();
    }
}
```

### Validation Result Structure
The bridge returns:
```javascript
{
    isValid: boolean,
    error: { message: string, line: number, column: number } | null,
    stats: {
        objectCount: number,
        arrayCount: number,
        stringCount: number,
        numberCount: number,
        booleanCount: number,
        nullCount: number,
        maxDepth: number,
        totalKeys: number
    }
}
```

### Critical Architecture Rules
- **Zero Network Calls:** Never use fetch, XMLHttpRequest, WebSocket
- **No Persistent Storage:** Never use localStorage, sessionStorage, IndexedDB
- **Debouncing:** Always debounce validation to avoid excessive WASM calls

### Testing

**Manual Verification:**
1. Enter valid JSON - verify green "Valid JSON" in status bar
2. Enter invalid JSON - verify red "Invalid JSON" in status bar
3. Check error message shows correct line and column
4. Verify error line is highlighted in input pane
5. Verify scroll jumps to error line
6. Hover over error line - verify tooltip appears
7. Fix JSON error - verify status changes to valid
8. Check statistics display for valid JSON
9. Test debouncing - type quickly, validation runs after pause

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-20 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
None - Qt WASM toolchain not available for runtime testing

### Completion Notes List
- Created StatusBar.qml with validation status badge (green/red with checkmark/x)
- StatusBar displays error message with line:column format when invalid
- StatusBar shows statistics (Objects, Arrays, Keys, Depth) when valid
- Added all stats properties: objectCount, arrayCount, stringCount, numberCount, booleanCount, nullCount, totalKeys, maxDepth
- Updated InputPane.qml with errorLine and errorMessage properties
- Added error line highlighting with red background (#4a2d2d at 60% opacity)
- Implemented scrollToError() function to center error line in viewport
- Added ToolTip for error message on hover over error line
- Added MouseArea for error line hover detection
- Main.qml updated with 300ms debounced validation timer
- validateInput() function calls JsonBridge.validateJson and updates UI
- Validation triggers on text change (debounced) and after format/minify actions
- Clear button resets all validation state
- Uses snake_case property names from Rust (object_count, array_count, etc.)

### File List
- qt/qml/StatusBar.qml (new)
- qt/qml/InputPane.qml (modified)
- qt/qml/Main.qml (modified)
- qt/CMakeLists.txt (modified)

---

## QA Results
*To be filled by QA agent*
