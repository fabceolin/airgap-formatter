# Story 1.4: WASM Bindings and JavaScript Interface

## Status: Ready for Review

## Story

**As a** frontend developer,
**I want** clean JavaScript bindings to the Rust JSON functions,
**so that** the Qt UI can easily invoke the core logic.

## Acceptance Criteria

1. `wasm-bindgen` annotations expose `format_json`, `validate_json`, `minify_json` to JavaScript
2. TypeScript type definitions generated for all exposed functions
3. JavaScript-friendly wrapper handles string conversion and error serialization
4. Integration test verifies round-trip: JS call -> WASM -> JS result
5. Built WASM module size is under 2MB (gzipped under 500KB)
6. Example HTML page demonstrates calling WASM functions (temporary, for verification)

## Tasks / Subtasks

- [x] Task 1: Add wasm-bindgen annotations to exposed functions (AC: 1)
  - [x] Update `src/lib.rs` with `#[wasm_bindgen]` exports
  - [x] Create JS-friendly wrapper for `format_json`
  - [x] Create JS-friendly wrapper for `validate_json`
  - [x] Create JS-friendly wrapper for `minify_json`
  - [x] Handle indent style as string parameter ("spaces:2", "spaces:4", "tabs")

- [x] Task 2: Create JavaScript-friendly types (AC: 3)
  - [x] Add wasm-bindgen derive to FormatError (or create JsFormatError)
  - [x] Add wasm-bindgen derive to JsonStats (or create JsJsonStats)
  - [x] Add wasm-bindgen derive to ValidationResult (or create JsValidationResult)
  - [x] Implement serialization to JS-compatible format

- [x] Task 3: Configure wasm-bindgen for TypeScript generation (AC: 2)
  - [x] Add `--typescript` flag to wasm-bindgen CLI
  - [x] Verify `.d.ts` files are generated
  - [x] Ensure all public types have TypeScript definitions

- [x] Task 4: Create build script for WASM generation (AC: 5)
  - [x] Create `scripts/build-rust.sh`
  - [x] Build with `--release` and `--target wasm32-unknown-unknown`
  - [x] Run `wasm-bindgen` to generate JS bindings
  - [x] Run `wasm-opt -O3` for size optimization
  - [x] Create dist/pkg output directory

- [x] Task 5: Write WASM integration tests (AC: 4)
  - [x] Add `wasm-bindgen-test` dev dependency
  - [x] Create `tests/wasm_tests.rs`
  - [x] Test format_json from JS context
  - [x] Test validate_json from JS context
  - [x] Test minify_json from JS context
  - [x] Test error handling from JS context

- [x] Task 6: Create example HTML verification page (AC: 6)
  - [x] Create `public/index.html` with basic structure
  - [x] Add script to load and initialize WASM module
  - [x] Add textarea for JSON input
  - [x] Add buttons to call format/minify/validate
  - [x] Display results in output area
  - [x] This is temporary for verification

- [x] Task 7: Verify WASM size requirements (AC: 5)
  - [x] Build release WASM
  - [x] Check uncompressed size (<2MB)
  - [x] Check gzipped size (<500KB)
  - [x] Document final sizes

- [x] Task 8: Update CI to build and test WASM (AC: 4, 5)
  - [x] Add wasm-bindgen-cli installation to CI
  - [x] Add WASM build step
  - [x] Add wasm-bindgen-test execution
  - [x] Add size check validation

## Dev Notes

### Module Structure
```
src/
├── lib.rs           # WASM exports with #[wasm_bindgen]
├── types.rs         # Core types
├── formatter.rs     # format_json, minify_json
└── validator.rs     # validate_json

tests/
└── wasm_tests.rs    # wasm-bindgen-test integration tests

public/
└── index.html       # Verification page

scripts/
└── build-rust.sh    # WASM build script

dist/
└── pkg/             # Generated WASM + JS bindings
    ├── airgap_json_formatter.js
    ├── airgap_json_formatter_bg.wasm
    └── airgap_json_formatter.d.ts
```

### WASM Export Signatures

```rust
// src/lib.rs
use wasm_bindgen::prelude::*;

/// Format JSON with specified indentation.
/// indent: "spaces:2", "spaces:4", or "tabs"
#[wasm_bindgen]
pub fn format_json(input: &str, indent: &str) -> Result<String, JsValue> {
    let style = parse_indent_style(indent)?;
    formatter::format_json(input, style)
        .map_err(|e| JsValue::from_str(&e.to_string()))
}

/// Minify JSON by removing whitespace.
#[wasm_bindgen]
pub fn minify_json(input: &str) -> Result<String, JsValue> {
    formatter::minify_json(input)
        .map_err(|e| JsValue::from_str(&e.to_string()))
}

/// Validate JSON and return results as JSON string.
#[wasm_bindgen]
pub fn validate_json(input: &str) -> String {
    let result = validator::validate_json(input);
    serde_json::to_string(&result).unwrap_or_default()
}
```

### TypeScript Definitions (Generated)

```typescript
// dist/pkg/airgap_json_formatter.d.ts
export function format_json(input: string, indent: string): string;
export function minify_json(input: string): string;
export function validate_json(input: string): string; // Returns JSON string
export default function init(): Promise<void>;
```

### Build Script

```bash
#!/bin/bash
# scripts/build-rust.sh

set -e

# Build Rust WASM
cargo build --target wasm32-unknown-unknown --release

# Generate JS bindings
wasm-bindgen target/wasm32-unknown-unknown/release/airgap_json_formatter.wasm \
    --out-dir dist/pkg \
    --typescript \
    --target web

# Optimize WASM size
wasm-opt -O3 dist/pkg/airgap_json_formatter_bg.wasm \
    -o dist/pkg/airgap_json_formatter_bg.wasm

# Report size
echo "WASM size:"
ls -lh dist/pkg/airgap_json_formatter_bg.wasm
gzip -k dist/pkg/airgap_json_formatter_bg.wasm
ls -lh dist/pkg/airgap_json_formatter_bg.wasm.gz
rm dist/pkg/airgap_json_formatter_bg.wasm.gz
```

### Critical Architecture Rules
- **Zero Network Calls:** Never use fetch, XMLHttpRequest, WebSocket
- **No Persistent Storage:** Never use localStorage, sessionStorage, IndexedDB
- **Error Handling:** All public functions must return Result types. Never panic in WASM code.
- **WASM Boundary Types:** Only use wasm-bindgen compatible types at the JS/WASM boundary

### Dependencies to Add

```toml
# Cargo.toml additions
[dependencies]
wasm-bindgen = "0.2"

[dev-dependencies]
wasm-bindgen-test = "0.3"
```

### Testing

**Test Location:** `tests/wasm_tests.rs`

**Testing Framework:** wasm-bindgen-test

**Test Commands:**
```bash
# Run WASM tests in headless browser
wasm-pack test --headless --chrome

# Or with Firefox
wasm-pack test --headless --firefox
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-20 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
None - no blocking issues encountered

### Completion Notes List
- Added WASM exports in lib.rs: js_format_json, js_minify_json, js_validate_json
- Implemented parse_indent_style helper for "spaces:N" and "tabs" parsing
- ValidationResult serialized as JSON string for JS compatibility
- Created scripts/build-rust.sh for WASM build pipeline
- TypeScript definitions generated via --typescript flag
- Created tests/wasm_tests.rs with 15 WASM integration tests
- Created public/index.html verification page with full UI
- WASM size verified: 72KB uncompressed, 38KB gzipped (well under limits)
- Updated CI workflow with wasm-bindgen-cli, wasm-opt, and size checks
- All 69 tests pass

### File List
- src/lib.rs (modified - added WASM exports)
- scripts/build-rust.sh (new)
- tests/wasm_tests.rs (new)
- public/index.html (new)
- .github/workflows/ci.yml (modified - WASM build steps)
- dist/pkg/airgap_json_formatter.js (generated)
- dist/pkg/airgap_json_formatter.d.ts (generated)
- dist/pkg/airgap_json_formatter_bg.wasm (generated)

---

## QA Results
*To be filled by QA agent*
