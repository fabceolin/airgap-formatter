# Story 6.1: PWA Install Prompt Support - Brownfield Addition

## Status: Ready for Review

## Story

**As a** user accessing Airgap JSON Formatter in a browser,
**I want** to see a browser installation prompt (Add to Home Screen / Install App),
**so that** I can install the application locally and access it like a native app.

## Story Context

**Existing System Integration:**
- Integrates with: Existing PWA infrastructure (manifest.json, sw.js, index.html)
- Technology: Progressive Web App standards, Service Worker API
- Follows pattern: Existing offline-first architecture (Story 2.6)
- Touch points: public/manifest.json, public/index.html, qt/CMakeLists.txt (asset copying)

## Acceptance Criteria

**Functional Requirements:**

1. Browser displays install prompt (address bar icon) when PWA criteria are met
2. Application icons display correctly in manifest at 192x192 and 512x512 sizes
3. Icons use project branding (dark background `#1e1e1e` with teal `{}` JSON symbol)
4. Installed PWA opens in standalone mode without browser chrome

**Integration Requirements:**

5. Existing Service Worker caching continues to work unchanged
6. Existing manifest.json structure is preserved (only icons array populated)
7. Icons are included in CMake build output for WASM deployment
8. GitHub Pages deployment includes PWA icons

**Quality Requirements:**

9. PWA passes Chrome Lighthouse installability audit
10. Icons render crisply on both standard and high-DPI displays
11. No regression in offline functionality

## Tasks / Subtasks

- [x] Task 1: Create PWA icon assets (AC: 2, 3)
  - [x] Create `public/icon-192.png` (192x192 with JSON `{}` branding)
  - [x] Create `public/icon-512.png` (512x512 with JSON `{}` branding)
  - [x] Use existing theme colors: background `#1e1e1e`, accent `#4ec9b0`
  - [x] Created using Python Pillow with monospace font

- [x] Task 2: Update manifest.json icons array (AC: 2, 6)
  - [x] Add 192x192 icon entry with `"purpose": "any maskable"`
  - [x] Add 512x512 icon entry with `"purpose": "any maskable"`
  - [x] Verify JSON syntax is valid

- [x] Task 3: Update CMake to copy icon assets (AC: 7)
  - [x] Add icon-192.png to Qt WASM build copy step
  - [x] Add icon-512.png to Qt WASM build copy step
  - [x] Updated deploy.yml to copy icons to dist
  - [x] Updated sw.js to cache icons (bumped to v3)

- [x] Task 4: Test PWA installation (AC: 1, 4, 9)
  - [x] Verified manifest structure programmatically
  - [ ] Manual: Test in Chrome DevTools > Application > Manifest
  - [ ] Manual: Verify Lighthouse PWA audit passes installability
  - [ ] Manual: Test install prompt appears in address bar
  - [ ] Manual: Test installed app opens in standalone mode

- [x] Task 5: Verify no regressions (AC: 5, 10, 11)
  - [x] Verify Service Worker still caches assets (4 event listeners intact)
  - [ ] Manual: Test offline functionality after icon addition
  - [ ] Manual: Verify icons render on high-DPI displays

## Dev Notes

### Existing PWA Files

```
public/
├── manifest.json     # EXISTS - needs icons array populated
├── sw.js             # EXISTS - no changes needed
├── index.html        # EXISTS - already has <link rel="manifest">
└── icon-192.png      # NEW - to be created
└── icon-512.png      # NEW - to be created
```

### Current manifest.json (lines 10-11)

```json
"icons": []   // ← Currently empty, needs populated
```

### Required manifest.json icons Update

```json
"icons": [
    {
        "src": "./icon-192.png",
        "sizes": "192x192",
        "type": "image/png",
        "purpose": "any maskable"
    },
    {
        "src": "./icon-512.png",
        "sizes": "512x512",
        "type": "image/png",
        "purpose": "any maskable"
    }
]
```

### Icon Design Specification

Match existing favicon design from index.html:
- Background: `#1e1e1e` (dark theme)
- Symbol: `{}` in `#4ec9b0` (teal accent)
- Font: Monospace, bold
- Corner radius: Proportional to icon size (~12px for 192, ~32px for 512)

### CMakeLists.txt Update Required

Current Qt CMake copies assets to build. Add to existing copy commands:

```cmake
# After existing file copies, add:
file(COPY ${CMAKE_SOURCE_DIR}/../public/icon-192.png DESTINATION ${CMAKE_BINARY_DIR})
file(COPY ${CMAKE_SOURCE_DIR}/../public/icon-512.png DESTINATION ${CMAKE_BINARY_DIR})
```

### PWA Installation Criteria (for reference)

Chrome requires ALL of these for install prompt:
1. Served over HTTPS (or localhost) ✓ GitHub Pages
2. Has a Web App Manifest ✓ Already exists
3. Has a registered Service Worker ✓ Already exists
4. Manifest has `name` or `short_name` ✓ Already has both
5. Manifest has `start_url` ✓ Already set to "./"
6. Manifest has `display` mode ✓ Already "standalone"
7. Manifest has 192x192 icon ← MISSING - this story adds it
8. Manifest has 512x512 icon ← MISSING - this story adds it

### Testing

**Local Testing:**
```bash
# Start local server with HTTPS or use localhost
python3 -m http.server 8080 --directory dist
# Open http://localhost:8080 in Chrome
```

**Chrome DevTools Verification:**
1. Open DevTools → Application → Manifest
2. Check "Installability" section shows no warnings
3. Look for install icon in address bar

**Lighthouse PWA Audit:**
1. DevTools → Lighthouse → Check "Progressive Web App"
2. Run audit → Verify "Installable" criteria pass

## Definition of Done

- [ ] Icon files created (192x192, 512x512) with correct branding
- [ ] manifest.json icons array populated with both sizes
- [ ] CMake updated to copy icons to build output
- [ ] Chrome Lighthouse installability audit passes
- [ ] Install prompt visible in browser address bar
- [ ] Installed app opens in standalone mode
- [ ] Offline functionality verified (no regression)

## Minimal Risk Assessment

- **Primary Risk:** Icon design may not render well at small sizes
- **Mitigation:** Use simple `{}` symbol that scales well
- **Rollback:** Remove icon entries from manifest.json to revert

## Compatibility Verification

- [x] No breaking changes to existing APIs
- [x] No database/storage changes
- [x] UI follows existing design patterns (same colors as favicon)
- [x] Performance impact is negligible (two small PNG files)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-22 | 1.0 | Initial story creation from user PWA request | Sarah (PO) |
| 2026-01-22 | 1.1 | Implementation complete, ready for review | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
None - Implementation straightforward

### Completion Notes List
- Created PWA icons using Python Pillow library
- Icons use DejaVuSansMono-Bold font for `{}` symbol
- Background: #1e1e1e, Text: #4ec9b0, Corner radius: 15%
- Updated manifest.json with proper icon entries
- Updated sw.js: bumped cache version to v3, added icons to precache
- Updated deploy.yml to copy icons to dist folder
- Updated qt/CMakeLists.txt with file(COPY) for EMSCRIPTEN builds
- Manual browser testing required for Lighthouse audit and install prompt

### File List
- public/icon-192.png (new) - 192x192 PWA icon
- public/icon-512.png (new) - 512x512 PWA icon
- public/manifest.json (modified) - Added icons array
- public/sw.js (modified) - Bumped to v3, added icons to precache
- qt/CMakeLists.txt (modified) - Added icon copy for EMSCRIPTEN
- .github/workflows/deploy.yml (modified) - Added icon copy to dist

---

## QA Results
*To be filled by QA agent*
