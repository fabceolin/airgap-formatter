# Story 3.4: TreeView Hover Stability Fix

## Status: Approved

## Story

**As a** user interacting with the TreeView copy controls,
**I want** stable hover interactions on the [V] and [P] buttons,
**so that** I can use copy controls without UI flickering or selection instability.

## Story Context

**Existing System Integration:**
- Integrates with: JsonTreeView.qml (Story 3.2/3.3)
- Technology: Qt 6 QML TreeView, MouseArea, hover states
- Follows pattern: Existing TreeView delegate structure
- Touch points: qt/qml/JsonTreeView.qml

## Acceptance Criteria

**Hover Stability:**

1. Mouse hover on `[V]` (Copy Value) button does not cause selection flickering
2. Mouse hover on `[P]` (Copy Path) button does not cause selection flickering
3. Hover state transitions are smooth without re-rendering artifacts
4. Row highlight remains stable when moving mouse over copy buttons

**Functional Requirements:**

5. Copy Value button remains fully functional after fix
6. Copy Path button remains fully functional after fix
7. Tooltip on hover still appears correctly (with delay)
8. Button background highlight on hover still works

**Quality Requirements:**

9. No visual regression in existing TreeView functionality
10. Performance remains acceptable (no lag on hover)
11. Fix works in both native and WASM builds

## Tasks / Subtasks

- [ ] Task 1: Investigate hover flickering root cause (AC: 1, 2, 3, 4)
  - [ ] Analyze current hover state handling in delegate
  - [ ] Check if MouseArea propagation causes re-render
  - [ ] Test if hoverEnabled on nested MouseAreas conflicts with parent
  - [ ] Document root cause

- [ ] Task 2: Implement hover stability fix (AC: 1, 2, 3, 4, 5, 6, 7, 8)
  - [ ] Implement fix based on investigation findings
  - [ ] Possible solutions to evaluate:
    - Use HoverHandler instead of MouseArea for hover detection
    - Add `propagateComposedEvents: false` to inner MouseAreas
    - Restructure hover state to avoid conflicts
  - [ ] Verify copy functionality still works
  - [ ] Verify tooltips still appear
  - [ ] Test smooth hover transitions

- [ ] Task 3: Test and verify (AC: 9, 10, 11)
  - [ ] Test hover on multiple rows rapidly
  - [ ] Test clicking copy buttons after hover
  - [ ] Verify WASM build behavior
  - [ ] Verify native build behavior

## Dev Notes

### Relevant Source Tree
```
qt/qml/
├── JsonTreeView.qml      # Main file to modify (lines 211-281)
└── Theme.qml             # Styling reference
```

### Current Implementation Analysis

The copy icons section (lines 211-281) has nested hover states that likely conflict:

```qml
// Parent delegate has hover from mouseArea (line 66)
property bool hovered: mouseArea.containsMouse

// Copy icons visibility based on parent hover (line 217)
Row {
    id: copyIcons
    opacity: delegateRoot.hovered ? 1.0 : 0.0

    // Inner MouseAreas ALSO have hoverEnabled (lines 238-243, 268-273)
    Rectangle {
        MouseArea {
            id: copyValueMouse
            hoverEnabled: true  // Potential conflict
            // When this hover activates, it may affect parent's containsMouse
        }
    }
}
```

### Recommended Fix Approaches

**Approach A: HoverHandler (Qt 5.15+/Qt 6)**
```qml
Rectangle {
    id: copyValueBtn
    color: copyValueHover.hovered ? Theme.backgroundTertiary : "transparent"

    HoverHandler {
        id: copyValueHover
    }

    TapHandler {
        onTapped: root.copyValue(delegateRoot.row)
    }

    ToolTip {
        visible: copyValueHover.hovered
        text: "Copy Value"
        delay: 500
    }
}
```

**Approach B: Prevent event propagation**
```qml
MouseArea {
    id: copyValueMouse
    hoverEnabled: true
    propagateComposedEvents: false
    onContainsMouseChanged: {
        // Prevent parent hover state from changing
    }
}
```

**Approach C: Unified hover tracking**
```qml
// Track if ANY button is hovered to prevent row flicker
property bool anyButtonHovered: copyValueMouse.containsMouse || copyPathMouse.containsMouse

Rectangle {
    // Row background - don't change when buttons are hovered
    color: delegateRoot.hovered && !delegateRoot.anyButtonHovered
           ? Qt.rgba(1, 1, 1, 0.05) : "transparent"
}
```

### Key Constraint

The ToolTip components (lines 246-250, 275-279) use `visible: copyValueMouse.containsMouse` which requires the MouseArea to have `hoverEnabled: true`. Any fix must preserve this tooltip functionality.

## Definition of Done

- [ ] Hover on [V] button is stable (no flicker)
- [ ] Hover on [P] button is stable (no flicker)
- [ ] Row selection/highlight remains stable during button hover
- [ ] Copy Value still works correctly
- [ ] Copy Path still works correctly
- [ ] Tooltips still appear on hover
- [ ] Button background highlights on hover
- [ ] No visual regression in TreeView
- [ ] Works in WASM build
- [ ] Works in native build

## Risk and Compatibility Check

**Minimal Risk Assessment:**
- **Primary Risk:** Fix may break click behavior or tooltips
- **Mitigation:** Test all copy functionality thoroughly after fix
- **Rollback:** Revert MouseArea changes if functionality breaks

**Compatibility Verification:**
- [ ] Copy buttons remain clickable
- [ ] Tooltips appear after delay
- [ ] Context menu still works
- [ ] TreeView expansion/collapse unaffected

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-21 | 1.0 | Initial story creation (split from 3.4) | Sarah (PO) |
