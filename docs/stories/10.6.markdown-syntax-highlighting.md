# Story 10.6: Markdown Syntax Highlighting (Code View)

## Status: Draft

## Story

**As a** user viewing Markdown source in Code view,
**I want** the syntax to be color-coded,
**So that** I can easily read and understand the Markdown structure.

## Background

When viewing Markdown in Code view (raw source), the content should have syntax highlighting similar to how JSON and XML are highlighted. This helps users:
1. Identify Markdown elements (headings, code, links)
2. Spot Mermaid diagram blocks
3. Verify their Markdown structure before rendering

This story implements Markdown syntax highlighting in Rust (following the pattern of `highlighter.rs` and `xml_highlighter.rs`) that generates HTML with color spans.

## Acceptance Criteria

1. Markdown syntax highlighted in Code view with Theme.qml colors
2. Elements highlighted:
   - Headings (`#`, `##`, `###`, etc.) - heading color
   - Bold (`**text**`) - bold styling
   - Italic (`*text*`) - italic styling
   - Code (inline \`code\` and ``` blocks) - code background
   - Links (`[text](url)`) - link color
   - Lists (`-`, `*`, `1.`) - punctuation color
   - Blockquotes (`>`) - distinct color
   - Horizontal rules (`---`) - punctuation color
3. Mermaid code blocks highlighted distinctly (recognizable)
4. WASM binding `highlightMarkdown(input)` exposed to JavaScript
5. Performance acceptable for 1MB documents (< 200ms)
6. Output is XSS-safe (HTML entities escaped)
7. Works correctly with Theme.qml dark and light modes

## Tasks / Subtasks

- [ ] Task 1: Create markdown_highlighter.rs module (AC: 1, 2)
  - [ ] Create `src/markdown_highlighter.rs`
  - [ ] Add module declaration to `src/lib.rs`
  - [ ] Define span generation function
  - [ ] Implement pattern-based highlighting

- [ ] Task 2: Implement heading highlighting (AC: 2)
  - [ ] Match `^#{1,6}\s` pattern
  - [ ] Apply `<span class="md-heading">` wrapper
  - [ ] Include the heading text in same span

- [ ] Task 3: Implement emphasis highlighting (AC: 2)
  - [ ] Match `**bold**` pattern → `<span class="md-bold">`
  - [ ] Match `*italic*` pattern → `<span class="md-italic">`
  - [ ] Match `~~strikethrough~~` → `<span class="md-strike">`
  - [ ] Handle nested emphasis

- [ ] Task 4: Implement code highlighting (AC: 2, 3)
  - [ ] Match inline \`code\` → `<span class="md-code-inline">`
  - [ ] Match ``` blocks → `<span class="md-code-block">`
  - [ ] Special class for mermaid blocks → `<span class="md-mermaid">`
  - [ ] Preserve code content (no inner highlighting)

- [ ] Task 5: Implement link highlighting (AC: 2)
  - [ ] Match `[text](url)` pattern
  - [ ] Apply `<span class="md-link-text">` to text
  - [ ] Apply `<span class="md-link-url">` to url
  - [ ] Handle reference-style links `[text][ref]`

- [ ] Task 6: Implement list and blockquote highlighting (AC: 2)
  - [ ] Match `^[-*]\s` and `^\d+\.\s` for lists
  - [ ] Match `^>\s` for blockquotes
  - [ ] Apply appropriate span classes

- [ ] Task 7: Add WASM binding (AC: 4)
  - [ ] Add `#[wasm_bindgen]` annotation
  - [ ] Create `highlightMarkdown(input: &str) -> String`
  - [ ] Return HTML with spans

- [ ] Task 8: XSS protection (AC: 6)
  - [ ] Escape `<`, `>`, `&` in content
  - [ ] Ensure spans don't break with malicious input
  - [ ] Test with XSS payloads

- [ ] Task 9: Performance optimization (AC: 5)
  - [ ] Profile with 1MB document
  - [ ] Optimize regex if needed
  - [ ] Consider streaming approach for large docs

- [ ] Task 10: Theme integration (AC: 7)
  - [ ] Update Theme.qml with Markdown-specific colors
  - [ ] Update CSS in OutputPane for .md-* classes
  - [ ] Test dark and light modes

## Dev Notes

### Relevant Source Tree

```
src/
├── lib.rs                  # Add mod markdown_highlighter
├── markdown_highlighter.rs # NEW: Markdown highlighting
├── highlighter.rs          # Reference: JSON highlighter pattern
└── xml_highlighter.rs      # Reference: XML highlighter pattern

qt/qml/
└── Theme.qml               # Add Markdown syntax colors
```

### Highlighter Implementation Approach

Unlike JSON/XML which have strict syntax, Markdown highlighting can use a line-by-line approach with regex patterns:

```rust
use regex::Regex;
use lazy_static::lazy_static;

lazy_static! {
    static ref HEADING_RE: Regex = Regex::new(r"^(#{1,6})\s(.*)$").unwrap();
    static ref BOLD_RE: Regex = Regex::new(r"\*\*(.+?)\*\*").unwrap();
    static ref ITALIC_RE: Regex = Regex::new(r"\*(.+?)\*").unwrap();
    static ref CODE_INLINE_RE: Regex = Regex::new(r"`([^`]+)`").unwrap();
    static ref LINK_RE: Regex = Regex::new(r"\[([^\]]+)\]\(([^)]+)\)").unwrap();
    static ref CODE_BLOCK_START: Regex = Regex::new(r"^```(\w*)$").unwrap();
}

pub fn highlight_markdown(input: &str) -> String {
    let mut output = String::with_capacity(input.len() * 2);
    let mut in_code_block = false;
    let mut code_block_lang = String::new();

    for line in input.lines() {
        if in_code_block {
            if line.trim() == "```" {
                output.push_str("</span>");
                in_code_block = false;
            } else {
                output.push_str(&escape_html(line));
                output.push('\n');
            }
            continue;
        }

        if let Some(caps) = CODE_BLOCK_START.captures(line) {
            code_block_lang = caps.get(1).map_or("", |m| m.as_str()).to_string();
            let class = if code_block_lang == "mermaid" {
                "md-mermaid"
            } else {
                "md-code-block"
            };
            output.push_str(&format!("<span class=\"{}\">```{}\n", class, code_block_lang));
            in_code_block = true;
            continue;
        }

        let highlighted = highlight_line(line);
        output.push_str(&highlighted);
        output.push('\n');
    }

    output
}

fn highlight_line(line: &str) -> String {
    let escaped = escape_html(line);

    // Apply patterns in order (heading first, then inline)
    if let Some(caps) = HEADING_RE.captures(&escaped) {
        let hashes = &caps[1];
        let text = &caps[2];
        return format!("<span class=\"md-heading\">{} {}</span>", hashes, text);
    }

    // Apply inline patterns
    let result = BOLD_RE.replace_all(&escaped, "<span class=\"md-bold\">**$1**</span>");
    let result = ITALIC_RE.replace_all(&result, "<span class=\"md-italic\">*$1*</span>");
    let result = CODE_INLINE_RE.replace_all(&result, "<span class=\"md-code-inline\">`$1`</span>");
    let result = LINK_RE.replace_all(&result,
        "<span class=\"md-link\">[<span class=\"md-link-text\">$1</span>](<span class=\"md-link-url\">$2</span>)</span>");

    result.to_string()
}

fn escape_html(s: &str) -> String {
    s.replace('&', "&amp;")
     .replace('<', "&lt;")
     .replace('>', "&gt;")
}
```

### CSS Classes

```css
/* In OutputPane or Theme-generated CSS */
.md-heading { color: var(--syntax-heading); font-weight: bold; }
.md-bold { font-weight: bold; }
.md-italic { font-style: italic; }
.md-strike { text-decoration: line-through; }
.md-code-inline {
    background: var(--syntax-code-bg);
    padding: 2px 4px;
    border-radius: 3px;
    font-family: monospace;
}
.md-code-block {
    background: var(--syntax-code-bg);
    display: block;
    padding: 8px;
    border-radius: 4px;
}
.md-mermaid {
    background: var(--syntax-mermaid-bg);
    border-left: 3px solid var(--syntax-mermaid-border);
    display: block;
    padding: 8px;
}
.md-link { }
.md-link-text { color: var(--syntax-link); }
.md-link-url { color: var(--syntax-url); opacity: 0.7; }
.md-list-marker { color: var(--syntax-punctuation); }
.md-blockquote { color: var(--syntax-blockquote); border-left: 2px solid; padding-left: 8px; }
```

### Theme.qml Additions

```qml
// Add to Theme.qml
// Markdown syntax colors
readonly property color syntaxHeading: darkMode ? "#569cd6" : "#0066cc"
readonly property color syntaxLink: darkMode ? "#4ec9b0" : "#22863a"
readonly property color syntaxUrl: darkMode ? "#ce9178" : "#6f42c1"
readonly property color syntaxCodeBg: darkMode ? "#252526" : "#f0f0f0"
readonly property color syntaxMermaidBg: darkMode ? "#2d3748" : "#e6f3ff"
readonly property color syntaxMermaidBorder: darkMode ? "#4299e1" : "#3182ce"
readonly property color syntaxBlockquote: darkMode ? "#808080" : "#6a737d"
```

### WASM Binding

```rust
#[wasm_bindgen]
pub fn highlightMarkdown(input: &str) -> String {
    highlight_markdown(input)
}
```

### Bridge Integration

```javascript
// In bridge.js
highlightMarkdown(input) {
    if (!isInitialized) {
        return this.escapeHtml(input);
    }
    const inputStr = String(input || '');
    try {
        return wasmModule.highlightMarkdown(inputStr);
    } catch (e) {
        console.error('[Bridge] highlightMarkdown error:', e);
        return this.escapeHtml(inputStr);
    }
}
```

## Testing

### Test Location
- Rust unit tests: `src/markdown_highlighter.rs`
- Visual testing: Manual in browser

### Test Cases

| Input | Expected Class | Notes |
|-------|----------------|-------|
| `# Heading` | `.md-heading` | H1 |
| `## Sub` | `.md-heading` | H2 |
| `**bold**` | `.md-bold` | Bold |
| `*italic*` | `.md-italic` | Italic |
| \`code\` | `.md-code-inline` | Inline code |
| ``` ```js ``` | `.md-code-block` | Code block |
| ``` ```mermaid ``` | `.md-mermaid` | Mermaid block |
| `[text](url)` | `.md-link` | Link |
| `<script>` | `&lt;script&gt;` | XSS escaped |

### XSS Test Cases

```markdown
# <script>alert('xss')</script>
**<img src=x onerror=alert(1)>**
[link](javascript:alert(1))
```

All should be escaped, no JS execution.

### Performance Test

```rust
#[test]
fn test_large_document_performance() {
    let large_doc = "# Heading\n\nParagraph with **bold** and *italic*.\n".repeat(10000);
    let start = std::time::Instant::now();
    let _ = highlight_markdown(&large_doc);
    assert!(start.elapsed().as_millis() < 200);
}
```

## Definition of Done

- [ ] All acceptance criteria met
- [ ] All tasks completed
- [ ] All Markdown elements highlighted correctly
- [ ] Mermaid blocks visually distinct
- [ ] XSS protection verified
- [ ] Performance < 200ms for 1MB
- [ ] Theme colors applied correctly
- [ ] Code reviewed

## Dependencies

- **Depends on:** 10.1 (shares Rust module structure), 10.7 (Theme colors)
- **Blocks:** 10.8 (Integration Testing)

## Estimate

3 points

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-28 | 1.0 | Story created from Epic 10.0 | Sarah (PO) |
