# Story 1.3: JSON Validation and Statistics Module

## Status: Ready for Review

## Story

**As a** user,
**I want** to validate JSON and see statistics about its structure,
**so that** I can quickly verify correctness and understand complexity.

## Acceptance Criteria

1. Rust module `json_validator` implements `validate_json(input: &str) -> ValidationResult`
2. `ValidationResult` contains: `is_valid: bool`, `error: Option<ValidationError>`, `stats: JsonStats`
3. `ValidationError` includes `message`, `line`, `column` fields
4. `JsonStats` includes: `object_count`, `array_count`, `string_count`, `number_count`, `boolean_count`, `null_count`, `max_depth`, `total_keys`
5. Unit tests cover: valid JSON validation, various error types with correct positions, statistics accuracy
6. Minify function `minify_json(input: &str) -> Result<String, FormatError>` implemented and tested

## Tasks / Subtasks

- [x] Task 1: Add JsonStats type to types module (AC: 4)
  - [x] Add `JsonStats` struct to `src/types.rs`
  - [x] Include all required fields: object_count, array_count, string_count, number_count, boolean_count, null_count, max_depth, total_keys
  - [x] Derive Default, Clone, Debug traits
  - [x] Implement method to increment counters

- [x] Task 2: Add ValidationResult type to types module (AC: 2, 3)
  - [x] Add `ValidationResult` struct to `src/types.rs`
  - [x] Include is_valid, error (Option<FormatError>), stats fields
  - [x] Note: Reuse `FormatError` for ValidationError (same structure)

- [x] Task 3: Create validator module with validate_json function (AC: 1)
  - [x] Create `src/validator.rs`
  - [x] Implement `validate_json(input: &str) -> ValidationResult`
  - [x] Parse JSON using serde_json
  - [x] Walk the parsed JSON tree to collect statistics
  - [x] Track max_depth during traversal
  - [x] Return appropriate ValidationResult for valid/invalid JSON

- [x] Task 4: Implement statistics collection (AC: 4)
  - [x] Create recursive function to walk JSON Value tree
  - [x] Count each value type (object, array, string, number, bool, null)
  - [x] Count total keys across all objects
  - [x] Track current depth and update max_depth

- [x] Task 5: Implement minify_json function (AC: 6)
  - [x] Add `minify_json(input: &str) -> Result<String, FormatError>` to formatter.rs or validator.rs
  - [x] Parse JSON then serialize without whitespace
  - [x] Use serde_json::to_string (compact format)
  - [x] Return FormatError for invalid input

- [x] Task 6: Update lib.rs to export new modules and types (AC: 1, 2)
  - [x] Add mod declaration for validator
  - [x] Re-export ValidationResult, JsonStats

- [x] Task 7: Write comprehensive unit tests (AC: 5)
  - [x] Create `src/tests/validator_tests.rs`
  - [x] Test valid JSON returns is_valid=true
  - [x] Test invalid JSON returns correct error with line/column
  - [x] Test statistics accuracy for various JSON structures
  - [x] Test deeply nested JSON max_depth calculation
  - [x] Test minify_json removes all whitespace
  - [x] Test minify_json error handling

## Dev Notes

### Module Structure
```
src/
├── lib.rs           # Module exports
├── types.rs         # Add JsonStats, ValidationResult
├── formatter.rs     # Add minify_json
├── validator.rs     # NEW: validate_json
└── tests/
    ├── formatter_tests.rs
    └── validator_tests.rs
```

### Type Definitions

```rust
// src/types.rs additions

#[derive(Clone, Debug, Default)]
pub struct JsonStats {
    pub object_count: usize,
    pub array_count: usize,
    pub string_count: usize,
    pub number_count: usize,
    pub boolean_count: usize,
    pub null_count: usize,
    pub max_depth: usize,
    pub total_keys: usize,
}

#[derive(Clone, Debug)]
pub struct ValidationResult {
    pub is_valid: bool,
    pub error: Option<FormatError>,
    pub stats: JsonStats,
}
```

### Statistics Collection Algorithm
```rust
fn collect_stats(value: &serde_json::Value, depth: usize, stats: &mut JsonStats) {
    stats.max_depth = stats.max_depth.max(depth);

    match value {
        Value::Object(map) => {
            stats.object_count += 1;
            stats.total_keys += map.len();
            for v in map.values() {
                collect_stats(v, depth + 1, stats);
            }
        }
        Value::Array(arr) => {
            stats.array_count += 1;
            for v in arr {
                collect_stats(v, depth + 1, stats);
            }
        }
        Value::String(_) => stats.string_count += 1,
        Value::Number(_) => stats.number_count += 1,
        Value::Bool(_) => stats.boolean_count += 1,
        Value::Null => stats.null_count += 1,
    }
}
```

### Critical Architecture Rules
- **Zero Network Calls:** Never use fetch, XMLHttpRequest, WebSocket
- **No Persistent Storage:** Never use localStorage, sessionStorage, IndexedDB
- **Error Handling:** All public functions must return Result types. Never panic in WASM code.

### Testing

**Test Location:** `src/tests/validator_tests.rs`

**Testing Framework:** cargo test

**Test Commands:**
```bash
cargo test validator
cargo test minify
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-20 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
None - no blocking issues encountered

### Completion Notes List
- Added JsonStats struct with all required fields to types.rs
- Added ValidationResult struct with valid() and invalid() constructors
- Created validator.rs with validate_json() and collect_stats() functions
- Implemented recursive statistics collection for all JSON value types
- Added minify_json() to formatter.rs using serde_json::to_string
- Updated lib.rs to export validator module and new types
- Created validator_tests.rs with 29 tests for validation and minify
- All 69 tests pass (1 performance test ignored in debug mode, passes in release)

### File List
- src/types.rs (modified - added JsonStats, ValidationResult)
- src/validator.rs (new)
- src/formatter.rs (modified - added minify_json)
- src/lib.rs (modified - exports)
- src/tests/validator_tests.rs (new)
- src/tests/mod.rs (modified)

---

## QA Results
*To be filled by QA agent*
