# Epic 10.0: Markdown + Mermaid Diagram Support

## Status: Draft

## Epic Summary

**As a** user of the Airgap Multi-Format Formatter,
**I want** to render Markdown content with embedded Mermaid diagrams,
**so that** I can preview documentation and diagrams in a trusted, offline tool.

## Background

This epic extends the multi-format vision established in Epic 8 (XML support). The architecture pattern is proven: parallel Rust modules for parsing, bridge layer for Qt↔WASM communication, and format auto-detection for seamless UX.

### Source Planning

Originally planned as a separate project (airgap-markdown-mermaid), now integrated into this codebase to maximize reuse:
- History storage (IndexedDB with SHA-256 dedup)
- Theme system (dark/light modes)
- Bridge communication pattern
- Service Worker offline support
- Privacy indicators

### Technical Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Markdown Parser | `comrak` (Rust) | GFM support (tables, strikethrough, task lists), ~150KB |
| Mermaid Renderer | `mermaid.js` (JS) | Battle-tested, full diagram support, ~2MB |
| Output Format | HTML + embedded SVG | Consistent with existing HTML output pattern |
| Preview Pane | Reuse OutputPane | WebView for HTML rendering, Code view for raw HTML |

## Epic Goals

1. **Auto-detect Markdown** - Extend format detection for `.md` content patterns
2. **Render Markdown to HTML** - Full GFM support via comrak
3. **Render Mermaid to SVG** - Detect ```mermaid blocks, render inline
4. **Syntax Highlighting** - Color-coded Markdown in Code view
5. **Seamless UX** - Same paste→format→output workflow as JSON/XML

## Existing System Context

| Component | Current State | Markdown Integration Point |
|-----------|---------------|---------------------------|
| **Rust Core** | `formatter.rs`, `xml_formatter.rs` | Add `markdown_renderer.rs` |
| **WASM Exports** | `formatJson`, `formatXml` | Add `renderMarkdown` |
| **bridge.js** | JSON/XML methods | Add `renderMarkdown`, `renderMermaid` |
| **Format Detection** | JSON/XML detection | Extend for Markdown patterns |
| **OutputPane.qml** | HTML display (RichText) | Add WebView mode for full HTML |
| **Theme.qml** | JSON/XML syntax colors | Add Markdown heading/code colors |

## Technical Approach

### Format Auto-Detection Extension

```cpp
QString detectFormat(const QString &input) {
    QString trimmed = input.trimmed();

    // Existing checks
    if (trimmed.startsWith('<')) return "xml";
    if (trimmed.startsWith('{') || trimmed.startsWith('[')) return "json";

    // New: Markdown detection
    if (trimmed.startsWith('#') ||           // Headings
        trimmed.startsWith("```") ||         // Code blocks
        trimmed.startsWith("---") ||         // Frontmatter/HR
        trimmed.startsWith("- ") ||          // Lists
        trimmed.startsWith("* ") ||          // Lists
        trimmed.startsWith("> ") ||          // Blockquotes
        trimmed.contains("\n# ") ||          // Headings mid-document
        trimmed.contains("\n```"))           // Code blocks mid-document
    {
        return "markdown";
    }

    return "unknown";
}
```

### Rendering Pipeline

```
Input (Markdown + Mermaid blocks)
        ↓
    [Rust: comrak]
        ↓
    HTML with <pre><code class="language-mermaid">...</code></pre>
        ↓
    [JS: mermaid.js]
        ↓
    HTML with inline <svg>...</svg>
        ↓
    Output Pane (WebView or Code view)
```

### Mermaid Integration Pattern

```javascript
// In bridge.js
async renderMarkdownWithMermaid(markdown) {
    // Step 1: Render Markdown to HTML (Rust)
    const html = wasmModule.renderMarkdown(markdown);

    // Step 2: Find and render Mermaid blocks (JS)
    const container = document.createElement('div');
    container.innerHTML = html;

    const mermaidBlocks = container.querySelectorAll('code.language-mermaid');
    for (const block of mermaidBlocks) {
        const svg = await mermaid.render('mermaid-' + id++, block.textContent);
        block.parentElement.outerHTML = svg.svg;
    }

    return container.innerHTML;
}
```

## Stories

### 10.1: Rust Markdown Renderer Module
**Goal:** Implement Markdown→HTML conversion using comrak

**Scope:**
- Add `comrak` dependency to Cargo.toml
- Create `src/markdown_renderer.rs` module
- Implement `render_markdown(input: &str) -> Result<String, RenderError>`
- Support GFM extensions: tables, strikethrough, task lists, autolinks
- Generate semantic HTML with class annotations for styling
- WASM bindings via `wasm-bindgen`

**Acceptance Criteria:**
1. Standard Markdown renders correctly (headings, lists, code, links, images, blockquotes)
2. GFM tables render as `<table>` elements
3. Fenced code blocks include `language-{lang}` class
4. Mermaid blocks output as `<code class="language-mermaid">`
5. Unit tests cover edge cases (empty input, unicode, nested structures)
6. WASM bundle size increase < 200KB

**Depends on:** None
**Estimate:** 3 points

---

### 10.2: Mermaid.js Library Integration
**Goal:** Add mermaid.js for diagram rendering

**Scope:**
- Add mermaid.js to `/public/` assets (~2MB)
- Configure mermaid with secure defaults (no external requests)
- Create `renderMermaid(code)` wrapper function
- Handle render errors gracefully (show error message in output)
- Update Service Worker cache manifest

**Acceptance Criteria:**
1. Mermaid.js loads without network requests (bundled)
2. Supported diagram types: flowchart, sequence, class, state, ER, gantt, pie, mindmap
3. Invalid diagram syntax shows error message (not crash)
4. Mermaid renders in dark/light theme (respects Theme.qml)
5. No XSS vulnerabilities (sanitized SVG output)

**Depends on:** None (parallel with 10.1)
**Estimate:** 2 points

---

### 10.3: Bridge Layer Markdown Methods
**Goal:** Expose Markdown/Mermaid functionality to QML

**Scope:**
- Add `renderMarkdown(input)` to bridge.js
- Add `renderMermaid(code)` to bridge.js
- Add `renderMarkdownWithMermaid(input)` combined method
- Integrate with AsyncSerialiser for non-blocking renders
- Add corresponding signals in JsonBridge (C++)

**Acceptance Criteria:**
1. `renderMarkdown` returns HTML string
2. `renderMermaid` returns SVG string
3. `renderMarkdownWithMermaid` returns HTML with embedded SVGs
4. Errors return structured JSON with message
5. Large documents don't block UI (async via AsyncSerialiser)

**Depends on:** 10.1, 10.2
**Estimate:** 2 points

---

### 10.4: Format Auto-Detection Extension
**Goal:** Detect Markdown content automatically

**Scope:**
- Extend `detectFormat()` in JsonBridge for Markdown patterns
- Handle ambiguous cases (plain text vs Markdown)
- Update format selector UI to include "Markdown" option
- Test detection accuracy across various Markdown samples

**Acceptance Criteria:**
1. `# Heading` detected as Markdown
2. Content with ``` code blocks detected as Markdown
3. `---` frontmatter detected as Markdown
4. Lists (`- `, `* `, `1. `) detected as Markdown
5. Plain prose defaults to "unknown" (not falsely detected)
6. Manual override still works via toolbar

**Depends on:** 10.3, Story 8.4 (existing format detection)
**Estimate:** 2 points

---

### 10.5: Markdown Preview Pane
**Goal:** Display rendered Markdown/Mermaid output

**Scope:**
- Extend OutputPane.qml to handle HTML with embedded SVG
- Add "Preview" view mode (alongside Code/Tree)
- Implement WebEngineView for full HTML rendering
- Style preview with Theme.qml colors (background, text, links)
- Handle large documents with virtualized scrolling

**Acceptance Criteria:**
1. Rendered HTML displays correctly with formatting
2. Mermaid SVG diagrams display inline
3. Links are visible but not clickable (security)
4. Images show placeholder (no external fetch by default)
5. Preview respects dark/light theme
6. Code view shows raw HTML source
7. Copy button copies rendered HTML

**Depends on:** 10.3
**Estimate:** 3 points

---

### 10.6: Markdown Syntax Highlighting (Code View)
**Goal:** Color-coded Markdown source in Code view

**Scope:**
- Add Markdown patterns to Rust highlighter (or create `markdown_highlighter.rs`)
- Highlight: headings, bold, italic, code, links, lists, blockquotes
- Highlight Mermaid blocks distinctly
- Integrate with existing Theme.qml color system

**Acceptance Criteria:**
1. Headings (#, ##, ###) highlighted with heading color
2. Bold (**text**) and italic (*text*) styled appropriately
3. Code blocks (```) highlighted with code background
4. Links [text](url) show link color
5. Mermaid blocks have distinct styling
6. Performance acceptable for 1MB documents

**Depends on:** 10.1
**Estimate:** 3 points

---

### 10.7: Theme Extension for Markdown
**Goal:** Add Markdown/Mermaid colors to Theme.qml

**Scope:**
- Add Markdown syntax colors (headings, code, links, etc.)
- Add Mermaid theme configuration
- Ensure dark/light mode consistency
- Document color usage for future reference

**Acceptance Criteria:**
1. Theme.qml has `syntaxHeading`, `syntaxCode`, `syntaxLink`, etc.
2. Mermaid diagrams render with theme-appropriate colors
3. Both dark and light themes look professional
4. No color contrast issues (WCAG AA)

**Depends on:** None (can be parallel)
**Estimate:** 1 point

---

### 10.8: Integration Testing
**Goal:** End-to-end validation of Markdown workflows

**Scope:**
- Test auto-detection accuracy
- Test Markdown rendering for GFM features
- Test Mermaid diagram types (flowchart, sequence, etc.)
- Test error handling (invalid Mermaid syntax)
- Test preview pane display
- Cross-browser validation
- Regression testing (ensure JSON/XML still work)
- Performance testing (render time for various document sizes)

**Acceptance Criteria:**
1. All GFM features render correctly
2. All Mermaid diagram types render correctly
3. Invalid syntax shows helpful error message
4. No regression in JSON/XML functionality
5. Render time < 500ms for typical documents
6. Works in Chrome, Firefox, Safari, Edge

**Depends on:** 10.1-10.7
**Estimate:** 3 points

## Story Dependencies

```
10.1 (Rust MD) ──┬──→ 10.3 (Bridge) ──→ 10.4 (Detection) ──→ 10.5 (Preview)
10.2 (Mermaid) ──┘         │
                           └──→ 10.6 (Highlighting)
10.7 (Theme) ──────────────────────────────────────────────→ (all)

All ───────────────────────────────────────────────────────→ 10.8 (Testing)
```

**Parallelization:**
- 10.1 and 10.2 can run in parallel
- 10.7 can run in parallel with everything
- 10.6 depends only on 10.1
- 10.8 requires all stories complete

## Effort Summary

| Story | Points | Description |
|-------|--------|-------------|
| 10.1 | 3 | Rust Markdown Renderer (comrak) |
| 10.2 | 2 | Mermaid.js Integration |
| 10.3 | 2 | Bridge Layer Methods |
| 10.4 | 2 | Format Auto-Detection Extension |
| 10.5 | 3 | Markdown Preview Pane |
| 10.6 | 3 | Markdown Syntax Highlighting |
| 10.7 | 1 | Theme Extension |
| 10.8 | 3 | Integration Testing |
| **Total** | **19** | |

## Risks & Mitigations

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Mermaid.js bundle size (~2MB) | Medium | Certain | Accept - value justifies size; lazy load if needed |
| WebView security concerns | High | Low | Disable navigation, sandbox content |
| Detection false positives | Low | Medium | Allow manual override; prioritize precision |
| Mermaid render performance | Medium | Low | Async rendering, timeout for complex diagrams |
| comrak WASM compatibility | High | Low | Already validated in planning phase |

## Out of Scope

- Live editing with real-time preview (future enhancement)
- Markdown export to PDF
- Custom Mermaid themes beyond dark/light
- Remote image loading (airgap constraint)
- Markdown linting/validation
- YAML frontmatter parsing (separate Epic 11)
- DOT/GraphViz support (separate Epic 12)

## Compatibility Requirements

- [x] Existing JSON functionality unchanged
- [x] Existing XML functionality unchanged
- [x] History storage works for Markdown (format-agnostic)
- [x] Theme system extended (no breaking changes)
- [x] Zero network calls maintained (security requirement)

## Acceptance Criteria (Epic Level)

1. User can paste Markdown and it's automatically detected
2. Format button renders Markdown to HTML with Mermaid diagrams as SVG
3. Preview pane shows rendered output correctly
4. Code view shows syntax-highlighted raw HTML
5. User can manually switch between formats
6. All existing JSON/XML functionality continues to work
7. Mermaid.js loaded from local bundle (no CDN)
8. WASM bundle size increase < 200KB (excluding mermaid.js)

## Definition of Done

- [ ] All 8 stories completed and QA-passed
- [ ] Cross-browser testing complete (Chrome, Firefox, Safari, Edge)
- [ ] No regression in JSON/XML functionality
- [ ] Performance benchmarks met
- [ ] Theme colors documented
- [ ] Service Worker cache updated

## Future Epics (Multi-Format Roadmap)

| Epic | Format | Status |
|------|--------|--------|
| 8 | XML | In Progress |
| 10 | Markdown + Mermaid | This Epic |
| 11 | YAML | Planned |
| 12 | DOT/GraphViz | Planned |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-28 | 1.0 | Epic created from airgap-markdown-mermaid planning | Sarah (PO) |
