# Story 10.5: Markdown Preview Pane

## Status: Draft

## Story

**As a** user viewing rendered Markdown,
**I want** to see the formatted HTML with embedded diagrams in a preview pane,
**So that** I can verify my documentation renders correctly.

## Background

The existing OutputPane uses a TextArea with RichText for JSON/XML syntax-highlighted output. For Markdown, we need to display full HTML including:
- Rendered Markdown elements (headings, tables, lists, etc.)
- Embedded SVG diagrams from Mermaid
- Theme-appropriate styling

This story adds a "Preview" view mode that uses a WebEngineView (or similar) to render the full HTML document, while preserving the existing "Code" view for showing raw HTML source.

## Acceptance Criteria

1. New "Preview" view mode added to OutputPane
2. View toggle includes: Code | Tree | Preview (where applicable per format)
3. Preview mode displays rendered HTML correctly:
   - Headings render with proper sizes
   - Tables render with borders and alignment
   - Code blocks render with background styling
   - Links display (but are not clickable for security)
   - Mermaid SVG diagrams display inline
4. Preview pane respects Theme.qml colors:
   - Background color matches theme
   - Text color matches theme
   - Code block styling matches theme
5. Images show placeholder (no external fetch by default)
6. Code view shows syntax-highlighted raw HTML
7. Copy button copies rendered HTML source
8. Large documents scroll smoothly
9. Preview updates when content changes (debounced)

## Tasks / Subtasks

- [ ] Task 1: Add Preview view mode to OutputPane (AC: 1, 2)
  - [ ] Add "preview" to viewMode enum/property
  - [ ] Update view toggle button/tabs to include Preview
  - [ ] Show Preview option only for markdown format
  - [ ] Implement view switching logic

- [ ] Task 2: Implement HTML preview rendering (AC: 3)
  - [ ] Evaluate rendering approach (WebEngineView vs TextArea with HTML)
  - [ ] If WebEngineView: Configure for local content only
  - [ ] If TextArea: Use RichText mode with HTML content
  - [ ] Render headings, paragraphs, lists correctly
  - [ ] Render tables with proper structure
  - [ ] Render code blocks with styling
  - [ ] Display Mermaid SVG diagrams

- [ ] Task 3: Apply theme styling (AC: 4)
  - [ ] Create CSS template for preview pane
  - [ ] Map Theme.qml colors to CSS variables
  - [ ] Apply dark theme styles (background, text, etc.)
  - [ ] Apply light theme styles
  - [ ] Re-apply styles on theme change

- [ ] Task 4: Security hardening (AC: 5)
  - [ ] Disable link navigation (prevent leaving app)
  - [ ] Block external resource loading
  - [ ] Replace external images with placeholder
  - [ ] Sanitize any potentially dangerous HTML

- [ ] Task 5: Code view for HTML (AC: 6)
  - [ ] Ensure Code view shows raw HTML string
  - [ ] Apply HTML syntax highlighting (reuse existing or extend)
  - [ ] Handle large HTML documents

- [ ] Task 6: Copy functionality (AC: 7)
  - [ ] Copy button copies HTML source (not rendered text)
  - [ ] Visual feedback on copy
  - [ ] Consistent with JSON/XML copy behavior

- [ ] Task 7: Scrolling and performance (AC: 8, 9)
  - [ ] Implement smooth scrolling for large documents
  - [ ] Debounce preview updates (300ms)
  - [ ] Test with 500KB documents
  - [ ] Optimize if needed

- [ ] Task 8: Integration testing
  - [ ] Test view switching (Code ↔ Preview)
  - [ ] Test theme switching in preview
  - [ ] Test various Markdown content
  - [ ] Test Mermaid diagram display
  - [ ] Test copy functionality

## Dev Notes

### Relevant Source Tree

```
qt/qml/
├── OutputPane.qml      # Extend with Preview mode
├── MarkdownPreview.qml # NEW: Preview component (if separate)
├── Main.qml            # View mode handling
└── Theme.qml           # Color definitions

public/
└── preview-styles.css  # NEW: Preview pane CSS (if using WebView)
```

### View Mode Architecture

```qml
// OutputPane.qml
Item {
    id: outputPane

    property string viewMode: "code"  // "code", "tree", "preview"
    property string format: "json"     // "json", "xml", "markdown"
    property string content: ""
    property string htmlContent: ""    // For markdown preview

    // Show appropriate view based on mode and format
    Loader {
        anchors.fill: parent
        sourceComponent: {
            if (viewMode === "preview" && format === "markdown") {
                return previewComponent;
            } else if (viewMode === "tree" && (format === "json" || format === "xml")) {
                return treeComponent;
            } else {
                return codeComponent;
            }
        }
    }

    Component {
        id: previewComponent
        MarkdownPreview {
            html: outputPane.htmlContent
            darkMode: Theme.darkMode
        }
    }

    // ... other components
}
```

### Preview Component Options

**Option A: WebEngineView (Full HTML support)**
```qml
import QtWebEngine

WebEngineView {
    id: preview

    // Security: Disable navigation
    onNavigationRequested: function(request) {
        request.reject();
    }

    // Load HTML content
    function loadHtml(html) {
        loadHtml(wrapWithStyles(html), "about:blank");
    }
}
```

**Option B: TextArea with RichText (Simpler, less features)**
```qml
ScrollView {
    TextArea {
        textFormat: TextArea.RichText
        readOnly: true
        text: htmlContent
        // Note: Limited HTML support, no SVG
    }
}
```

**Recommendation:** WebEngineView for full SVG/HTML support, with security hardening.

### CSS Styling Template

```css
/* preview-styles.css */
:root {
    --bg-color: #1e1e1e;
    --text-color: #d4d4d4;
    --heading-color: #569cd6;
    --link-color: #4ec9b0;
    --code-bg: #252526;
    --code-border: #3c3c3c;
    --table-border: #3c3c3c;
}

body {
    background: var(--bg-color);
    color: var(--text-color);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    padding: 16px;
    margin: 0;
}

h1, h2, h3, h4, h5, h6 {
    color: var(--heading-color);
    margin-top: 24px;
    margin-bottom: 16px;
}

a {
    color: var(--link-color);
    text-decoration: none;
    pointer-events: none;  /* Disable clicking */
}

pre, code {
    background: var(--code-bg);
    border: 1px solid var(--code-border);
    border-radius: 4px;
    font-family: Consolas, Monaco, 'Courier New', monospace;
}

pre {
    padding: 12px;
    overflow-x: auto;
}

code {
    padding: 2px 6px;
}

table {
    border-collapse: collapse;
    width: 100%;
    margin: 16px 0;
}

th, td {
    border: 1px solid var(--table-border);
    padding: 8px 12px;
    text-align: left;
}

th {
    background: var(--code-bg);
}

blockquote {
    border-left: 4px solid var(--link-color);
    margin: 16px 0;
    padding-left: 16px;
    color: var(--text-color);
    opacity: 0.8;
}

.mermaid-diagram {
    text-align: center;
    margin: 16px 0;
}

.mermaid-error {
    background: #4a2d2d;
    border: 1px solid #5a3d3d;
    color: #f44747;
    padding: 12px;
    border-radius: 4px;
    margin: 16px 0;
}

img {
    max-width: 100%;
    height: auto;
}

/* Placeholder for external images */
img[src^="http"] {
    display: none;
}
img[src^="http"]::after {
    content: "[External image blocked]";
    display: block;
    padding: 20px;
    background: var(--code-bg);
    text-align: center;
}
```

### Theme Integration

```javascript
function wrapWithStyles(html, isDark) {
    const colors = isDark ? {
        bgColor: '#1e1e1e',
        textColor: '#d4d4d4',
        headingColor: '#569cd6',
        // ...
    } : {
        bgColor: '#f5f5f5',
        textColor: '#1e1e1e',
        headingColor: '#0066cc',
        // ...
    };

    return `
        <!DOCTYPE html>
        <html>
        <head>
            <style>
                :root {
                    --bg-color: ${colors.bgColor};
                    --text-color: ${colors.textColor};
                    --heading-color: ${colors.headingColor};
                }
                /* ... rest of CSS ... */
            </style>
        </head>
        <body>${html}</body>
        </html>
    `;
}
```

### View Toggle UI

```qml
// In Toolbar.qml or OutputPane.qml
Row {
    spacing: 4

    ToolButton {
        text: "Code"
        checked: outputPane.viewMode === "code"
        onClicked: outputPane.viewMode = "code"
    }

    ToolButton {
        text: "Tree"
        visible: outputPane.format === "json" || outputPane.format === "xml"
        checked: outputPane.viewMode === "tree"
        onClicked: outputPane.viewMode = "tree"
    }

    ToolButton {
        text: "Preview"
        visible: outputPane.format === "markdown"
        checked: outputPane.viewMode === "preview"
        onClicked: outputPane.viewMode = "preview"
    }
}
```

## Testing

### Test Location
- QML testing: Manual in browser
- Visual regression: Screenshot comparison

### Test Cases

| Scenario | Expected | Notes |
|----------|----------|-------|
| Simple Markdown | Renders headings, paragraphs | Basic |
| GFM Table | Table with borders, alignment | Tables |
| Code block | Styled background, monospace | Code |
| Mermaid diagram | SVG displays correctly | Diagrams |
| External link | Displayed but not clickable | Security |
| External image | Placeholder shown | Security |
| Theme toggle | Colors update correctly | Theming |
| Large document | Smooth scrolling | Performance |
| Copy button | Copies HTML source | Functionality |

### Manual Test Procedure

1. Paste Markdown content with:
   - Various heading levels
   - A table
   - A code block
   - A Mermaid diagram
   - A link
2. Verify Preview mode renders correctly
3. Toggle to Code view, verify raw HTML shown
4. Toggle theme, verify preview updates
5. Click Copy, verify HTML copied to clipboard
6. Try clicking a link, verify it does nothing

## Definition of Done

- [ ] All acceptance criteria met
- [ ] All tasks completed
- [ ] Preview mode displays HTML correctly
- [ ] Mermaid diagrams render inline
- [ ] Theme colors applied
- [ ] Links not clickable (security)
- [ ] Copy functionality works
- [ ] Performance acceptable for large docs
- [ ] View toggle works correctly

## Dependencies

- **Depends on:** 10.3 (Bridge Layer provides HTML)
- **Blocks:** 10.8 (Integration Testing)

## Estimate

3 points

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-28 | 1.0 | Story created from Epic 10.0 | Sarah (PO) |
