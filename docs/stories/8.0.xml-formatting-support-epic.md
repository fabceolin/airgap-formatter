# Epic 8.0: XML Formatting Support

## Status: Approved

## Epic Summary

**As a** user of the Airgap JSON Formatter,
**I want** to format and view XML content with the same quality experience as JSON,
**so that** I can use a single trusted, offline tool for both common data interchange formats.

## Background

The spike investigation (7.0) validated technical feasibility:
- **Library:** `quick-xml v0.37` - WASM-compatible, no network dependencies
- **Bundle Impact:** +58KB (well under 200KB threshold)
- **PoC Delivered:** `xml_formatter.rs` (194 lines), `xml_highlighter.rs` (320 lines)
- **Recommendation:** PROCEED with caveats

See: `docs/stories/7.0.spike-report.md` for complete findings.

## Epic Goals

1. **Auto-detect format** - Automatically identify JSON vs XML from pasted content
2. **Format/Minify XML** - Full formatting support matching JSON capabilities
3. **Syntax Highlighting** - Color-coded XML display in Code view
4. **Tree View** - Collapsible XML structure view
5. **Seamless UX** - No mode switching required; format detected automatically

## Existing System Context

| Component | Current State | XML Integration Point |
|-----------|---------------|----------------------|
| **Rust Core** | `formatter.rs`, `highlighter.rs` | Add parallel `xml_*.rs` modules |
| **WASM Exports** | `formatJson`, `highlightJson` | Add `formatXml`, `highlightXml` |
| **JsonBridge** | JSON-specific methods | Add XML methods + format dispatch |
| **Toolbar.qml** | Indent selector only | Add format indicator/selector |
| **Main.qml** | Assumes JSON | Track detected/selected format |
| **Tree Model** | `QJsonTreeModel` | Create parallel `QXmlTreeModel` |

## Technical Approach

### Format Auto-Detection

```cpp
QString detectFormat(const QString &input) {
    QString trimmed = input.trimmed();
    if (trimmed.startsWith('<')) return "xml";
    if (trimmed.startsWith('{') || trimmed.startsWith('[')) return "json";
    return "unknown";
}
```

Auto-detect on paste/input, allow manual override via toolbar.

### Architecture Pattern

Follow existing patterns:
- **Rust:** Parallel modules (`xml_formatter.rs` mirrors `formatter.rs`)
- **Bridge:** Parallel methods (not parameterized) for clarity
- **QML:** Format-aware routing based on detected/selected format

## Stories

### 8.1: Productionize XML Formatter
**Goal:** Harden spike PoC for production use
- Refactor to extract shared event-handling logic
- Add comprehensive error handling with line/column positions
- Expand test coverage (edge cases, malformed XML)
- **Depends on:** None (PoC exists)
- **Estimate:** 2 points

### 8.2: Productionize XML Highlighter
**Goal:** Harden spike PoC for production use
- Review state machine for edge cases
- Add tests for malformed/partial XML
- Ensure XSS protection (HTML escaping)
- **Depends on:** None (PoC exists)
- **Estimate:** 2 points

### 8.3: Bridge Layer XML Methods
**Goal:** Expose XML functionality to QML
- Add `formatXml()`, `minifyXml()`, `highlightXml()` to JsonBridge
- Add corresponding signals for async completion
- Integrate with AsyncSerialiser pattern
- **Depends on:** 8.1, 8.2
- **Estimate:** 2 points

### 8.4: Format Auto-Detection
**Goal:** Automatically detect JSON vs XML from input
- Implement detection logic in bridge layer
- Detect on paste and on Format button click
- Emit `formatDetected(QString format)` signal
- Handle "unknown" format gracefully
- **Depends on:** 8.3
- **Estimate:** 2 points

### 8.5: Toolbar Format Selector
**Goal:** Add format indicator with manual override
- Display detected format (JSON/XML/Unknown)
- Allow manual format selection
- Update Format/Minify buttons to route correctly
- Style consistent with existing toolbar
- **Depends on:** 8.4
- **Estimate:** 2 points

### 8.6: XML Tree Model
**Goal:** Enable tree view for XML content
- Create `QXmlTreeModel` + `QXmlTreeItem` classes
- Handle XML-specific structure (attributes, namespaces)
- Wire to existing TreeView.qml with format-aware loading
- **Depends on:** 8.3
- **Estimate:** 5 points

### 8.7: Integration Testing
**Goal:** End-to-end validation of XML workflows
- Test auto-detection accuracy
- Test format/minify/highlight for various XML types
- Test tree view expand/collapse
- Test Code view syntax highlighting
- Cross-browser validation
- Regression testing (ensure JSON still works)
- **Depends on:** 8.1-8.6
- **Estimate:** 3 points

## Story Dependencies

```
8.1 ──┬──→ 8.3 ──→ 8.4 ──→ 8.5
8.2 ──┘              │
                     └──→ 8.6
                           │
All ────────────────────→ 8.7
```

**Parallelization:**
- 8.1 and 8.2 can run in parallel
- 8.6 can run in parallel with 8.4-8.5 (after 8.3)
- 8.7 requires all stories complete

## Effort Summary

| Story | Points | Description |
|-------|--------|-------------|
| 8.1 | 2 | Productionize XML Formatter |
| 8.2 | 2 | Productionize XML Highlighter |
| 8.3 | 2 | Bridge Layer XML Methods |
| 8.4 | 2 | Format Auto-Detection |
| 8.5 | 2 | Toolbar Format Selector |
| 8.6 | 5 | XML Tree Model |
| 8.7 | 3 | Integration Testing |
| **Total** | **18** | |

**Estimated Duration:** 10-17 days (from spike report)

## Risks & Mitigations

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Mixed content whitespace | Medium | Medium | Document opinionated behavior |
| XML tree complexity | Medium | Low | PoC validates quick-xml handles structure |
| Detection false positives | Low | Low | Allow manual override |
| Bundle size creep | Low | Low | Already measured at +58KB |

## Out of Scope

- XML validation against DTD/XSD
- XML Schema editing
- XSLT transformation
- XPath query support

## Acceptance Criteria (Epic Level)

1. User can paste XML and it's automatically detected
2. Format and Minify work correctly for XML
3. Code view shows syntax-highlighted XML
4. Tree view shows collapsible XML structure
5. User can manually switch between JSON/XML mode
6. All existing JSON functionality continues to work
7. WASM bundle size increase is under 100KB total

## Definition of Done

- [ ] All 7 stories completed and QA-passed
- [ ] Cross-browser testing complete (Chrome, Firefox, Safari, Edge)
- [ ] No regression in JSON functionality
- [ ] Documentation updated (if user-facing changes)
- [ ] Bundle size verified under threshold

## References

- Spike Report: `docs/stories/7.0.spike-report.md`
- Spike Story: `docs/stories/7.0.spike-xml-formatting-feasibility.md`
- PoC Code: `src/xml_formatter.rs`, `src/xml_highlighter.rs`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-26 | 1.0 | Epic created from spike findings | Sarah (PO) |
