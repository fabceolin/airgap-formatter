# Story 8.2: Productionize XML Highlighter

## Status: Approved

## Story

**As a** user viewing XML content in Code view,
**I want** syntax-highlighted XML with consistent colors,
**so that** I can easily read and understand the structure of my XML data.

## Acceptance Criteria

1. All XML token types are correctly highlighted (tags, attributes, values, comments, CDATA, declarations)
2. Colors are consistent with VS Code dark theme palette
3. Malformed/partial XML degrades gracefully without crashing
4. HTML output is properly escaped to prevent XSS
5. Performance is acceptable for large documents (>100KB)
6. State machine handles all edge cases documented in spike
7. WASM build succeeds with no new warnings

## Tasks / Subtasks

- [ ] Task 1: Review and harden state machine (AC: 6)
  - [ ] Audit all state transitions for edge cases
  - [ ] Handle unclosed tags gracefully (don't infinite loop)
  - [ ] Handle unclosed comments gracefully
  - [ ] Handle unclosed CDATA gracefully
  - [ ] Handle unclosed attribute values gracefully
  - [ ] Add `State::Error` or graceful fallback for malformed input

- [ ] Task 2: Add malformed XML tests (AC: 3)
  - [ ] Test: Unclosed tag `<root` (no `>`)
  - [ ] Test: Unclosed comment `<!-- comment`
  - [ ] Test: Unclosed CDATA `<![CDATA[data`
  - [ ] Test: Unclosed attribute value `<a b="value`
  - [ ] Test: Incomplete entity `&amp` (no semicolon)
  - [ ] Test: Empty input returns empty string
  - [ ] All tests should return valid HTML (degraded but not crashed)

- [ ] Task 3: Verify XSS protection (AC: 4)
  - [ ] Audit `push_colored_escaped()` function
  - [ ] Test: Input containing `<script>` is escaped
  - [ ] Test: Input containing `onclick=` is escaped
  - [ ] Test: All HTML special chars escaped (`<`, `>`, `&`, `"`, `'`)

- [ ] Task 4: Performance testing (AC: 5)
  - [ ] Add benchmark test with 100KB XML document
  - [ ] Verify highlighting completes in < 100ms
  - [ ] Profile memory usage (should be ~3x input size)

- [ ] Task 5: Update documentation (AC: 1, 2)
  - [ ] Update module doc from "State machine implementation" to production description
  - [ ] Document color palette with token type mapping
  - [ ] Document graceful degradation behavior

- [ ] Task 6: Verify WASM build (AC: 7)
  - [ ] Run `wasm-pack build --target web --release`
  - [ ] Confirm no new compiler warnings
  - [ ] Verify `highlightXml` WASM export works

## Dev Notes

### Relevant Source Tree

```
src/
├── xml_highlighter.rs  # TARGET FILE - harden state machine
├── highlighter.rs      # REFERENCE - JSON highlighter (same pattern)
└── lib.rs              # WASM export: js_highlight_xml
```

### Current State (from Spike 7.0)

The PoC `xml_highlighter.rs` (320 lines) has:
- 12 states: Text, TagOpen, TagName, TagClose, InTag, AttrName, AttrEquals, AttrValue, Comment, Cdata, Declaration, Doctype
- 8 passing tests covering happy path
- Color palette matching VS Code dark theme

### Potential Edge Cases to Handle

| Input | Current Behavior | Expected Behavior |
|-------|------------------|-------------------|
| `<root` (unclosed) | Unknown | Return partial highlight, don't crash |
| `<!-- comment` (unclosed) | Unknown | Highlight as comment to end |
| `<![CDATA[data` (unclosed) | Unknown | Highlight as CDATA to end |
| `<a b="value` (unclosed attr) | Unknown | Highlight value to end |

### Color Palette (from PoC)

```rust
mod colors {
    pub const TAG: &str = "#569cd6";           // Blue - tag names
    pub const ATTR_NAME: &str = "#9cdcfe";     // Light blue - attribute names
    pub const ATTR_VALUE: &str = "#ce9178";    // Orange - attribute values
    pub const TEXT: &str = "#d4d4d4";          // Gray - text content
    pub const COMMENT: &str = "#6a9955";       // Green - comments
    pub const CDATA: &str = "#dcdcaa";         // Yellow - CDATA
    pub const DECLARATION: &str = "#c586c0";   // Purple - XML declarations
    pub const BRACKET: &str = "#808080";       // Gray - < > brackets
    pub const ENTITY: &str = "#d7ba7d";        // Gold - entities like &amp;
}
```

### XSS Protection

The `push_colored_escaped()` function must escape:
- `<` → `&lt;`
- `>` → `&gt;`
- `&` → `&amp;`
- `"` → `&quot;`

Current implementation (lines 349-363) does this correctly.

## Testing

### Test Location
- File: `src/xml_highlighter.rs` (inline `#[cfg(test)] mod tests`)

### Test Standards
- Use `#[test]` attribute for unit tests
- Test both valid and malformed inputs
- Verify HTML output is valid (contains `<pre>`, `<span>`, proper escaping)

### Required Test Cases

| Category | Test | Expected |
|----------|------|----------|
| Malformed | Unclosed tag `<root` | Valid HTML, partial highlight |
| Malformed | Unclosed comment | Highlight to end as comment |
| Malformed | Unclosed CDATA | Highlight to end as CDATA |
| XSS | `<script>alert(1)</script>` | Escaped, not executable |
| XSS | `<a onclick="x">` | Escaped attribute |
| Performance | 100KB XML | < 100ms |
| Edge | Empty string | Empty string returned |

### Running Tests
```bash
cargo test xml_highlighter
cargo test xml_highlighter -- --nocapture
```

## Definition of Done

- [ ] All acceptance criteria met
- [ ] All tasks completed
- [ ] All tests passing (existing + new)
- [ ] WASM build succeeds
- [ ] No new compiler warnings

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-26 | 1.0 | Story created from Epic 8.0 | Sarah (PO) |
