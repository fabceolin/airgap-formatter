# Story 1.2: Core JSON Formatting Module

## Status: Ready for Review

## Story

**As a** user,
**I want** to format JSON with configurable indentation,
**so that** I can read and understand complex JSON structures.

## Acceptance Criteria

1. Rust module `json_formatter` implements `format_json(input: &str, indent: IndentStyle) -> Result<String, FormatError>`
2. `IndentStyle` enum supports `Spaces(u8)` and `Tabs` variants
3. Function correctly formats valid JSON with proper indentation and newlines
4. Function returns descriptive error with line/column position for invalid JSON
5. Unit tests cover: valid JSON formatting, various indent styles, nested objects/arrays, edge cases (empty object, empty array, unicode)
6. Performance benchmark confirms <100ms for 1MB JSON input

## Tasks / Subtasks

- [x] Task 1: Create types module with core data types (AC: 2, 4)
  - [x] Create `src/types.rs`
  - [x] Implement `IndentStyle` enum with `Spaces(u8)` and `Tabs` variants
  - [x] Implement `Default` for `IndentStyle` (4 spaces)
  - [x] Implement `FormatError` struct with `message`, `line`, `column`
  - [x] Implement `Display` trait for `FormatError`
  - [x] Derive appropriate traits (Clone, Debug, PartialEq)

- [x] Task 2: Create formatter module with format_json function (AC: 1, 3)
  - [x] Create `src/formatter.rs`
  - [x] Implement `format_json(input: &str, indent: IndentStyle) -> Result<String, FormatError>`
  - [x] Use serde_json for parsing
  - [x] Implement custom formatting with proper indentation
  - [x] Handle all JSON value types (objects, arrays, strings, numbers, booleans, null)

- [x] Task 3: Implement error handling with position info (AC: 4)
  - [x] Convert serde_json errors to FormatError with line/column
  - [x] Ensure error messages are human-readable
  - [x] Test error positions are accurate

- [x] Task 4: Update lib.rs to export modules (AC: 1)
  - [x] Add mod declarations for types and formatter
  - [x] Re-export public types

- [x] Task 5: Write comprehensive unit tests (AC: 5)
  - [x] Create `src/tests/formatter_tests.rs`
  - [x] Test simple object formatting
  - [x] Test nested objects and arrays
  - [x] Test all indent styles (2 spaces, 4 spaces, tabs)
  - [x] Test empty object `{}`
  - [x] Test empty array `[]`
  - [x] Test unicode characters in strings
  - [x] Test special characters and escaping
  - [x] Test invalid JSON error handling

- [x] Task 6: Performance benchmark for 1MB JSON (AC: 6)
  - [x] Create benchmark test
  - [x] Generate or use sample 1MB JSON
  - [x] Verify formatting completes in <100ms
  - [x] Document performance characteristics

## Dev Notes

### Module Structure
```
src/
├── lib.rs           # Module exports
├── types.rs         # IndentStyle, FormatError
├── formatter.rs     # format_json function
└── tests/
    └── formatter_tests.rs
```

### Type Definitions

```rust
// src/types.rs
#[derive(Clone, Copy, Debug, PartialEq)]
pub enum IndentStyle {
    Spaces(u8),  // Number of spaces (typically 2 or 4)
    Tabs,
}

impl Default for IndentStyle {
    fn default() -> Self {
        IndentStyle::Spaces(4)
    }
}

#[derive(Clone, Debug)]
pub struct FormatError {
    pub message: String,
    pub line: usize,
    pub column: usize,
}
```

### Formatting Implementation Notes
- Use `serde_json::from_str` to parse JSON
- Convert serde_json Error to FormatError using `.line()` and `.column()` methods
- Build formatted output string with proper indentation per level
- Handle trailing comma/newline rules for JSON

### Critical Architecture Rules
- **Zero Network Calls:** Never use fetch, XMLHttpRequest, WebSocket
- **No Persistent Storage:** Never use localStorage, sessionStorage, IndexedDB
- **Error Handling:** All public functions must return Result types. Never panic in WASM code.

### Testing

**Test Location:** `src/tests/formatter_tests.rs`

**Testing Framework:** cargo test

**Test Commands:**
```bash
cargo test formatter
cargo test --release  # For performance tests
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-20 | 1.0 | Initial story creation | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
None - no blocking issues encountered

### Completion Notes List
- Created src/types.rs with IndentStyle enum and FormatError struct
- Created src/formatter.rs with format_json function
- Implemented recursive JSON formatting with proper indentation for all value types
- Error handling converts serde_json errors to FormatError with line/column
- Updated lib.rs with module exports and re-exports
- Created src/tests/mod.rs and src/tests/formatter_tests.rs with 34 comprehensive tests
- Performance benchmark: 1.4MB JSON formatted in 29ms (well under 100ms requirement)
- All 34 tests pass

### File List
- src/types.rs (new)
- src/formatter.rs (new)
- src/lib.rs (modified)
- src/tests/mod.rs (new)
- src/tests/formatter_tests.rs (new)

---

## QA Results
*To be filled by QA agent*
