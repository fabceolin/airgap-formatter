# Story 8.5: Toolbar Format Selector

## Status: Approved

## Story

**As a** user of the formatter,
**I want** to see the detected format and manually override it if needed,
**so that** I can control how my content is processed when auto-detection is wrong.

## Acceptance Criteria

1. Format indicator shows current detected format (JSON/XML/Unknown)
2. Format can be manually selected via dropdown
3. Manual selection overrides auto-detection
4. Visual styling matches existing toolbar components
5. Format selection persists until input changes or manual clear
6. Tooltip explains auto-detection and override behavior
7. Keyboard accessible (Tab navigation, Enter to select)

## Tasks / Subtasks

- [ ] Task 1: Add format ComboBox to Toolbar.qml (AC: 1, 2, 4)
  - [ ] Create ComboBox with model: ["Auto", "JSON", "XML"]
  - [ ] Position before indent selector
  - [ ] Style to match `indentCombo` component
  - [ ] Set default to "Auto"

- [ ] Task 2: Connect to detected format (AC: 1, 3)
  - [ ] Add property `property string detectedFormat: "json"` to toolbar
  - [ ] Bind display text to show detected format when "Auto" selected
  - [ ] Show "JSON (auto)" or "XML (auto)" in Auto mode

- [ ] Task 3: Implement manual override (AC: 3, 5)
  - [ ] Track `manualFormatOverride` state
  - [ ] When user selects JSON/XML, set override
  - [ ] When "Auto" selected, clear override
  - [ ] Reset to "Auto" when input cleared

- [ ] Task 4: Add format signal to toolbar (AC: 1)
  - [ ] Add signal `formatSelected(string format)`
  - [ ] Emit when format changes (auto-detected or manual)
  - [ ] Main.qml connects to update routing

- [ ] Task 5: Add tooltip (AC: 6)
  - [ ] Add ToolTip to format ComboBox
  - [ ] Text: "Format is auto-detected. Select manually to override."
  - [ ] ToolTip.delay: 500 (match other buttons)

- [ ] Task 6: Ensure keyboard accessibility (AC: 7)
  - [ ] Verify Tab focuses the ComboBox
  - [ ] Verify Enter/Space opens dropdown
  - [ ] Verify arrow keys navigate options
  - [ ] Add focusPolicy: Qt.StrongFocus

- [ ] Task 7: Update Main.qml integration
  - [ ] Pass `detectedFormat` to toolbar
  - [ ] Listen to `formatSelected` signal
  - [ ] Use effective format (manual or detected) for operations

## Dev Notes

### Relevant Source Tree

```
qt/qml/
├── Toolbar.qml         # TARGET - add format selector
├── Main.qml            # Connect format to operations
└── Theme.qml           # Styling constants
```

### Existing ComboBox Pattern (indentCombo)

```qml
ComboBox {
    id: indentCombo
    model: ["2 spaces", "4 spaces", "Tab"]
    currentIndex: 1  // Default to 4 spaces

    // ... styling ...

    onCurrentTextChanged: {
        switch(currentIndex) {
            case 0: toolbar.selectedIndent = "spaces:2"; break;
            case 1: toolbar.selectedIndent = "spaces:4"; break;
            case 2: toolbar.selectedIndent = "tabs"; break;
        }
    }
}
```

### Format ComboBox Design

```qml
ComboBox {
    id: formatCombo
    model: ["Auto", "JSON", "XML"]
    currentIndex: 0  // Default to Auto

    property string effectiveFormat: {
        if (currentIndex === 0) {
            // Auto mode - use detected format
            return toolbar.detectedFormat;
        } else if (currentIndex === 1) {
            return "json";
        } else {
            return "xml";
        }
    }

    // Display text shows detection result in Auto mode
    displayText: {
        if (currentIndex === 0) {
            var detected = toolbar.detectedFormat;
            if (detected === "unknown") return "Auto";
            return detected.toUpperCase() + " (auto)";
        }
        return currentText;
    }

    contentItem: Text {
        text: formatCombo.displayText
        color: Theme.textPrimary
        // ... styling ...
    }

    background: Rectangle {
        implicitWidth: 100
        implicitHeight: 34
        color: formatCombo.hovered ? Theme.backgroundSecondary : "transparent"
        border.color: formatCombo.activeFocus ? Theme.focusRing : Theme.border
        border.width: formatCombo.activeFocus ? Theme.focusRingWidth : 1
        radius: 4
    }

    ToolTip.visible: hovered
    ToolTip.text: "Format is auto-detected. Select manually to override."
    ToolTip.delay: 500

    onActivated: {
        toolbar.formatSelected(effectiveFormat);
    }
}
```

### Toolbar Signal Addition

```qml
Rectangle {
    id: toolbar

    signal formatRequested(string indentType)
    signal minifyRequested()
    // ... existing signals ...
    signal formatSelected(string format)  // NEW

    property string selectedIndent: "spaces:4"
    property string detectedFormat: "json"  // NEW - bound from Main.qml
    property string effectiveFormat: formatCombo.effectiveFormat  // NEW

    // ... rest of toolbar ...
}
```

### Main.qml Integration

```qml
Toolbar {
    id: toolbar
    detectedFormat: window.detectedFormat

    onFormatSelected: function(format) {
        console.log("Format selected:", format);
    }

    onFormatRequested: function(indentType) {
        var format = toolbar.effectiveFormat;
        if (format === "xml") {
            JsonBridge.formatXml(inputPane.text, indentType);
        } else {
            JsonBridge.formatJson(inputPane.text, indentType);
        }
    }

    onMinifyRequested: {
        var format = toolbar.effectiveFormat;
        if (format === "xml") {
            JsonBridge.minifyXml(inputPane.text);
        } else {
            JsonBridge.minifyJson(inputPane.text);
        }
    }
}
```

### Visual Layout

```
┌─────────────────────────────────────────────────────────────────────┐
│ [Load] [Clear]  │  [JSON (auto) ▼] [4 spaces ▼]  │  [Format] [Mini] │
│                 │     ↑ NEW                      │                  │
│  INPUT ZONE     │     FORMAT ZONE                │   ACTION ZONE    │
└─────────────────────────────────────────────────────────────────────┘
```

## Testing

### Test Cases

| Scenario | Action | Expected |
|----------|--------|----------|
| Auto + JSON input | Paste `{"a":1}` | Shows "JSON (auto)" |
| Auto + XML input | Paste `<root/>` | Shows "XML (auto)" |
| Auto + Unknown | Paste `hello` | Shows "Auto" |
| Manual JSON | Select "JSON" | Shows "JSON", uses JSON formatter |
| Manual XML | Select "XML" | Shows "XML", uses XML formatter |
| Override reset | Clear input | Returns to "Auto" |
| Keyboard | Tab to combo, Enter | Opens dropdown |

### Manual Testing
```
1. Open app
2. Paste JSON → Verify "JSON (auto)" appears
3. Paste XML → Verify "XML (auto)" appears
4. Select "XML" manually → Verify stays "XML"
5. Clear input → Verify returns to "Auto"
6. Tab to format selector → Verify focus ring
7. Press Enter → Verify dropdown opens
```

## Definition of Done

- [ ] All acceptance criteria met
- [ ] All tasks completed
- [ ] Format selector styled consistently
- [ ] Auto-detection display working
- [ ] Manual override working
- [ ] Keyboard accessible
- [ ] Tooltip present

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-26 | 1.0 | Story created from Epic 8.0 | Sarah (PO) |
