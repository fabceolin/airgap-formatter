# Story 8.7: Integration Testing

## Status: Approved

## Story

**As a** QA engineer,
**I want** comprehensive end-to-end tests for XML workflows,
**so that** we can confidently release the XML formatting feature.

## Acceptance Criteria

1. Auto-detection correctly identifies JSON vs XML in all tested cases
2. Format button produces correctly indented XML
3. Minify button produces compact XML
4. Syntax highlighting displays correct colors for all XML token types
5. Tree view displays XML structure with expandable nodes
6. Copy from tree view produces valid XML
7. All JSON functionality continues to work (regression)
8. Cross-browser testing passes (Chrome, Firefox, Safari, Edge)
9. No console errors during normal usage

## Tasks / Subtasks

- [ ] Task 1: Create integration test suite
  - [ ] Create `qt/tests/integration/tst_xml_integration.cpp`
  - [ ] Set up test fixtures with sample XML documents
  - [ ] Set up test fixtures with sample JSON documents (regression)

- [ ] Task 2: Auto-detection tests (AC: 1)
  - [ ] Test: JSON object detected correctly
  - [ ] Test: JSON array detected correctly
  - [ ] Test: XML element detected correctly
  - [ ] Test: XML with declaration detected correctly
  - [ ] Test: Content with BOM detected correctly
  - [ ] Test: Whitespace-prefixed content detected correctly

- [ ] Task 3: Format/Minify tests (AC: 2, 3)
  - [ ] Test: Format XML with 2-space indent
  - [ ] Test: Format XML with 4-space indent
  - [ ] Test: Format XML with tabs
  - [ ] Test: Minify XML removes whitespace
  - [ ] Test: Format preserves attributes
  - [ ] Test: Format preserves namespaces
  - [ ] Test: Format preserves CDATA
  - [ ] Test: Format preserves comments

- [ ] Task 4: Highlighter tests (AC: 4)
  - [ ] Test: Tags highlighted in blue
  - [ ] Test: Attributes highlighted in light blue
  - [ ] Test: Values highlighted in orange
  - [ ] Test: Comments highlighted in green
  - [ ] Test: CDATA highlighted in yellow
  - [ ] Test: Declarations highlighted in purple

- [ ] Task 5: Tree view tests (AC: 5, 6)
  - [ ] Test: Elements appear as expandable nodes
  - [ ] Test: Attributes appear with @ prefix
  - [ ] Test: Text content appears as leaf
  - [ ] Test: Expand/collapse works
  - [ ] Test: Copy element produces valid XML
  - [ ] Test: Copy attribute produces value

- [ ] Task 6: JSON regression tests (AC: 7)
  - [ ] Test: JSON format still works
  - [ ] Test: JSON minify still works
  - [ ] Test: JSON highlight still works
  - [ ] Test: JSON tree view still works
  - [ ] Test: JSON validation still works
  - [ ] Test: History (save/load) still works

- [ ] Task 7: Cross-browser testing (AC: 8, 9)
  - [ ] Test in Chrome (latest)
  - [ ] Test in Firefox (latest)
  - [ ] Test in Safari (latest)
  - [ ] Test in Edge (latest)
  - [ ] Document any browser-specific issues
  - [ ] Verify no console errors in any browser

- [ ] Task 8: Edge case testing
  - [ ] Test: Large XML (1MB)
  - [ ] Test: Deeply nested XML (100 levels)
  - [ ] Test: XML with many attributes (100+)
  - [ ] Test: Invalid XML shows error
  - [ ] Test: Mixed JSON/XML workflow (switch formats)

- [ ] Task 9: Create test report
  - [ ] Document all test results
  - [ ] List any known issues
  - [ ] Provide browser compatibility matrix
  - [ ] Sign off on release readiness

## Dev Notes

### Relevant Source Tree

```
qt/tests/
├── integration/
│   └── tst_xml_integration.cpp   # NEW - integration tests
├── tst_jsonbridge_async.cpp      # Existing - reference
└── CMakeLists.txt                # UPDATE - add integration tests

docs/qa/
└── test-plans/
    └── 8.7-xml-integration.md    # Test plan document
```

### Sample Test Documents

**Simple XML:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<root>
    <item id="1">First</item>
    <item id="2">Second</item>
</root>
```

**Complex XML (namespaces, CDATA, comments):**
```xml
<?xml version="1.0"?>
<ns:root xmlns:ns="http://example.com">
    <!-- Configuration section -->
    <ns:config enabled="true">
        <![CDATA[
            Special <characters> & "quotes"
        ]]>
    </ns:config>
</ns:root>
```

**Regression JSON:**
```json
{
    "name": "Test",
    "items": [1, 2, 3],
    "nested": {
        "key": "value"
    }
}
```

### Manual Test Script

```markdown
## XML Integration Manual Test

### Setup
1. Build latest WASM: `wasm-pack build && qt-wasm-build`
2. Deploy to local server: `python -m http.server 8080`
3. Open each browser to http://localhost:8080

### Auto-Detection Tests
1. [ ] Paste `{"a":1}` → Format selector shows "JSON (auto)"
2. [ ] Paste `<root/>` → Format selector shows "XML (auto)"
3. [ ] Clear → Format selector shows "Auto"

### Format Tests
1. [ ] Paste minified XML → Click Format → Properly indented
2. [ ] Change indent to "2 spaces" → Click Format → 2-space indent
3. [ ] Change indent to "Tab" → Click Format → Tab indent
4. [ ] Click Minify → All whitespace removed

### Highlight Tests
1. [ ] Switch to Code view
2. [ ] Tags are blue
3. [ ] Attributes are light blue
4. [ ] Values are orange
5. [ ] Comments are green

### Tree View Tests
1. [ ] Switch to Tree view
2. [ ] Elements are expandable
3. [ ] Attributes show @prefix
4. [ ] Right-click → Copy works

### JSON Regression Tests
1. [ ] Paste JSON → Format works
2. [ ] Paste JSON → Minify works
3. [ ] Paste JSON → Tree view works
4. [ ] Save to history → Load from history works

### Browser Matrix
| Test | Chrome | Firefox | Safari | Edge |
|------|--------|---------|--------|------|
| Format XML | [ ] | [ ] | [ ] | [ ] |
| Minify XML | [ ] | [ ] | [ ] | [ ] |
| Highlight | [ ] | [ ] | [ ] | [ ] |
| Tree View | [ ] | [ ] | [ ] | [ ] |
| JSON Regression | [ ] | [ ] | [ ] | [ ] |
| No Console Errors | [ ] | [ ] | [ ] | [ ] |
```

### Integration Test Code Pattern

```cpp
class XmlIntegrationTest : public QObject
{
    Q_OBJECT

private slots:
    void initTestCase() {
        // Initialize JsonBridge, wait for WASM ready
    }

    void testAutoDetection_data() {
        QTest::addColumn<QString>("input");
        QTest::addColumn<QString>("expectedFormat");

        QTest::newRow("json-object") << "{\"a\":1}" << "json";
        QTest::newRow("json-array") << "[1,2,3]" << "json";
        QTest::newRow("xml-element") << "<root/>" << "xml";
        QTest::newRow("xml-declaration") << "<?xml version=\"1.0\"?><r/>" << "xml";
    }

    void testAutoDetection() {
        QFETCH(QString, input);
        QFETCH(QString, expectedFormat);

        QString detected = m_bridge->detectFormat(input);
        QCOMPARE(detected, expectedFormat);
    }

    void testXmlFormat() {
        QString input = "<root><child/></root>";
        QSignalSpy spy(m_bridge, &JsonBridge::formatXmlCompleted);

        m_bridge->formatXml(input, "spaces:2");

        QVERIFY(spy.wait(5000));
        QVariantMap result = spy.first().first().toMap();
        QVERIFY(result["success"].toBool());
        QVERIFY(result["result"].toString().contains("\n"));
    }

    void testJsonRegression() {
        QString input = "{\"key\":\"value\"}";
        QSignalSpy spy(m_bridge, &JsonBridge::formatCompleted);

        m_bridge->formatJson(input, "spaces:2");

        QVERIFY(spy.wait(5000));
        QVariantMap result = spy.first().first().toMap();
        QVERIFY(result["success"].toBool());
    }

private:
    JsonBridge* m_bridge;
};
```

## Testing

This story IS the testing task. Success criteria:

| Category | Pass Criteria |
|----------|---------------|
| Auto-detection | 100% of test cases pass |
| Format/Minify | All XML constructs preserved |
| Highlighting | All token types colored |
| Tree View | Navigate and copy work |
| Regression | All JSON tests pass |
| Browsers | Chrome, Firefox, Safari, Edge |
| Console | Zero errors |

### Running Tests
```bash
# Automated tests
cd qt/build
cmake .. && make
./tests/tst_xml_integration

# Cross-browser manual tests
# See Manual Test Script above
```

## Definition of Done

- [ ] All acceptance criteria met
- [ ] All automated tests pass
- [ ] Cross-browser testing complete
- [ ] No console errors
- [ ] JSON regression verified
- [ ] Test report documented
- [ ] Sign-off for release

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-26 | 1.0 | Story created from Epic 8.0 | Sarah (PO) |
