# Risk Profile: Story 5.1 - AsyncSerialiser C++ Implementation

Date: 2026-01-26
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 7
- Critical Risks: 0
- High Risks: 2
- Risk Score: 78/100

## Risk Matrix

| Risk ID   | Description                                          | Probability | Impact     | Score | Priority |
|-----------|------------------------------------------------------|-------------|------------|-------|----------|
| TECH-001  | QFuture/QPromise behavior differs in WASM vs native  | Medium (2)  | High (3)   | 6     | High     |
| TECH-002  | QMetaObject::invokeMethod fails in WASM context      | Low (1)     | High (3)   | 3     | Low      |
| TECH-003  | QTimer inconsistent in WASM event loop               | Medium (2)  | High (3)   | 6     | High     |
| TECH-004  | Singleton initialization order issues                | Low (1)     | Medium (2) | 2     | Low      |
| OPS-001   | Watchdog timeout too short for slow devices          | Medium (2)  | Medium (2) | 4     | Medium   |
| DATA-001  | Memory leak from orphaned QFutureWatcher             | Low (1)     | Medium (2) | 2     | Low      |
| TECH-005  | Reentrancy in processNext() during signal emission   | Low (1)     | High (3)   | 3     | Low      |

## Critical/High Risks Requiring Attention

### TECH-001: QFuture/QPromise Behavior in WASM

**Score: 6 (High)**
**Probability**: Medium - Qt documentation warns of WebAssembly differences
**Impact**: High - Core functionality depends on QFuture completion signals

**Mitigation**:
- Test QFuture/QPromise specifically in WASM environment before other work
- Have fallback to callback pattern documented
- Verify QFutureWatcher::finished signal fires correctly in WASM

**Testing Focus**:
- Unit test QFuture creation and completion in WASM build
- Verify signal-slot connections work across Asyncify suspension

### TECH-003: QTimer in WASM Event Loop

**Score: 6 (High)**
**Probability**: Medium - Browser event loop differs from native Qt event loop
**Impact**: High - Watchdog timer is critical safety mechanism

**Mitigation**:
- Test QTimer behavior in WASM specifically
- Consider using Emscripten's `emscripten_set_timeout` as backup
- Log timer start/stop for debugging

**Testing Focus**:
- Verify 30-second watchdog actually triggers in WASM
- Test rapid timer start/stop doesn't cause issues

## Medium Risks

### OPS-001: Watchdog Timeout Duration

**Score: 4 (Medium)**
**Probability**: Medium - Mobile and low-power devices may be slower
**Impact**: Medium - Premature timeout would abort valid operations

**Mitigation**:
- 30 seconds should be conservative enough
- Consider making timeout configurable in future
- Log when watchdog triggers for diagnostics

## Low Risks

### TECH-002: QMetaObject::invokeMethod in WASM

**Score: 3 (Low)**
**Probability**: Low - Qt officially supports this in WASM
**Impact**: High - Task scheduling depends on queued invocation

**Mitigation**: Use `Qt::QueuedConnection` flag explicitly as designed

### TECH-004: Singleton Initialization Order

**Score: 2 (Low)**
**Probability**: Low - Meyer's singleton pattern is thread-safe since C++11
**Impact**: Medium - Early access before initialization could crash

**Mitigation**: Document that singleton should only be accessed after Qt event loop starts

### TECH-005: Reentrancy Issues

**Score: 3 (Low)**
**Probability**: Low - Design uses QueuedConnection to prevent this
**Impact**: High - Reentrancy could corrupt queue state

**Mitigation**: The `m_isBusy` guard and `Qt::QueuedConnection` prevent reentrancy by design

### DATA-001: Memory Leak from QFutureWatcher

**Score: 2 (Low)**
**Probability**: Low - deleteLater() pattern is correct
**Impact**: Medium - Accumulating watchers would exhaust memory

**Mitigation**: Code already uses deleteLater(); add unit test to verify cleanup

## Risk Distribution

### By Category
- Technical: 5 risks (0 critical, 2 high)
- Operational: 1 risk (0 critical, 0 high)
- Data: 1 risk (0 critical, 0 high)
- Security: 0 risks
- Performance: 0 risks
- Business: 0 risks

### By Component
- AsyncSerialiser Core: 5 risks
- Timer/Watchdog: 2 risks
- CMake/Build: 0 risks

## Risk-Based Testing Strategy

### Priority 1: High Risk Tests
1. **WASM QFuture Test**: Create and complete a QFuture in WASM, verify signal fires
2. **WASM QTimer Test**: Start timer, verify callback executes after expected duration
3. **Cross-Target Verification**: Same tests must pass on both native and WASM

### Priority 2: Medium Risk Tests
1. **Watchdog Trigger Test**: Simulate stuck task, verify watchdog aborts it
2. **Timeout Measurement**: Measure actual timeout accuracy in WASM

### Priority 3: Standard Functional Tests
1. **Single-Task Execution**: Enqueue one task, verify completion
2. **FIFO Ordering**: Enqueue multiple tasks, verify execution order
3. **Error Recovery**: Task throws exception, verify queue continues
4. **Memory Cleanup**: Run many tasks, verify no watcher accumulation

## Risk Acceptance Criteria

### Must Fix Before Production
- All high risks (TECH-001, TECH-003) must have verified mitigations
- Unit tests must prove QFuture and QTimer work in WASM

### Can Deploy with Mitigation
- Medium risks (OPS-001) acceptable with monitoring/logging
- Low risks acceptable as documented

### Accepted Risks
- TECH-005 (reentrancy) - Design prevents this; accept with existing guards

## Monitoring Requirements

Post-deployment monitoring for:
- Watchdog trigger frequency (should be rare)
- Queue length peaks (should not grow unbounded)
- Task completion times (baseline for future comparison)

## Risk Review Triggers

Review and update risk profile when:
- Testing reveals QFuture/QTimer issues in WASM
- Watchdog triggers unexpectedly in production
- New async operations added to queue

---

## Gate YAML Block

```yaml
# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 0
    high: 2
    medium: 1
    low: 4
  highest:
    id: TECH-001
    score: 6
    title: 'QFuture/QPromise behavior differs in WASM vs native'
  recommendations:
    must_fix:
      - 'Verify QFuture/QPromise completion signals work in WASM before integration'
      - 'Test QTimer watchdog actually fires in WASM environment'
    monitor:
      - 'Log watchdog triggers for post-deployment analysis'
      - 'Track queue length peaks during user sessions'
```

---

Risk profile: docs/qa/assessments/5.1-risk-20260126.md
