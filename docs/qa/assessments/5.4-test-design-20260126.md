# Test Design: Story 5.4 - JSPI Feature Detection and Future-Proofing

**Date:** 2026-01-26
**Designer:** Quinn (Test Architect)
**Story:** docs/stories/5.4.jspi-future-proofing.md

## Test Strategy Overview

- **Total test scenarios:** 18
- **Unit tests:** 6 (33%)
- **Integration tests:** 6 (33%)
- **E2E tests:** 6 (34%)
- **Priority distribution:** P0: 2, P1: 10, P2: 6

### Rationale

This story is **optional and additive** - it prepares for future JSPI browser support without modifying production code paths. Test strategy prioritizes:

1. **Detection accuracy** - Core functionality must work across all browsers
2. **Build system integrity** - Both Asyncify and JSPI builds must succeed
3. **No regression** - Existing functionality must remain unchanged
4. **Documentation validity** - Browser support info must be accurate

## Test Scenarios by Acceptance Criteria

### AC 1-4: Feature Detection

**Requirements:**
- AC1: Runtime detects if browser supports JSPI
- AC2: Detection result exposed to both JS and C++ layers
- AC3: Detection doesn't cause errors on unsupported browsers
- AC4: Detection runs during application initialization

| ID | Level | Priority | Test Scenario | Justification | Mitigates |
|----|-------|----------|---------------|---------------|-----------|
| 5.4-UNIT-001 | Unit | P1 | `jspi-detect.js` returns `true` when `WebAssembly.Suspending` exists | Pure detection logic, no browser needed with mocks | TECH-001 |
| 5.4-UNIT-002 | Unit | P1 | `jspi-detect.js` returns `false` when `WebAssembly.Suspending` undefined | Fallback logic isolation | TECH-001 |
| 5.4-UNIT-003 | Unit | P1 | `jspi-detect.js` catches exceptions and returns `false` | Error handling in try-catch block | TECH-001 |
| 5.4-INT-001 | Integration | P0 | Detection script sets `window.JSPI_AVAILABLE` correctly in Chrome 137+ | Critical cross-layer integration | TECH-001 |
| 5.4-INT-002 | Integration | P1 | Detection script sets `window.JSPI_AVAILABLE = false` in Firefox | Cross-browser validation | TECH-001 |
| 5.4-INT-003 | Integration | P1 | Detection script sets `window.JSPI_AVAILABLE = false` in Safari | Cross-browser validation | TECH-001 |
| 5.4-E2E-001 | E2E | P1 | Console shows `[JSPI Detection] JSPI available: true` in Chrome 137+ | Full initialization flow | - |
| 5.4-E2E-002 | E2E | P1 | Console shows `[JSPI Detection] JSPI available: false` in Firefox gracefully (no errors) | Full initialization, no console errors | TECH-001 |

### AC 5-7: Build Configuration

**Requirements:**
- AC5: CMakeLists.txt has JSPI build option (disabled by default)
- AC6: Documentation explains how to enable JSPI build
- AC7: JSPI build works when enabled (for testing in Chrome)

| ID | Level | Priority | Test Scenario | Justification | Mitigates |
|----|-------|----------|---------------|---------------|-----------|
| 5.4-UNIT-004 | Unit | P1 | CMakeLists.txt contains `option(ENABLE_JSPI ... OFF)` | Config file content validation | TECH-002 |
| 5.4-INT-004 | Integration | P0 | `cmake -DENABLE_JSPI=OFF ..` produces Asyncify build with `-sASYNCIFY` | Build system default path | TECH-002 |
| 5.4-INT-005 | Integration | P1 | `cmake -DENABLE_JSPI=ON ..` produces JSPI build with `-sJSPI=1 -sASYNCIFY=0` | Build system experimental path | TECH-002 |
| 5.4-E2E-003 | E2E | P2 | JSPI build loads without crash in Chrome 137+ | Full application validation | - |
| 5.4-E2E-004 | E2E | P2 | Asyncify build (default) loads without crash in all browsers | Regression prevention | TECH-002 |

### AC 8-10: Conditional Logic (Future)

**Requirements:**
- AC8: Architecture supports switching between AsyncSerialiser and native JSPI
- AC9: AsyncSerialiser can be bypassed when JSPI is available
- AC10: Same public API regardless of underlying mechanism

| ID | Level | Priority | Test Scenario | Justification | Mitigates |
|----|-------|----------|---------------|---------------|-----------|
| 5.4-UNIT-005 | Unit | P2 | `jspiAvailable()` C++ method returns `window.JSPI_AVAILABLE` value | Cross-layer query function | - |
| 5.4-INT-006 | Integration | P2 | AsyncSerialiser bypass code (when uncommented) executes task directly | Future conditional path | - |
| 5.4-E2E-005 | E2E | P2 | Format/minify operations work identically with Asyncify and JSPI builds | API consistency | - |

### AC 11-13: Documentation

**Requirements:**
- AC11: Document current browser support status
- AC12: Document steps to enable JSPI when ready
- AC13: Add monitoring checklist for browser support updates

| ID | Level | Priority | Test Scenario | Justification | Mitigates |
|----|-------|----------|---------------|---------------|-----------|
| 5.4-UNIT-006 | Unit | P2 | `jspi-status.md` contains browser support table | Documentation completeness | OPS-001 |
| 5.4-E2E-006 | E2E | P2 | Build instructions in docs produce working JSPI build | Documentation accuracy | OPS-001 |

## Risk Coverage Matrix

| Risk ID | Risk Description | Test Coverage |
|---------|------------------|---------------|
| TECH-001 | JSPI API detection false positives | 5.4-UNIT-001, 002, 003; 5.4-INT-001, 002, 003; 5.4-E2E-002 |
| TECH-002 | JSPI build flag breaks Asyncify default | 5.4-INT-004, 005; 5.4-E2E-004 |
| TECH-003 | Browser API changes after implementation | Monitoring checklist (manual review) |
| OPS-001 | Documentation becomes outdated | 5.4-UNIT-006; 5.4-E2E-006 |

## Test Data and Environment Requirements

### Environment Matrix

| Environment | Purpose | Configuration |
|-------------|---------|---------------|
| Node.js + jsdom | Unit tests for jspi-detect.js | Mock `WebAssembly` global |
| Chrome 137+ | Integration/E2E JSPI detection | Native JSPI support enabled |
| Firefox 130+ | Integration/E2E fallback | Flag: `javascript.options.wasm_jspi` (disabled) |
| Safari latest | Integration/E2E fallback | No JSPI support |
| Docker build env | Build system tests | Emscripten 4.0.7+, Qt 6.10.1 |

### Test Data

| Data Item | Description | Source |
|-----------|-------------|--------|
| Mock `WebAssembly.Suspending` | Simulated JSPI API presence | Test fixture |
| Mock `WebAssembly.Function` with `suspending` | Alternative JSPI detection | Test fixture |
| Sample JSON input | Format/minify operation test | Existing test data |

### Browser Test Matrix

| Browser | Version | JSPI Detection Expected | Build Tested |
|---------|---------|------------------------|--------------|
| Chrome | 137+ | `true` | JSPI + Asyncify |
| Chrome | <137 | `false` | Asyncify |
| Edge | 137+ | `true` | JSPI + Asyncify |
| Firefox | 130+ | `false` (flag off) | Asyncify |
| Safari | Latest | `false` | Asyncify |

## Recommended Execution Order

1. **P0 Tests (Critical - Run First):**
   - 5.4-INT-001: Detection in Chrome 137+ (validates core feature)
   - 5.4-INT-004: Default Asyncify build works (no regression)

2. **P1 Tests (High - Run Second):**
   - 5.4-UNIT-001, 002, 003: Detection logic unit tests
   - 5.4-UNIT-004: CMake option present
   - 5.4-INT-002, 003, 005: Cross-browser and build variations
   - 5.4-E2E-001, 002: Full initialization validation

3. **P2 Tests (Medium - Run if Time Permits):**
   - 5.4-UNIT-005, 006: C++ bridge and documentation
   - 5.4-INT-006: Future bypass code path
   - 5.4-E2E-003, 004, 005, 006: Full application builds

## Test Automation Recommendations

### Automatable Tests

| Category | Tests | Automation Approach |
|----------|-------|---------------------|
| Unit | 5.4-UNIT-001 to 006 | Jest/Vitest with jsdom, CMake output parsing |
| Integration | 5.4-INT-001 to 005 | Playwright with browser matrix |
| E2E | 5.4-E2E-001, 002, 004 | Playwright multi-browser |

### Manual Tests (Quarterly Review)

- 5.4-E2E-003: JSPI build in Chrome (experimental)
- 5.4-E2E-005, 006: Build comparison, documentation accuracy
- Browser support status review (monitoring checklist)

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 18
  by_level:
    unit: 6
    integration: 6
    e2e: 6
  by_priority:
    p0: 2
    p1: 10
    p2: 6
  coverage_gaps: []
  notes:
    - All acceptance criteria have test coverage
    - P0 tests focus on detection accuracy and build regression prevention
    - P2 tests cover future/experimental code paths
    - Documentation tests ensure maintenance path is clear
```

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (unit for logic, integration for cross-layer, E2E for full flows)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk (detection accuracy = P0/P1, future features = P2)
- [x] Test IDs follow naming convention (5.4-{LEVEL}-{SEQ})
- [x] Scenarios are atomic and independent

## Trace References

```
Test design matrix: docs/qa/assessments/5.4-test-design-20260126.md
P0 tests identified: 2
P1 tests identified: 10
Total scenarios: 18
```
