# Risk Profile: Story 5.2 - Refactor Async Operations to Use AsyncSerialiser

Date: 2026-01-26
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 9
- Critical Risks: 1
- High Risks: 2
- Risk Score: 61/100 (calculated)

## Critical Risks Requiring Immediate Attention

### 1. [TECH-001]: Signal Timing Mismatch with UI State

**Score: 9 (Critical)**
**Probability**: High - The story converts 7 synchronous return-value methods to async signal-based. Every call site must be updated.
**Impact**: High - If UI expects immediate return values but receives signals later, the app will show stale/incorrect data or crash.

**Mitigation**:
- Create a signal-connection checklist for each operation (all 7 methods)
- Implement systematic testing of each operation in isolation before integration
- Add defensive null checks in signal handlers

**Testing Focus**:
- Test each signal handler receives correct data type and structure
- Test UI updates correctly after each signal
- Test error paths through signal handlers

## High Risks

### 2. [TECH-002]: QMetaObject::invokeMethod Thread Safety in WASM

**Score: 6 (High)**
**Probability**: Medium - WASM single-threaded but Qt event loop behavior may differ
**Impact**: High - Signal delivery failure would break all async operations

**Mitigation**:
- Test signal emission pattern in WASM before full refactor
- Verify Qt::QueuedConnection behavior in WASM environment
- Prepare fallback to direct invocation if needed

**Testing Focus**:
- Integration test: verify signals cross event loop boundaries in WASM
- Browser-specific testing (Chrome, Firefox)

### 3. [TECH-003]: Cascading Async Operations Creating Queue Starvation

**Score: 6 (High)**
**Probability**: Medium - Format triggers validation, validation triggers tree load, tree load triggers history save
**Impact**: High - Queue could grow unboundedly during normal use; UI becomes unresponsive

**Mitigation**:
- Map the full dependency graph of operations before implementation
- Consider coalescing related operations into single queue entries
- Add queue depth monitoring with user feedback

**Testing Focus**:
- Stress test: rapid format button clicks (Task 7)
- Profile queue depth during normal usage patterns
- Test queue behavior with slow network simulation

## Risk Distribution

### By Category

- Technical: 6 risks (1 critical, 2 high)
- Operational: 2 risks (0 critical, 0 high)
- Data: 1 risk (0 critical, 0 high)

### By Component

- JsonBridge C++: 4 risks
- Main.qml: 3 risks
- HistoryPanel.qml: 1 risk
- StatusBar.qml: 1 risk

## Detailed Risk Register

| Risk ID   | Description                                           | Probability | Impact   | Score | Priority |
|-----------|-------------------------------------------------------|-------------|----------|-------|----------|
| TECH-001  | Signal timing mismatch with UI state                  | High (3)    | High (3) | 9     | Critical |
| TECH-002  | QMetaObject::invokeMethod thread safety in WASM       | Medium (2)  | High (3) | 6     | High     |
| TECH-003  | Cascading async operations causing queue starvation   | Medium (2)  | High (3) | 6     | High     |
| TECH-004  | Error handling in signal emission differs from return | Medium (2)  | Medium (2)| 4    | Medium   |
| TECH-005  | isBusy property race condition during rapid operations| Medium (2)  | Medium (2)| 4    | Medium   |
| OPS-001   | Existing Timer workarounds conflict with new signals  | Medium (2)  | Medium (2)| 4    | Medium   |
| TECH-006  | Desktop fallback paths not exercised in refactor      | Low (1)     | Medium (2)| 2    | Low      |
| DATA-001  | History save signal not checked before next format    | Low (1)     | Low (1)  | 1     | Low      |
| OPS-002   | Loading state UI not tested across slow devices       | Low (1)     | Low (1)  | 1     | Low      |

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests

- **TECH-001 Coverage**:
  - Test formatCompleted signal returns QVariantMap with correct structure
  - Test validateCompleted signal updates StatusBar properties
  - Test historyLoaded signal populates HistoryPanel list
  - Test each error path through corresponding error signal
  - Test signal timing: ensure signal fires AFTER Asyncify resume

### Priority 2: High Risk Tests

- **TECH-002 Coverage**:
  - Integration test: signal emission from async context in WASM
  - Verify QMetaObject::invokeMethod(Qt::QueuedConnection) works in WASM
  - Cross-browser testing of signal delivery

- **TECH-003 Coverage**:
  - Stress test: click Format 10 times rapidly
  - Monitor queue length during cascaded operations
  - Test: format -> validate -> save sequence completes correctly

### Priority 3: Medium/Low Risk Tests

- Standard functional tests for each refactored operation
- Regression tests for existing functionality
- Test busy state indicator shows/hides correctly

## Risk Acceptance Criteria

### Must Fix Before Production

- All critical risks (TECH-001, score 9)
- High risks affecting core functionality (TECH-002, TECH-003)

### Can Deploy with Mitigation

- Medium risks with compensating controls (TECH-004, TECH-005, OPS-001)
- Low risks with monitoring in place

### Accepted Risks

- DATA-001: History save timing is non-critical; worst case is duplicate history entry
- OPS-002: Loading state is progressive enhancement

## Monitoring Requirements

Post-deployment monitoring for:

- Console errors related to "Cannot have multiple async operations"
- Queue depth warnings (if implemented)
- User-reported UI freezes or unresponsive buttons
- Signal delivery failures (uncaught errors)

## Risk Review Triggers

Review and update risk profile when:

- AsyncSerialiser API changes
- New async operations added to JsonBridge
- User reports of UI freezes or crashes
- Browser updates affecting WASM behavior

## Gate Recommendation

**Gate Status: CONCERNS**

This story has 1 critical risk (TECH-001: Signal timing mismatch) and 2 high risks that must be actively verified during implementation. Story can proceed but the following conditions apply:

1. **TECH-001** must be verified with systematic testing of each signal handler
2. **TECH-002** must be tested in actual WASM browser environment, not just native Qt
3. **TECH-003** requires queue depth monitoring during Task 7 stress testing

The timer-based workarounds currently in Main.qml (saveHistoryTimer, deferredFormatTimer) should be evaluated for removal only AFTER signal-based approach is proven stable.
