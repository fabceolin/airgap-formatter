# Risk Profile: Story 5.4 - JSPI Feature Detection and Future-Proofing

Date: 2026-01-26
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 4
- Critical Risks: 0
- High Risks: 0
- Risk Score: 92/100 (Low Risk)

## Story Context

This is an **optional, future-proofing story** that adds JSPI (JavaScript Promise Integration) feature detection and build configuration. The story is entirely additive and does not modify any production code paths.

## Risk Distribution

### By Category

- Technical (TECH): 3 risks (0 critical)
- Operational (OPS): 1 risk (0 critical)
- Security (SEC): 0 risks
- Performance (PERF): 0 risks
- Data (DATA): 0 risks
- Business (BUS): 0 risks

### By Component

- Feature Detection (JS): 2 risks
- Build System (CMake): 1 risk
- Documentation: 1 risk

## Detailed Risk Register

| Risk ID | Description | Probability | Impact | Score | Priority |
|---------|-------------|-------------|--------|-------|----------|
| TECH-001 | JSPI API detection false positives causing runtime misclassification | Medium (2) | Low (1) | 2 | Low |
| TECH-002 | JSPI build flag breaks Asyncify default build | Low (1) | Medium (2) | 2 | Low |
| TECH-003 | Browser API changes after implementation | Medium (2) | Low (1) | 2 | Low |
| OPS-001 | Documentation becomes outdated as browser support evolves | Medium (2) | Low (1) | 2 | Low |

## Risk Details and Mitigations

### TECH-001: Feature Detection False Positives

**Score: 2 (Low)**
**Probability**: Medium - Browser APIs for JSPI are still evolving; WebAssembly.Suspending may change
**Impact**: Low - Code defaults to safe Asyncify path; a false positive only results in a console log message

**Mitigation**:
- Implement conservative detection with try-catch wrapper
- Default to `false` (Asyncify) on any detection error
- Monitor WebAssembly proposal for API changes

**Testing Focus**:
- Test detection in Chrome 137+ (should return true)
- Test detection in Firefox without flag (should return false)
- Test detection in Safari (should return false, no errors)

### TECH-002: Build Configuration Conflicts

**Score: 2 (Low)**
**Probability**: Low - CMake option is OFF by default; requires explicit opt-in
**Impact**: Medium - Could break CI builds if accidentally enabled without proper browser

**Mitigation**:
- Keep ENABLE_JSPI=OFF by default
- Add clear documentation warnings
- CI should test both configurations if JSPI tests added

**Testing Focus**:
- Verify default build (ENABLE_JSPI=OFF) works identically to before
- Verify ENABLE_JSPI=ON produces valid WASM binary
- Verify CMake reports correct build mode

### TECH-003: Browser API Evolution

**Score: 2 (Low)**
**Probability**: Medium - JSPI proposal not yet finalized; WebAssembly.Suspending API may change
**Impact**: Low - Detection code is isolated in single file; easy to update

**Mitigation**:
- Monitor WebAssembly JSPI proposal status quarterly
- Detection code uses multiple fallback checks
- Documentation includes monitoring checklist

**Testing Focus**:
- Verify detection gracefully handles unknown API shapes
- Test with Chrome canary for early API change detection

### OPS-001: Documentation Staleness

**Score: 2 (Low)**
**Probability**: Medium - Browser versions change frequently; support tables require updates
**Impact**: Low - Developer confusion only; no runtime or security impact

**Mitigation**:
- Include quarterly review checklist in documentation
- Link to authoritative sources (chromestatus.com, WebAssembly proposals)
- Date-stamp all browser support information

**Testing Focus**:
- Verify documentation links are valid
- Verify browser version numbers are accurate at time of writing

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests
- None (no critical risks identified)

### Priority 2: Detection Accuracy Tests
- Test JSPI detection in Chrome 137+ returns `true`
- Test JSPI detection in Firefox (no flag) returns `false`
- Test JSPI detection in Safari returns `false`
- Test detection script doesn't throw exceptions on any browser
- Test `window.JSPI_AVAILABLE` is always defined (true or false)

### Priority 3: Build System Tests
- Verify `cmake -DENABLE_JSPI=OFF ..` (default) produces working Asyncify build
- Verify `cmake -DENABLE_JSPI=ON ..` produces valid WASM binary
- Verify JSPI build runs in Chrome 137+ without crashes
- Verify existing CI pipeline passes without modification

### Priority 4: Documentation Validation
- Verify browser support table accuracy
- Verify "How to Test" instructions work
- Verify monitoring checklist links are valid

## Risk Acceptance Criteria

### Must Fix Before Production
- None (no critical/high risks)

### Can Deploy with Mitigation
- All identified risks are acceptable with current mitigations

### Accepted Risks
- TECH-001: False positives acceptable; defaults to safe path
- TECH-002: Build breaks acceptable; feature is experimental and off by default
- TECH-003: API changes acceptable; isolated code, easy to update
- OPS-001: Stale docs acceptable; developer inconvenience only

## Monitoring Requirements

Post-deployment monitoring:
- Quarterly review of browser JSPI support status
- Monitor WebAssembly proposal repo for API changes
- Track JSPI build usage in development environments

## Risk Review Triggers

Review and update this risk profile when:
- WebAssembly JSPI proposal reaches Stage 4 (finalization)
- Safari announces JSPI support timeline
- Detection code requires updates due to API changes
- Team decides to enable JSPI by default

## Gate Recommendation

**Gate Decision: PASS**

Rationale:
- All risks score 2 (Low)
- Story is optional and additive
- No modification to production code paths
- Conservative defaults (ENABLE_JSPI=OFF, detection defaults to false)
- Complete rollback possible (ignore new files)

## Risk Summary (Gate YAML)

```yaml
risk_summary:
  totals:
    critical: 0
    high: 0
    medium: 0
    low: 4
  highest:
    id: TECH-001
    score: 2
    title: 'JSPI API detection false positives'
  recommendations:
    must_fix: []
    monitor:
      - 'Review browser JSPI support quarterly'
      - 'Update detection logic when WebAssembly.Suspending API finalizes'
```
