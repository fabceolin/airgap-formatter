# NFR Assessment: 5.3 Remove Timer Workarounds

Date: 2026-01-26
Reviewer: Quinn (Test Architect)

## Summary

- Security: PASS - No new security surface; cleanup operation only
- Performance: CONCERNS - Missing validation timing thresholds; potential latency changes
- Reliability: CONCERNS - Removing safety mechanisms increases crash risk if 5.2 has gaps
- Maintainability: PASS - Code cleanup improves maintainability significantly

## Quality Score: 70/100

Calculation:
- Base: 100
- CONCERNS (Performance): -10
- CONCERNS (Reliability): -10 (weighted +10 for removal risk)
- Final: 70/100

## NFR Deep Dive

### Security - PASS

**Assessment:**
This story involves removing workaround code (QML Timers and skip flags) that were added to prevent Asyncify conflicts. The security posture is unchanged or improved:

| Check | Status | Evidence |
|-------|--------|----------|
| No new attack surface | PASS | Pure deletion/cleanup of internal timing code |
| No external data exposure | PASS | No network, storage, or logging changes |
| No authentication changes | N/A | Application has no authentication |
| Input validation preserved | PASS | validateJson() path unchanged |

**Conclusion:** Security is not impacted by this story. The removal of timer workarounds affects only internal timing - no user data paths, no external interfaces, no privilege boundaries affected.

### Performance - CONCERNS

**Assessment:**
Removing the timer workarounds changes the timing characteristics of async operation execution. Key concerns:

| Check | Status | Notes |
|-------|--------|-------|
| Response time targets defined | CONCERNS | No measurable threshold for format→display latency |
| Memory usage unchanged | PASS | Timer removal reduces memory (minor) |
| No obvious bottlenecks | CONCERNS | Queue serialization may add latency vs direct calls |
| CPU usage unchanged | PASS | Removes Timer.interval polling overhead |

**Identified Gaps:**

1. **No latency baseline** - Story does not define acceptable format operation latency. Without timers, operations execute immediately when queue is ready. Need: "Format operation completes within 200ms on standard hardware"

2. **History selection timing** - Removing `deferredFormatTimer.interval: 50` changes history load timing. Need: "History entry selection formats within 100ms of click"

3. **Validation coalescing removed** - The `skipNextValidation` flag prevented redundant validations. Removing it may cause extra validateJson calls. Need: "Validation debounce (300ms) still applies after timer removal"

**Quick Wins:**
- Add performance assertion: format < 200ms for 10KB JSON
- Verify validation debounce still works without skip flag
- Profile before/after timer removal for comparison

### Reliability - CONCERNS

**Assessment:**
This is the highest-risk NFR. The timers and skip flags were explicitly added as a safety net against Asyncify conflicts. Removing them depends entirely on Story 5.2's AsyncSerialiser correctly handling all cases.

| Check | Status | Notes |
|-------|--------|-------|
| Error handling present | CONCERNS | Timer errors were silent; queue errors need handling |
| Graceful degradation | CONCERNS | No fallback if AsyncSerialiser has gaps |
| Retry logic where needed | N/A | Operations don't retry |
| Recovery mechanisms | PASS | Git revert available as rollback |

**Identified Gaps:**

1. **Pre-condition verification** - Story says "Depends on: Story 5.2" but no verification checklist exists. Need: "Verify ALL 7 async operations use AsyncSerialiser before removal"

2. **Incremental removal** - Story removes ALL workarounds at once. Risk: One missed edge case crashes app. Need: "Remove one timer at a time with testing between"

3. **No circuit breaker** - If Asyncify conflicts occur post-removal, app crashes. Need: "AsyncSerialiser logs queue conflicts without crashing (debug mode)"

4. **History selection race** - Removing `validationTimer.stop()` from history handler may re-enable race condition. Need: "Test rapid history selection with validation debounce active"

**Critical Mitigations Required:**
- Verify Story 5.2 passes all Asyncify stress tests BEFORE starting 5.3
- Keep git history clean for rapid rollback
- Test each removal in isolation

### Maintainability - PASS

**Assessment:**
This story explicitly improves maintainability by removing technical debt. The workarounds are documented as "fragile" in the story and ASYNCIFY-CONFLICT-REPORT.md.

| Check | Status | Notes |
|-------|--------|-------|
| Code well-structured | PASS | Removing workarounds simplifies Main.qml |
| Documentation present | PASS | ADR creation required (AC 16) |
| Test coverage | CONCERNS | Manual test plan exists; no automated tests for removed code paths |

**Evidence:**
- Lines 61-83 of Main.qml (timers + skip flag) → removed = ~22 lines deleted
- ASYNCIFY-CONFLICT-REPORT.md documented as "Workaround Applied" → changes to "Fixed"
- ADR captures why AsyncSerialiser was chosen over alternatives

**Minor Gap:**
- No automated regression tests for timer-dependent behavior. Recommend: Add Playwright E2E test for history selection flow.

## Critical Issues

1. **Reliability Risk: Premature Removal** (Reliability)
   - Risk: Removing safety mechanisms before 5.2 is proven stable
   - Impact: Application crashes on Asyncify conflicts
   - Fix: Add explicit pre-condition checklist:
     - [ ] All 7 async operations confirmed using AsyncSerialiser
     - [ ] Asyncify stress tests pass in 5.2
     - [ ] No Asyncify errors in 10-minute stress test session

2. **No Performance Baseline** (Performance)
   - Risk: Cannot verify no performance regression after timer removal
   - Impact: User-perceived latency changes undetected
   - Fix: Capture timing baseline before removal; compare after

## Recommendations

### Must Have (Before Story Start)

1. **Pre-condition verification gate:** Story should not start until 5.2 passes comprehensive Asyncify stress testing
2. **Incremental removal strategy:** Remove `saveHistoryTimer` first, test, then `deferredFormatTimer`, test, then `skipNextValidation`

### Should Have (Before Release)

3. **Performance baseline:** Document format/validate latency before and after
4. **Automated regression:** Add E2E test for history-selection-triggers-format flow

### Nice to Have

5. **Circuit breaker logging:** AsyncSerialiser warns on concurrent enqueue attempt rather than silent queue
6. **Validation coalescing audit:** Confirm debounce timer (300ms) is sufficient without skip flag

## Gate YAML Block

```yaml
# Gate YAML (copy/paste):
nfr_validation:
  _assessed: [security, performance, reliability, maintainability]
  security:
    status: PASS
    notes: 'No new security surface; pure cleanup operation'
  performance:
    status: CONCERNS
    notes: 'No latency baseline; timer removal changes timing characteristics'
  reliability:
    status: CONCERNS
    notes: 'Removing safety mechanisms depends on 5.2 completeness; incremental removal recommended'
  maintainability:
    status: PASS
    notes: 'Significant code cleanup; ADR documents architectural decision'
```

---

NFR assessment: docs/qa/assessments/5.3-nfr-20260126.md

Gate NFR block ready → paste into docs/qa/gates/5.3-remove-timer-workarounds.yml under nfr_validation
