# Risk Profile: Story 5.3 - Remove Timer Workarounds

Date: 2026-01-26
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 8
- Critical Risks: 1
- High Risks: 2
- Risk Score: 53/100 (Elevated Risk)

Story 5.3 removes QML Timer workarounds that were originally introduced to prevent Asyncify conflicts. This is a cleanup/validation story that **depends on Story 5.2** completing successfully. The primary risk is removing these safety mechanisms before the AsyncSerialiser is proven stable, which could reintroduce the original crashes.

## Critical Risks Requiring Immediate Attention

### 1. [TECH-001]: Premature Workaround Removal Causing Crash Regression

**Score: 9 (Critical)**
**Probability**: High - The timers exist specifically to prevent Asyncify conflicts. If Story 5.2's signal-based pattern has any gaps, removal will expose them.
**Impact**: High - Application crash with "Cannot have multiple async operations in flight" error renders the tool unusable.
**Mitigation**:
- Verify ALL 7 async operations in Story 5.2 are fully migrated to AsyncSerialiser before starting 5.3
- Perform comprehensive Asyncify stress testing before any timer removal
- Remove one timer at a time with testing between removals
- Keep git commit history granular for surgical rollback
**Testing Focus**: Rapid-click testing on format, history selection, copy operations

## High Risks

### 2. [TECH-002]: History Selection Flow Race Condition

**Score: 6 (High)**
**Probability**: Medium - The `onEntrySelected` handler has multiple async calls (set text, format, validate, save history) that the timer currently serializes.
**Impact**: High - Crash when selecting history entries is the exact scenario the workarounds were created for.
**Mitigation**:
- Map the full event sequence: drawer close animation → text change → validation → format → history save
- Ensure AsyncSerialiser handles this cascade without timer intervention
- Test with drawer animation enabled and disabled
**Testing Focus**: Rapid history entry selection (5 clicks in 1 second)

### 3. [TECH-003]: skipNextValidation Logic Removal Timing

**Score: 6 (High)**
**Probability**: Medium - The `skipNextValidation` flag prevents redundant validation calls. Removing it may trigger validation during format, causing queue contention.
**Impact**: High - Could cause Asyncify conflict if format and validate run concurrently before queue serialization is proven.
**Mitigation**:
- Verify validate is queued through AsyncSerialiser before removing skip flag
- Consider keeping flag as optimization (not just crash prevention)
- Test that validation is properly coalesced or skipped after format completes
**Testing Focus**: Format operation followed by immediate text change

## Medium Risks

### 4. [TECH-004]: Edge Case Gaps in AsyncSerialiser Coverage

**Score: 4 (Medium)**
**Probability**: Medium - Story 5.2 may not cover all edge cases the timers currently handle (e.g., paste-while-format-pending)
**Impact**: Medium - Specific user actions may crash if not covered
**Mitigation**:
- Review ASYNCIFY-CONFLICT-REPORT.md for all documented scenarios
- Create explicit test for each documented workaround scenario
**Testing Focus**: Ctrl+V paste while format is executing

### 5. [OPS-001]: Documentation Staleness After Removal

**Score: 4 (Medium)**
**Probability**: High - ASYNCIFY-CONFLICT-REPORT.md describes workarounds that will be removed
**Impact**: Low - Confusion for future developers if docs describe deleted code
**Mitigation**:
- Update ASYNCIFY-CONFLICT-REPORT.md status to "Fixed" with date
- Create ADR explaining the fix and removal decision
- Archive workaround code in git history comments
**Testing Focus**: N/A (process risk)

### 6. [TECH-005]: validationTimer.stop() Removal Side Effects

**Score: 4 (Medium)**
**Probability**: Medium - Multiple places call `validationTimer.stop()` to prevent overlapping validation
**Impact**: Medium - Validation may queue multiple times for single text change
**Mitigation**:
- Trace all `validationTimer.stop()` call sites
- Verify debounce behavior is preserved through AsyncSerialiser
- Consider keeping debounce timer even without skip flag
**Testing Focus**: Type rapidly in input pane, verify single validation result

## Low Risks

### 7. [TECH-006]: Cross-Browser Timing Differences

**Score: 2 (Low)**
**Probability**: Low - Asyncify behavior may differ slightly between browsers
**Impact**: Medium - One browser crashes while others work
**Mitigation**:
- Test removal in Chrome, Firefox, Safari
- Use DevTools CPU throttling to simulate slow devices
**Testing Focus**: Run full test suite in each browser

### 8. [TECH-007]: Desktop Build Regression

**Score: 1 (Minimal)**
**Probability**: Low - Desktop build doesn't use Asyncify, may have different code paths
**Impact**: Low - Desktop build is secondary; WASM is primary target
**Mitigation**:
- Run basic smoke test on desktop build after changes
**Testing Focus**: Format, validate, copy on native Qt build

## Risk Distribution

### By Category
- Technical: 7 risks (1 critical, 2 high, 3 medium, 1 low)
- Operational: 1 risk (0 critical)

### By Component
- Main.qml Timer removal: 5 risks
- History selection flow: 2 risks
- Documentation: 1 risk

## Detailed Risk Register

| Risk ID   | Category  | Title                                            | Prob | Impact | Score | Priority |
|-----------|-----------|--------------------------------------------------|------|--------|-------|----------|
| TECH-001  | Technical | Premature workaround removal causing crash       | 3    | 3      | 9     | Critical |
| TECH-002  | Technical | History selection flow race condition            | 2    | 3      | 6     | High     |
| TECH-003  | Technical | skipNextValidation removal timing                | 2    | 3      | 6     | High     |
| TECH-004  | Technical | Edge case gaps in AsyncSerialiser coverage       | 2    | 2      | 4     | Medium   |
| OPS-001   | Ops       | Documentation staleness after removal            | 3    | 1      | 3     | Low      |
| TECH-005  | Technical | validationTimer.stop() removal side effects      | 2    | 2      | 4     | Medium   |
| TECH-006  | Technical | Cross-browser timing differences                 | 1    | 2      | 2     | Low      |
| TECH-007  | Technical | Desktop build regression                         | 1    | 1      | 1     | Minimal  |

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests
- **TECH-001 Regression Suite**: Full Asyncify conflict reproduction tests
  - Rapid format clicking (5, 10, 20 clicks)
  - History entry selection stress test
  - Format-copy-format sequence
  - Paste while formatting
  - CPU throttling simulation (6x slowdown)

### Priority 2: High Risk Tests
- **TECH-002 History Flow Tests**:
  - Select history entry → verify no crash
  - Rapid history selection (5 entries in 1 second)
  - Select entry while previous format is pending
  - Close drawer animation timing test

- **TECH-003 Validation Coalescing Tests**:
  - Format then immediate text edit
  - Verify validation skipped after format (performance)
  - Verify validation queued not concurrent (correctness)

### Priority 3: Medium Risk Tests
- Edge case coverage from ASYNCIFY-CONFLICT-REPORT.md
- Debounce behavior verification
- Cross-browser compatibility

### Priority 4: Low Risk Tests
- Desktop build smoke test
- Documentation review

## Risk Acceptance Criteria

### Must Fix Before Production
- All critical risks (TECH-001 score 9)
- High risks affecting core functionality (TECH-002, TECH-003)

### Can Deploy with Mitigation
- Medium risks with compensating controls (TECH-004, TECH-005)
- Low risks with monitoring in place

### Accepted Risks
- TECH-007: Desktop build is secondary platform, acceptable to defer

## Monitoring Requirements

Post-deployment monitoring for:
- Browser console errors matching "Cannot have multiple async operations"
- Browser console errors matching "memory access out of bounds"
- Browser console errors matching "Cannot use deleted val"
- User-reported crashes on history selection

## Risk Review Triggers

Review and update risk profile when:
- Story 5.2 implementation reveals new Asyncify edge cases
- Browser updates change Asyncify behavior
- New async operations are added to the application
- Crash reports are received post-deployment

## Integration with Quality Gates

**Deterministic gate mapping:**
- TECH-001 score 9 → Gate = **CONCERNS** (not FAIL because dependency on 5.2 provides mitigation path)
- If 5.2 is incomplete → Gate = **FAIL**
- If all high risks have test coverage → Gate = **CONCERNS**
- After successful execution of test plan → Gate = **PASS**

## Risk Score Calculation

```
Base Score = 100
Critical (1 × 20) = -20
High (2 × 10) = -20
Medium (3 × 5) = -15 (OPS-001 counted as 3 points due to lower impact)
Low (2 × 2) = -4
Adjusted for OPS-001 lower severity = +2 (documentation risk)

Total Deductions = 57
Adjustment = +10 (dependency on 5.2 provides structural mitigation)

Final Score = 53/100
```

## Gate Determination

**Gate: CONCERNS**

Story 5.3 has inherent risk because it removes safety mechanisms. However:
1. The dependency on Story 5.2 provides a proper fix before removal
2. Git history enables surgical rollback
3. Comprehensive test plan covers all removal scenarios

**Recommendation**: Proceed with 5.3 only after Story 5.2 is fully implemented and tested. Remove timers one at a time with testing between each removal. Keep ASYNCIFY-CONFLICT-REPORT.md for reference until confident fix is stable.
