# NFR Assessment: 5.1 - AsyncSerialiser C++ Implementation

**Date:** 2026-01-26
**Reviewer:** Quinn (Test Architect)
**Mode:** YOLO (Non-interactive, core four NFRs)

## Summary

| NFR | Status | Notes |
|-----|--------|-------|
| Security | PASS | Internal component, no external data handling, browser sandbox |
| Performance | CONCERNS | Target unknown for queue overhead/latency; 30s watchdog may impact perceived responsiveness |
| Reliability | PASS | Strong error isolation, watchdog, graceful degradation |
| Maintainability | PASS | Qt conventions, signals for observability, unit tests planned |

**Quality Score:** 90/100
- 0 FAIL attributes
- 1 CONCERNS attribute (-10)

## Detailed Assessment

### Security: PASS

**Evidence:**
- No network calls - aligns with airgap architecture requirement
- No persistent storage of user data
- No authentication/authorization needed (internal utility class)
- Singleton pattern with deleted copy/assignment operators
- No secrets or credentials involved
- Runs entirely in browser WASM sandbox

**Applicable Criteria:**
- Input validation: N/A (internal API, no user input)
- Authorization: N/A (internal component)
- Secret management: N/A (no secrets)
- Rate limiting: N/A (internal serialization is the rate limit)

### Performance: CONCERNS

**Issues Identified:**

1. **No performance thresholds defined**
   - Risk: Cannot objectively measure if implementation meets requirements
   - Target unknown: Queue overhead, task scheduling latency not specified
   - Recommendation: Define acceptable overhead (e.g., <10ms per task queue operation)

2. **30-second watchdog may impact responsiveness**
   - Risk: Users perceive application as frozen during long tasks
   - Mitigation present: taskTimedOut signal allows UI feedback
   - Recommendation: Consider configurable timeout per task type

3. **Memory bounds not specified**
   - Risk: Unbounded queue growth under load
   - Target unknown: Maximum queue length not defined
   - Recommendation: Add optional queue size limit with backpressure

**Evidence Present:**
- Single-flight pattern prevents concurrent resource contention (+)
- QMetaObject::invokeMethod with Qt::QueuedConnection for event loop integration (+)
- Task execution is deferred, not blocking enqueue (+)

### Reliability: PASS

**Evidence:**
- AC 8: Error in one task does not block subsequent tasks - explicitly implemented
- AC 6: Watchdog timer (30s) aborts stuck tasks
- AC 7: clearQueue() method for emergency reset
- QFutureWatcher cleanup with deleteLater() prevents memory leaks
- onWatchdogTimeout() properly resets state and chains to next task
- Single-flight guard (m_isBusy) prevents reentrancy issues

**Testing Coverage Planned:**
- AC 12: Unit tests for single-task-at-a-time invariant
- AC 13: Unit tests for FIFO ordering
- AC 14: Unit tests for watchdog timeout behavior

### Maintainability: PASS

**Evidence:**
- Clear singleton pattern following Qt conventions
- Q_OBJECT macro enables Qt reflection and signal/slot
- Well-structured header with comprehensive documentation
- Public API uses standard Qt patterns (signals, properties)
- Doxygen documentation planned (Task 6)
- queueLength property for external monitoring
- Logging with qDebug()/qWarning() for diagnostics
- Unit tests required in Definition of Done
- Compiler warnings disallowed (-Wall -Wextra)

**Code Quality Indicators:**
- Proper RAII (QFutureWatcher cleanup)
- Move semantics used (std::move on task)
- Clear separation: enqueue vs processNext vs completion handling

## Critical Issues

1. **Performance targets undefined** (Performance)
   - Risk: No objective success criteria for performance
   - Fix: Add AC for queue overhead <10ms, task scheduling <5ms

## Recommendations

### Must Address (Before Implementation)

1. **Define performance thresholds**
   - Add acceptance criteria: "Queue operations complete in <10ms"
   - Add acceptance criteria: "Task scheduling overhead <5ms"

### Should Address (During Implementation)

2. **Add queue size monitoring**
   - Log warning when queue exceeds threshold (e.g., 10 tasks)
   - Consider optional max queue size with rejection/backpressure

3. **Document WASM-specific behavior**
   - QTimer reliability in WASM (already flagged in Risk Profile)
   - QFuture/QPromise completion signals in WASM

### Nice to Have (Future Enhancement)

4. **Configurable watchdog timeout**
   - Allow different timeouts per task type
   - Some operations (e.g., large file processing) may legitimately need longer

5. **Task priority support**
   - Allow high-priority tasks to jump queue (future enhancement only)

## Test Recommendations

### Unit Tests (Native Qt)

1. **Serialization invariant test**
   - Enqueue two tasks, verify only one runs at a time
   - Check m_isBusy state during execution

2. **FIFO ordering test**
   - Enqueue tasks A, B, C
   - Verify completion order is A, B, C

3. **Watchdog timeout test**
   - Enqueue task that never completes
   - Verify taskTimedOut signal fires after 30s
   - Verify queue continues processing

4. **Error isolation test**
   - Enqueue task that throws/fails
   - Verify next task still executes

5. **clearQueue test**
   - Enqueue multiple tasks
   - Call clearQueue during execution
   - Verify no memory leaks, no crashes

### Integration Tests (WASM)

6. **QTimer in WASM**
   - Verify watchdog fires correctly in browser environment
   - Test with emscripten_set_timeout fallback if needed

7. **QFuture completion in WASM**
   - Verify QFutureWatcher::finished signal works in WASM
   - Test with actual val::await task

### Performance Tests

8. **Queue overhead measurement**
   - Measure time from enqueue() call to task start
   - Should be <10ms for empty queue

9. **Throughput test**
   - Queue 100 fast tasks
   - Measure total completion time
   - Verify no memory growth

## Acceptance Criteria Gaps

The following NFR-related acceptance criteria are recommended additions:

```markdown
### Performance (Recommended Additions)
16. Queue overhead does not exceed 10ms per task
17. Task scheduling latency is <5ms when queue is empty

### Observability (Recommended Additions)
18. Warning logged when queue length exceeds 10 tasks
19. All task lifecycle events are logged at debug level
```

## Gate YAML Block

```yaml
# Gate YAML (copy/paste):
nfr_validation:
  _assessed: [security, performance, reliability, maintainability]
  security:
    status: PASS
    notes: 'Internal component, no external data handling, browser sandbox execution'
  performance:
    status: CONCERNS
    notes: 'Target unknown for queue overhead/latency; no bounds on queue size'
  reliability:
    status: PASS
    notes: 'Error isolation, watchdog timer, clearQueue for recovery'
  maintainability:
    status: PASS
    notes: 'Qt conventions, signals for observability, unit tests in DoD'
```

---

**NFR assessment:** docs/qa/assessments/5.1-nfr-20260126.md

**Gate NFR block ready** -> paste into docs/qa/gates/5.1-async-serialiser-implementation.yml under nfr_validation
