# NFR Assessment: 5.2 Refactor Async Operations

**Date:** 2026-01-26
**Reviewer:** Quinn (Test Architect)
**Story:** 5.2.refactor-async-operations.md

## Summary

| NFR | Status | Notes |
|-----|--------|-------|
| Security | PASS | No new security surface; signals internal to Qt/QML |
| Performance | CONCERNS | Queue serialization may introduce latency; no benchmarks specified |
| Reliability | CONCERNS | Critical pattern shift with signal timing risks; partial mitigations in AC |
| Maintainability | PASS | Well-structured signal/slot patterns; clear separation of concerns |

**Quality Score: 80/100** (2 CONCERNS × 10 = -20)

---

## Security Assessment

### Status: PASS

**What's Covered:**
- No new external APIs introduced
- Signal-based patterns remain internal to Qt/QML boundary
- All async operations stay client-side (IndexedDB, clipboard)
- No new data exposure paths

**Evidence:**
- AC 12-16 ensure behavior preservation without new attack vectors
- Zero network requirement maintained by architecture (connect-src 'none')
- User data flows remain: input → Rust WASM → output (no leaks)

**No Security Concerns:**
The refactor is purely internal async coordination. Signals emit results to QML, not externally. The Emscripten sandbox and Qt WASM isolation remain intact.

---

## Performance Assessment

### Status: CONCERNS

**What's Covered:**
- AC 17 addresses rapid-click queueing
- AsyncSerialiser pattern serializes operations to prevent crashes

**What's Missing:**
1. **No performance benchmarks specified** - Story lacks acceptance criteria for response time targets
2. **Queue latency unquantified** - Serializing 7 async operations may introduce noticeable delays
3. **No degradation thresholds** - What's acceptable latency when 5 operations are queued?

**Specific Gaps:**

| Gap | Risk | Recommendation |
|-----|------|----------------|
| No p95 latency target | Medium | Add AC: "Queue of 5 operations completes within 2s" |
| Busy indicator timing | Low | Specify minimum display time to avoid flicker |
| Memory usage under load | Low | Test with 100 history entries + rapid operations |

**Threshold Evidence:**
- Architecture doc specifies "<100ms target for 1MB JSON" (section 11.2)
- No equivalent target for async operation queue throughput
- Story mentions "operations complete in order" but not timing

---

## Reliability Assessment

### Status: CONCERNS

**What's Covered:**
- AC 17: Rapid clicks queue without crash
- AC 18: Timeout shows user-friendly error
- AC 19: Failed operation doesn't block subsequent operations
- Risk Profile identifies TECH-001 (signal timing) as critical

**What's Missing:**
1. **Retry policy undefined** - What happens if IndexedDB save fails transiently?
2. **Partial success handling** - If format succeeds but history save fails, what's the user experience?
3. **Queue overflow behavior** - No maximum queue depth or backpressure defined
4. **Cross-browser signal timing** - AC lacks explicit Chrome/Firefox/Safari verification

**Critical Reliability Gaps:**

| Gap | Impact | Recommendation |
|-----|--------|----------------|
| No retry logic specified | High | Add AC: "Transient failures retry once before error" |
| Cascading failure handling | High | Define: "Format failure should not prevent manual copy" |
| Queue depth limit | Medium | Add AC: "Queue accepts max 10 operations; additional rejected with message" |

**Existing Mitigations:**
- Timer workarounds from ASYNCIFY-CONFLICT-REPORT.md partially address timing
- Risk Profile TECH-003 identifies queue starvation but no solution in AC

---

## Maintainability Assessment

### Status: PASS

**What's Covered:**
- Clear signal naming convention (formatCompleted, validateCompleted, etc.)
- Signal/slot pattern is standard Qt idiom
- Dev Notes provide implementation examples
- Source tree clearly identifies files to modify

**Evidence:**
- 7 operations × 3 files = manageable change scope
- Each signal has corresponding QML Connections handler example
- Desktop fallback pattern documented (`#else` clause)
- Test tasks explicitly listed (Task 7)

**Minor Improvements:**
- Consider adding JSDoc/QDoc for new signals (not blocking)
- Code examples could include error emission patterns

---

## Critical Issues

### 1. Performance - No Latency Targets

**Risk:** Queue serialization may make app feel sluggish under load
**Fix:** Add acceptance criteria with measurable performance thresholds

```
AC-NEW: Queued operations execute with <50ms inter-operation delay
AC-NEW: Busy indicator appears within 16ms of operation start
```

### 2. Reliability - Partial Failure Handling

**Risk:** Cascading operations (format → validate → history save) may leave app in inconsistent state
**Fix:** Define behavior for each failure combination

```
AC-NEW: If format succeeds but validate fails, output still displays formatted result
AC-NEW: If history save fails, user is notified but can continue working
```

### 3. Reliability - No Retry Policy

**Risk:** Transient IndexedDB failures may lose user data
**Fix:** Specify retry behavior

```
AC-NEW: History save retries once on transient failure before showing error
```

---

## Quick Wins

1. **Add performance threshold to AC** - 5 minutes to write, prevents ambiguity
2. **Define max queue depth** - Simple constant, prevents resource exhaustion
3. **Specify partial failure UX** - Clarifies expected behavior for testers

---

## Gate YAML Block

```yaml
# Gate YAML (copy/paste into gate file):
nfr_validation:
  _assessed: [security, performance, reliability, maintainability]
  security:
    status: PASS
    notes: 'Internal signal patterns only; no new security surface'
  performance:
    status: CONCERNS
    notes: 'Missing latency targets for queue throughput; add benchmarks'
  reliability:
    status: CONCERNS
    notes: 'No retry policy or partial failure handling; queue depth undefined'
  maintainability:
    status: PASS
    notes: 'Standard Qt signal/slot pattern; clear implementation guidance'
```

---

## Test Recommendations

### Must Test (Critical)
1. **Signal timing in WASM browser** - Each signal handler fires after Asyncify resume
2. **Rapid-click stress test** - 20 clicks in 1 second, measure completion time
3. **Cascading operation failure** - Mock format success + history save failure

### Should Test (High)
1. **Cross-browser verification** - Chrome, Firefox minimum; Safari if possible
2. **Queue depth behavior** - What happens at 10, 20, 50 queued operations?
3. **Memory under load** - Profile during extended rapid-click session

### Nice to Have (Medium)
1. **Latency instrumentation** - Add timing logs for queue metrics
2. **Desktop fallback path** - Verify synchronous fallback compiles/runs

---

NFR assessment: docs/qa/assessments/5.2-nfr-20260126.md

Gate NFR block ready → paste into docs/qa/gates/5.2-refactor-async-operations.yml under nfr_validation
