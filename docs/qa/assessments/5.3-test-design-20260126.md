# Test Design: Story 5.3 - Remove Timer Workarounds and Validate Fix

Date: 2026-01-26
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 24
- Unit tests: 0 (0%) - No pure logic changes, only removal
- Integration tests: 8 (33%)
- E2E tests: 16 (67%)
- Priority distribution: P0: 8, P1: 10, P2: 4, P3: 2

### Strategy Rationale

This story involves removing QML Timer workarounds that prevent Asyncify conflicts. Since the changes are primarily deletion of safety mechanisms (timers, skip flags), testing focuses on:

1. **E2E-heavy approach**: Testing user-visible behavior after workaround removal
2. **No unit tests**: No new logic being added; pure removal
3. **Integration tests**: Verify async operation serialization still works
4. **Regression focus**: Ensure all previous functionality remains intact

---

## Test Scenarios by Acceptance Criteria

### AC1-4: Code Cleanup (Remove Timer Components)

These acceptance criteria are code-level verification, not behavior tests. Verify via code review/diff.

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 5.3-INT-001 | Integration | P0 | Verify saveHistoryTimer removed from Main.qml | Code cleanup verification |
| 5.3-INT-002 | Integration | P0 | Verify deferredFormatTimer removed from Main.qml | Code cleanup verification |
| 5.3-INT-003 | Integration | P1 | Verify skipNextValidation flag removed | Code cleanup verification |
| 5.3-INT-004 | Integration | P1 | Verify validationTimer.stop() removed from history handler | Code cleanup verification |

---

### AC5: Documentation Update (ASYNCIFY-CONFLICT-REPORT.md)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 5.3-INT-005 | Integration | P2 | Verify ASYNCIFY-CONFLICT-REPORT.md status updated to "Fixed" | Documentation verification |

---

### AC6: History Entry Selection Loads and Formats Without Crash

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 5.3-E2E-001 | E2E | P0 | Select single history entry - content loads and formats | Critical user journey |
| 5.3-E2E-002 | E2E | P0 | Select history entry while drawer is closing (animation) | Race condition scenario |
| 5.3-E2E-003 | E2E | P1 | Select history entry with large JSON (>50KB) | Performance edge case |
| 5.3-E2E-004 | E2E | P1 | Select history entry with invalid JSON | Error handling path |

**Risk Mitigation:** TECH-002 (History selection flow race condition)

---

### AC7: Multiple Rapid Format Operations Queue Without Crash

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 5.3-E2E-005 | E2E | P0 | Rapid format button clicks (5x in 1 second) | Asyncify conflict stress test |
| 5.3-E2E-006 | E2E | P0 | Format-Copy-Format sequence without delay | Critical crash scenario |
| 5.3-E2E-007 | E2E | P1 | Alternate between Format and Minify rapidly | Operation mixing stress |
| 5.3-E2E-008 | E2E | P1 | Format while previous format still in progress | Queue behavior validation |

**Risk Mitigation:** TECH-001 (Premature workaround removal)

---

### AC8: Copy After Format Works Without Crash

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 5.3-E2E-009 | E2E | P0 | Format JSON then immediately click Copy | Clipboard + format interaction |
| 5.3-E2E-010 | E2E | P1 | Multiple Copy operations in sequence | Clipboard queue stress |

**Risk Mitigation:** TECH-001 (Clipboard async operations)

---

### AC9: Paste and Format Works Without Crash

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 5.3-E2E-011 | E2E | P0 | Paste JSON via Ctrl+V then click Format | Input + format interaction |
| 5.3-E2E-012 | E2E | P1 | Paste while format operation in progress | Queue behavior validation |

**Risk Mitigation:** TECH-003 (skipNextValidation removal timing)

---

### AC10: Application Works on Slow Devices (CPU Throttling)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 5.3-E2E-013 | E2E | P1 | History selection with 6x CPU throttling | Slow device simulation |
| 5.3-E2E-014 | E2E | P1 | Format-Copy-Format with 6x CPU throttling | Slow device stress test |
| 5.3-E2E-015 | E2E | P2 | Rapid operations with 6x CPU throttling | Extreme slow device |

**Risk Mitigation:** TECH-006 (Cross-browser timing differences)

---

### AC11-12: Regression Testing (Story 4.2 History, Story 4.1 Auto-format)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 5.3-INT-006 | Integration | P1 | History entries persist across page reloads | Core history functionality |
| 5.3-INT-007 | Integration | P1 | History panel displays correct entry count | History UI regression |
| 5.3-E2E-016 | E2E | P2 | Auto-format triggers on valid JSON paste (if enabled) | Auto-format regression |

**Risk Mitigation:** TECH-004 (Edge case gaps in AsyncSerialiser coverage)

---

### AC13: Format, Minify, Validate Operations Work Correctly

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 5.3-INT-008 | Integration | P1 | All 7 async operations use AsyncSerialiser | Pre-condition verification |
| 5.3-E2E-017 | E2E | P2 | Complete format/minify/validate cycle | Core operation regression |

---

### AC14: No JavaScript Console Errors During Normal Operation

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 5.3-E2E-018 | E2E | P0 | 10-minute stress session with no Asyncify errors | Long-running stability |
| 5.3-E2E-019 | E2E | P3 | Console error monitoring during all tests | Error detection |

---

### AC15-16: Documentation (Update Report and Create ADR)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 5.3-E2E-020 | E2E | P3 | Verify ADR document created and linked | Documentation completeness |

---

## Risk Coverage Matrix

| Risk ID | Description | Test Coverage |
|---------|-------------|---------------|
| TECH-001 | Premature workaround removal causing crash | 5.3-E2E-005 through 012, 5.3-E2E-018 |
| TECH-002 | History selection flow race condition | 5.3-E2E-001, 002, 003 |
| TECH-003 | skipNextValidation removal timing | 5.3-E2E-011, 012 |
| TECH-004 | Edge case gaps in AsyncSerialiser | 5.3-INT-008, 5.3-E2E-016, 017 |
| TECH-005 | validationTimer.stop() removal side effects | 5.3-INT-004, 5.3-E2E-001 |
| TECH-006 | Cross-browser timing differences | 5.3-E2E-013, 014, 015 |
| TECH-007 | Desktop build regression | Out of scope (WASM-only) |
| OPS-001 | Documentation staleness | 5.3-INT-005, 5.3-E2E-020 |

---

## Test Environment Requirements

### Browser Requirements

| Browser | Version | Required |
|---------|---------|----------|
| Chrome | 120+ | Yes (Primary) |
| Firefox | 115+ | Yes (Secondary) |
| Safari | 17+ | Yes (Tertiary) |

### DevTools Configuration

- **CPU Throttling**: 6x slowdown for AC10 tests
- **Network**: Offline mode (disconnect after initial WASM load)
- **Console**: Open for error monitoring

### Test Data

| Data Type | Description | Size |
|-----------|-------------|------|
| Small JSON | Valid JSON object | <1KB |
| Medium JSON | Valid JSON array | 10-50KB |
| Large JSON | Valid JSON document | >100KB |
| Invalid JSON | Malformed JSON | Any |
| Empty Input | Empty string | 0B |

### Pre-Conditions

Before starting Story 5.3 testing:

1. [ ] Story 5.2 ALL acceptance criteria PASS
2. [ ] All 7 async operations confirmed using AsyncSerialiser
3. [ ] Asyncify stress tests pass in 5.2 test environment

---

## Recommended Execution Order

### Phase 1: Pre-condition Verification (P0)
1. 5.3-INT-008 - Verify AsyncSerialiser coverage
2. Run Story 5.2 Asyncify stress tests

### Phase 2: Critical Path (P0) - Fail Fast
3. 5.3-E2E-001 - Single history entry selection
4. 5.3-E2E-005 - Rapid format clicks
5. 5.3-E2E-006 - Format-Copy-Format sequence
6. 5.3-E2E-009 - Copy after format
7. 5.3-E2E-011 - Paste and format
8. 5.3-E2E-018 - 10-minute stress session

### Phase 3: High Priority (P1)
9. 5.3-E2E-002 through 004 - History edge cases
10. 5.3-E2E-007, 008, 010, 012 - Operation mixing
11. 5.3-E2E-013, 014 - CPU throttling
12. 5.3-INT-001 through 007 - Code/regression verification

### Phase 4: Medium Priority (P2+)
13. 5.3-E2E-015, 016, 017 - Additional coverage
14. 5.3-INT-005, 5.3-E2E-020 - Documentation

---

## Gate YAML Block

```yaml
test_design:
  story: "5.3"
  date: "2026-01-26"
  designer: "Quinn"
  scenarios_total: 24
  by_level:
    unit: 0
    integration: 8
    e2e: 16
  by_priority:
    p0: 8
    p1: 10
    p2: 4
    p3: 2
  coverage_gaps: []
  risks_covered:
    - TECH-001
    - TECH-002
    - TECH-003
    - TECH-004
    - TECH-005
    - TECH-006
    - OPS-001
  pre_conditions:
    - "Story 5.2 ALL acceptance criteria PASS"
    - "All 7 async operations confirmed using AsyncSerialiser"
    - "Asyncify stress tests pass in 5.2 environment"
```

---

## Trace References

```text
Test design matrix: docs/qa/assessments/5.3-test-design-20260126.md
P0 tests identified: 8
Risks mitigated: 7 of 8 (TECH-007 out of scope - desktop only)
```

---

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (E2E-heavy due to removal nature)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk (crash prevention = P0)
- [x] Test IDs follow naming convention
- [x] Scenarios are atomic and independent
- [x] Risk profile mitigations addressed
- [x] Pre-conditions clearly stated
