# Test Design: Story 10.8 - Markdown + Mermaid Integration Testing

**Date:** 2026-01-28
**Designer:** Quinn (Test Architect)
**Mode:** YOLO (Non-interactive)

## Test Strategy Overview

- **Total test scenarios:** 58
- **Unit tests:** 8 (14%)
- **Integration tests:** 26 (45%)
- **E2E tests:** 24 (41%)
- **Priority distribution:** P0: 18, P1: 24, P2: 12, P3: 4

### Rationale

This is an **integration testing story** by definition - it validates the complete Epic 10 workflow. Therefore:
- E2E tests dominate for critical user journeys and cross-browser validation
- Integration tests cover component interactions (Rust↔QML↔Mermaid.js)
- Unit tests limited to pure logic (format detection algorithms, performance measurement helpers)

## Test Scenarios by Acceptance Criteria

---

### AC1: All GFM Markdown Features Render Correctly

**Coverage:** 14 scenarios testing all GFM elements

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 10.8-INT-001 | Integration | P0 | Headings h1-h6 render with correct hierarchy | Core Markdown structure - Rust→QML pipeline | - |
| 10.8-INT-002 | Integration | P1 | Paragraphs and line breaks (soft/hard) | Text flow correctness | - |
| 10.8-INT-003 | Integration | P0 | Bold, italic, strikethrough inline formatting | Core formatting - high visibility | - |
| 10.8-INT-004 | Integration | P1 | Unordered lists (-, *) with nesting | Common use case | - |
| 10.8-INT-005 | Integration | P1 | Ordered lists (1., 2.) with nesting | Common use case | - |
| 10.8-INT-006 | Integration | P1 | Task lists (checkboxes) render correctly | GFM extension | - |
| 10.8-INT-007 | Integration | P1 | Tables with left/center/right alignment | Complex GFM feature | - |
| 10.8-INT-008 | Integration | P0 | Fenced code blocks with language class | Core feature - syntax highlighting dependency | - |
| 10.8-INT-009 | Integration | P2 | Indented code blocks | Legacy format | - |
| 10.8-INT-010 | Integration | P1 | Blockquotes (nested) | Common use case | - |
| 10.8-INT-011 | Integration | P2 | Horizontal rules (---, ***, ___) | Low priority feature | - |
| 10.8-INT-012 | Integration | P1 | Links [text](url) render correctly | Core feature | - |
| 10.8-INT-013 | Integration | P1 | Images ![alt](src) render correctly | Core feature | - |
| 10.8-INT-014 | Integration | P2 | Autolinks render correctly | GFM extension | - |

---

### AC2: All Mermaid Diagram Types Render Correctly

**Coverage:** 9 scenarios testing all diagram types

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 10.8-E2E-001 | E2E | P0 | Flowchart (graph TD) renders | Most common diagram type | TECH-002 |
| 10.8-E2E-002 | E2E | P0 | Flowchart (flowchart LR) renders | Alternative syntax | TECH-002 |
| 10.8-E2E-003 | E2E | P0 | Sequence diagram renders | High-usage diagram type | TECH-002 |
| 10.8-E2E-004 | E2E | P1 | Class diagram renders | UML standard | TECH-002 |
| 10.8-E2E-005 | E2E | P1 | State diagram (stateDiagram-v2) renders | UML standard | TECH-002 |
| 10.8-E2E-006 | E2E | P1 | ER diagram renders | Database documentation | TECH-002 |
| 10.8-E2E-007 | E2E | P2 | Gantt chart renders | Project planning | TECH-003 |
| 10.8-E2E-008 | E2E | P2 | Pie chart renders | Data visualization | TECH-003 |
| 10.8-E2E-009 | E2E | P2 | Mindmap renders | Newer diagram type | TECH-003 |

---

### AC3: Invalid Mermaid Syntax Shows Helpful Error Message

**Coverage:** 5 scenarios testing error handling + security

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 10.8-INT-015 | Integration | P0 | Invalid Mermaid syntax shows error message | Core error handling | - |
| 10.8-INT-016 | Integration | P0 | Partial Mermaid (missing closing ```) handled | Edge case | - |
| 10.8-INT-017 | Integration | P1 | Empty Mermaid block handled gracefully | Edge case | - |
| 10.8-INT-018 | Integration | P0 | Error message does not leak sensitive data | Security requirement | SEC-001 |
| 10.8-INT-019 | Integration | P0 | Other content still renders when one diagram fails | Isolation requirement | - |

**Security Tests (from NFR Assessment recommendations):**

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 10.8-INT-020 | Integration | P0 | XSS payload in Markdown: `<script>alert('xss')</script>` blocked | Security critical | SEC-001 |
| 10.8-INT-021 | Integration | P0 | XSS payload in image: `![x](x onerror=alert(1))` blocked | Security critical | SEC-001 |
| 10.8-INT-022 | Integration | P0 | XSS in Mermaid: flowchart with script injection blocked | Security critical | SEC-001 |
| 10.8-INT-023 | Integration | P0 | SVG sanitization removes event handlers | Security critical | SEC-001 |
| 10.8-INT-024 | Integration | P1 | CSP blocks inline scripts in rendered output | Defense in depth | SEC-001 |

---

### AC4: Format Auto-Detection Correctly Identifies Markdown

**Coverage:** 7 scenarios testing detection algorithm

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 10.8-UNIT-001 | Unit | P0 | `# Heading` detected as markdown | Core detection | - |
| 10.8-UNIT-002 | Unit | P0 | Fenced code blocks detected as markdown | Core detection | - |
| 10.8-UNIT-003 | Unit | P1 | `---` frontmatter detected as markdown | YAML frontmatter pattern | - |
| 10.8-UNIT-004 | Unit | P1 | Lists (- or 1.) detected as markdown | Common pattern | - |
| 10.8-UNIT-005 | Unit | P1 | Plain text returns unknown (not markdown) | Avoid false positives | - |
| 10.8-UNIT-006 | Unit | P0 | JSON content returns json (not markdown) | Prevent regression | BUS-001 |
| 10.8-UNIT-007 | Unit | P0 | XML content returns xml (not markdown) | Prevent regression | BUS-001 |

---

### AC5: Theme Toggle Updates Both Syntax Highlighting and Preview

**Coverage:** 7 scenarios testing theme integration

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 10.8-E2E-010 | E2E | P1 | Dark mode syntax highlighting applies | Visual correctness | - |
| 10.8-E2E-011 | E2E | P1 | Light mode syntax highlighting applies | Visual correctness | - |
| 10.8-E2E-012 | E2E | P1 | Dark mode preview pane styling | Visual correctness | - |
| 10.8-E2E-013 | E2E | P1 | Light mode preview pane styling | Visual correctness | - |
| 10.8-E2E-014 | E2E | P1 | Dark mode Mermaid diagrams use dark theme | Theme consistency | - |
| 10.8-E2E-015 | E2E | P1 | Light mode Mermaid diagrams use light theme | Theme consistency | - |
| 10.8-E2E-016 | E2E | P0 | Theme toggle updates ALL views simultaneously | Core UX requirement | - |

---

### AC6: Performance Meets Requirements

**Coverage:** 6 scenarios testing performance benchmarks

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 10.8-UNIT-008 | Unit | P0 | Performance measurement helper accuracy | Test infrastructure | PERF-001 |
| 10.8-E2E-017 | E2E | P0 | Markdown render < 100ms for 500KB document | NFR target | PERF-001 |
| 10.8-E2E-018 | E2E | P0 | Mermaid render < 500ms per diagram (simple) | NFR target | PERF-001 |
| 10.8-E2E-019 | E2E | P1 | Mermaid render < 500ms per diagram (complex) | NFR target | PERF-001 |
| 10.8-E2E-020 | E2E | P0 | Total render < 2s for document with 5 diagrams | NFR target | PERF-001 |
| 10.8-E2E-021 | E2E | P2 | 1MB document renders without crash | Stress test | - |

---

### AC7: Works in All Target Browsers

**Coverage:** 5 scenarios per browser × 4 browsers = 20 cross-browser tests (consolidated)

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 10.8-E2E-022 | E2E | P0 | Chrome 90+: WASM loads, Mermaid renders | Primary browser | TECH-002 |
| 10.8-E2E-023 | E2E | P0 | Firefox 88+: WASM loads, Mermaid renders | Secondary browser | TECH-002 |
| 10.8-E2E-024 | E2E | P1 | Safari 14+: WASM loads, Mermaid renders | macOS browser | OPS-001 |
| 10.8-E2E-025 | E2E | P1 | Edge 90+: WASM loads, Mermaid renders | Windows browser | TECH-002 |
| 10.8-E2E-026 | E2E | P0 | Offline mode: Markdown renders without network | NFR2 requirement | - |
| 10.8-E2E-027 | E2E | P0 | Offline mode: Mermaid renders without network | NFR2 requirement | - |

---

### AC8: No Regression in Existing JSON/XML Functionality

**Coverage:** 8 scenarios testing regression

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 10.8-E2E-028 | E2E | P0 | JSON formatting still works | Critical regression | BUS-001 |
| 10.8-E2E-029 | E2E | P0 | JSON minify still works | Critical regression | BUS-001 |
| 10.8-E2E-030 | E2E | P0 | JSON validation still works | Critical regression | BUS-001 |
| 10.8-E2E-031 | E2E | P1 | JSON tree view still works | Feature regression | BUS-001 |
| 10.8-E2E-032 | E2E | P0 | XML formatting still works | Critical regression | BUS-001 |
| 10.8-E2E-033 | E2E | P1 | XML tree view still works | Feature regression | BUS-001 |
| 10.8-E2E-034 | E2E | P0 | Format auto-detection for JSON | Core functionality | BUS-001 |
| 10.8-E2E-035 | E2E | P0 | Format auto-detection for XML | Core functionality | BUS-001 |

---

### AC9: Copy Functionality Works for Rendered HTML

**Coverage:** 2 scenarios

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 10.8-E2E-036 | E2E | P1 | Copy button copies rendered HTML to clipboard | Core feature | - |
| 10.8-E2E-037 | E2E | P2 | Copied HTML is valid and complete | Quality check | - |

---

### AC10: History Save/Load Works for Markdown Documents

**Coverage:** 4 scenarios

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 10.8-E2E-038 | E2E | P1 | History save works for Markdown documents | Core feature | - |
| 10.8-E2E-039 | E2E | P1 | History load restores Markdown documents | Core feature | - |
| 10.8-E2E-040 | E2E | P2 | History deduplication works for Markdown | Quality feature | - |
| 10.8-E2E-041 | E2E | P3 | View toggle (Code ↔ Preview) persists state | Nice-to-have | - |

---

## Risk Coverage Matrix

| Risk ID | Risk Description | Test IDs Mitigating |
|---------|------------------|---------------------|
| TECH-001 | Predecessor stories incomplete | *Prerequisite check - not a test* |
| TECH-002 | Cross-browser rendering inconsistencies | 10.8-E2E-001 to 009, 022-025 |
| TECH-003 | Newer Mermaid diagram types less stable | 10.8-E2E-007 to 009 |
| PERF-001 | Benchmark flakiness | 10.8-UNIT-008, 10.8-E2E-017 to 020 |
| SEC-001 | XSS via Mermaid/Markdown injection | 10.8-INT-018, 020-024 |
| DATA-001 | Test artifacts not created | *Prerequisite - Task 1* |
| BUS-001 | JSON/XML regression | 10.8-UNIT-006/007, 10.8-E2E-028 to 035 |
| OPS-001 | Safari requires macOS | 10.8-E2E-024 |

---

## Recommended Execution Order

### Phase 1: Prerequisites (Before Testing Begins)
1. Verify stories 10.1-10.7 are complete (TECH-001 gate)
2. Create test artifacts in `test-data/` directory (DATA-001)

### Phase 2: P0 Critical Path (Fail Fast)
1. P0 Unit tests: 10.8-UNIT-001, 002, 006, 007, 008
2. P0 Security tests: 10.8-INT-018, 020-023
3. P0 Core rendering: 10.8-INT-001, 003, 008, 015, 016, 019
4. P0 Mermaid diagrams: 10.8-E2E-001, 002, 003
5. P0 Performance: 10.8-E2E-017, 018, 020
6. P0 Cross-browser: 10.8-E2E-022, 023, 026, 027
7. P0 Regression: 10.8-E2E-028, 029, 030, 032, 034, 035
8. P0 Theme: 10.8-E2E-016

### Phase 3: P1 Core Coverage
- Execute all P1 tests in order by AC

### Phase 4: P2/P3 Extended Coverage
- Execute P2 tests if time permits
- P3 tests in full regression cycle only

---

## Test Data Requirements

### Required Test Documents

| File | Purpose | Size |
|------|---------|------|
| `test-data/markdown-comprehensive.md` | GFM feature coverage | ~5KB |
| `test-data/mermaid-all-types.md` | All 9 Mermaid diagram types | ~3KB |
| `test-data/markdown-edge-cases.md` | Edge cases, unicode, malformed | ~2KB |
| `test-data/markdown-xss-payloads.md` | Security test vectors | ~1KB |
| `test-data/large-document-500kb.md` | Performance testing | 500KB |
| `test-data/regression-json.json` | JSON regression suite | ~1KB |
| `test-data/regression-xml.xml` | XML regression suite | ~1KB |

### Environment Requirements

| Requirement | Details |
|-------------|---------|
| Browsers | Chrome 90+, Firefox 88+, Safari 14+, Edge 90+ |
| Network | Must test with network disabled (offline mode) |
| Performance | Baseline hardware specs must be documented |
| Benchmark | Run 3x minimum, use median value |

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 58
  by_level:
    unit: 8
    integration: 26
    e2e: 24
  by_priority:
    p0: 18
    p1: 24
    p2: 12
    p3: 4
  coverage_gaps:
    - 'Test artifacts (test-data/*.md) must be created before testing'
    - 'Safari testing requires macOS environment'
  risk_coverage:
    - TECH-002: 14 tests
    - TECH-003: 3 tests
    - PERF-001: 5 tests
    - SEC-001: 6 tests
    - BUS-001: 10 tests
```

---

## Quality Checklist

- [x] Every AC has at least one test
- [x] Test levels are appropriate (not over-testing)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention
- [x] Scenarios are atomic and independent
- [x] Security tests added per NFR assessment
- [x] Risk mitigations mapped to tests
- [x] Offline mode tests included
- [x] Regression suite comprehensive

---

**Test design matrix:** docs/qa/assessments/10.8-test-design-20260128.md
**P0 tests identified:** 18
**Total scenarios:** 58
