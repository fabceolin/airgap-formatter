# Asyncify Fix Validation Test Plan

**Story:** 5.3 - Remove Timer Workarounds and Validate Fix
**Version:** 1.0
**Created:** 2026-01-26
**Purpose:** Validate that the AsyncSerialiser queue properly handles async operations after removing QML Timer workarounds

## Environment Requirements

### Browsers
- Chrome 120+ (primary)
- Firefox 115+
- Safari 17+

### DevTools Setup
- CPU Throttling: 6x slowdown (for slow device simulation tests)
- Network: Offline after WASM load
- Console: Open for error monitoring

### Test Data
| Type | Description | Size |
|------|-------------|------|
| Small JSON | Simple object `{"key": "value"}` | <1KB |
| Medium JSON | Nested object with arrays | 10-50KB |
| Large JSON | Complex nested structure | >100KB |
| Invalid JSON | Missing brackets/quotes | Any |

## Test Scenarios

### 1. History Selection Tests (AC: 6)

#### 1.1 Single History Entry Selection
**Priority:** P0 - Critical
**Steps:**
1. Format valid JSON to create history entry
2. Open History panel (Ctrl+O)
3. Click on a history entry
4. Observe behavior

**Expected Result:**
- Content loads into input pane
- Output pane shows formatted JSON
- Status bar shows valid state
- No console errors
- No crash

#### 1.2 History Selection During Drawer Close
**Priority:** P0 - Critical
**Steps:**
1. Open History panel
2. Click entry near edge of drawer
3. Drawer starts closing while selection processes

**Expected Result:**
- Queue handles race condition
- Content eventually loads correctly
- No Asyncify conflict error

#### 1.3 Rapid History Entry Selection (5 entries)
**Priority:** P0 - Critical
**Steps:**
1. Create 5+ history entries by formatting different JSON
2. Open History panel
3. Rapidly click 5 different entries in quick succession

**Expected Result:**
- All loads queue
- Last clicked entry displays
- No crash
- Console shows queued operations completing in order

### 2. Multiple Rapid Format Operations (AC: 7)

#### 2.1 Rapid Format Button Clicks
**Priority:** P0 - Critical
**Steps:**
1. Paste valid JSON in input
2. Click Format button 5 times rapidly (>5 clicks/sec)

**Expected Result:**
- Operations queue
- Final result shows formatted JSON
- No Asyncify conflict error
- Status bar shows valid

#### 2.2 Format-Minify-Format Sequence
**Priority:** P1 - High
**Steps:**
1. Paste valid JSON
2. Click Format
3. Immediately click Minify
4. Immediately click Format

**Expected Result:**
- All operations complete in sequence
- Final output is formatted JSON
- No errors

### 3. Copy After Format (AC: 8)

#### 3.1 Format Then Copy
**Priority:** P0 - Critical
**Steps:**
1. Paste valid JSON
2. Click Format
3. Click Copy immediately after format completes

**Expected Result:**
- Format completes
- Copy succeeds
- "Copied!" feedback appears
- Clipboard contains formatted JSON

#### 3.2 Copy During Format (Race Condition)
**Priority:** P1 - High
**Steps:**
1. Paste large JSON (>100KB)
2. Click Format
3. Click Copy while formatting is still in progress

**Expected Result:**
- Copy queues behind format
- Both operations complete
- Final clipboard has formatted result

### 4. Paste and Format (AC: 9)

#### 4.1 Paste with Auto-Format
**Priority:** P0 - Critical
**Steps:**
1. Copy valid JSON to clipboard
2. Clear input pane
3. Press Ctrl+V

**Expected Result:**
- JSON pastes to input
- Auto-format triggers
- Output shows formatted result
- No Asyncify error

#### 4.2 Paste While Format in Progress
**Priority:** P1 - High
**Steps:**
1. Paste large JSON
2. Click Format
3. While formatting, paste new JSON (Ctrl+V)

**Expected Result:**
- New paste queues
- Format completes
- New JSON processes after

### 5. Slow Device Simulation (AC: 10)

#### 5.1 History Selection with CPU Throttling
**Priority:** P1 - High
**Setup:** Enable 6x CPU throttling in DevTools
**Steps:**
1. Open History panel
2. Click a history entry
3. Observe timing

**Expected Result:**
- Slower but functional
- Operation completes eventually
- No crash or timeout
- No Asyncify error

#### 5.2 Rapid Operations with CPU Throttling
**Priority:** P1 - High
**Setup:** Enable 6x CPU throttling
**Steps:**
1. Paste medium JSON
2. Click Format 3 times rapidly
3. Click Copy

**Expected Result:**
- All operations queue and complete
- Takes longer but works
- No errors

### 6. Regression Tests (AC: 11-13)

#### 6.1 History Feature Regression (Story 4.2)
**Priority:** P1 - High
**Steps:**
1. Format JSON - verify it saves to history
2. Open history - verify entries appear
3. Search history - verify filter works
4. Delete entry - verify removal
5. Clear all - verify prompt and clearing

**Expected Result:**
All history features work as before

#### 6.2 Auto-Format Regression (Story 4.1 if applicable)
**Priority:** P1 - High
**Steps:**
1. Paste JSON when input is empty - should auto-format
2. Paste JSON when text is selected - should auto-format
3. Paste JSON when cursor in middle of text - should just paste

**Expected Result:**
Auto-format behavior unchanged

#### 6.3 Core Operations Regression
**Priority:** P0 - Critical
**Steps:**
1. Format - valid JSON formats correctly
2. Minify - JSON minifies to single line
3. Validate - valid JSON shows green, invalid shows error
4. Copy - copies to clipboard
5. Clear - clears both panes

**Expected Result:**
All core operations work correctly

### 7. Validation Debounce Tests (AC: 6-14)

#### 7.1 Rapid Typing Validation
**Priority:** P2 - Medium
**Steps:**
1. Type rapidly in input pane (faster than 300ms debounce)
2. Type: `{"ke`
3. Continue: `y":"value"}`

**Expected Result:**
- Validations debounce (don't fire on every keystroke)
- Final validation shows valid state
- No Asyncify error during rapid typing

#### 7.2 Paste Followed by Typing
**Priority:** P2 - Medium
**Steps:**
1. Paste valid JSON
2. Immediately start typing to modify

**Expected Result:**
- Auto-format completes
- Typing triggers new validation
- No conflicts

### 8. Stress Test (AC: 6-14)

#### 8.1 10-Minute Stress Session
**Priority:** P1 - High
**Steps:**
1. Open console to monitor errors
2. For 10 minutes, perform random operations:
   - Format, minify, copy, paste
   - Open/close history
   - Select history entries
   - Type in input
   - Use keyboard shortcuts
3. Check console for errors

**Expected Result:**
- Zero Asyncify conflict errors
- Zero memory access errors
- Zero deleted val errors
- Application remains responsive

### 9. Console Error Monitoring (AC: 14)

#### 9.1 Normal Operation - No Errors
**Priority:** P0 - Critical
**Steps:**
1. Open browser console
2. Perform standard workflow:
   - Paste JSON
   - Format
   - Copy
   - Clear
   - Load from history
3. Check console

**Expected Result:**
- No JavaScript errors
- No "Cannot have multiple async operations" errors
- No "memory access out of bounds" errors
- No "Cannot use deleted val" errors

## Pass Criteria

All tests must pass with:
- [ ] No "Cannot have multiple async operations in flight at once" error
- [ ] No "memory access out of bounds" error
- [ ] No "Cannot use deleted val" error
- [ ] All operations complete with correct results
- [ ] Application remains responsive throughout testing

## Cross-Browser Verification

| Test Category | Chrome | Firefox | Safari |
|---------------|--------|---------|--------|
| History Selection | | | |
| Rapid Format | | | |
| Copy After Format | | | |
| Paste and Format | | | |
| Slow Device (throttled) | | | |
| 10-Min Stress Test | | | |

## Test Execution Checklist

- [ ] Pre-condition: Story 5.2 ALL acceptance criteria PASS
- [ ] Pre-condition: All 7 async operations confirmed using AsyncSerialiser
- [ ] Phase 1: P0 Critical Path tests
- [ ] Phase 2: P1 Edge cases and slow device tests
- [ ] Phase 3: P2 Secondary coverage
- [ ] Phase 4: Cross-browser verification
- [ ] Final: All pass criteria met
